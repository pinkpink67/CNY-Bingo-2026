<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MX BINGO</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .hidden {
            display: none !important;
        }

        /* Login Screen */
        .screen {
            max-width: 800px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .login-screen {
            text-align: center;
        }

        h1 {
            color: #764ba2;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .welcome-text {
            margin-bottom: 30px;
            font-size: 1.2em;
            color: #666;
        }

        input, button {
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #ddd;
            font-size: 16px;
            width: 100%;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .player-id {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: monospace;
            word-break: break-all;
        }

        /* Player Screen */
        .player-screen {
            display: flex;
            flex-direction: column;
            min-height: 80vh;
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .player-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #gamePlayerName {
            font-size: 1.5em;
            font-weight: bold;
            color: #764ba2;
        }

        .game-status {
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
        }

        .game-status.waiting {
            background: #ffd700;
            color: #333;
        }

        .game-status.playing {
            background: #4CAF50;
            color: white;
        }

        .game-status.ended {
            background: #f44336;
            color: white;
        }

        .card-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card-title {
            text-align: center;
            font-size: 1.3em;
            color: #667eea;
            font-weight: bold;
        }

        .bingo-card {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin: 0 auto;
            max-width: 500px;
        }

        .card-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .card-cell:hover {
            background: #f0f4ff;
        }

        .card-cell.free {
            background: #667eea;
            color: white;
        }

        .card-cell.marked {
            background: #4CAF50;
            color: white;
            transform: scale(0.95);
        }

        .card-cell.called {
            background: #ffd700;
            color: #333;
        }

        .card-cell.winning {
            background: #f44336;
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .card-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .nav-btn {
            width: 150px;
            background: #667eea;
        }

        /* Called Numbers */
        .called-numbers-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        #calledNumbers {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .called-number {
            padding: 8px 12px;
            background: #667eea;
            color: white;
            border-radius: 5px;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }

        /* Admin Screen */
        .admin-screen {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .admin-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .admin-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .admin-btn {
            flex: 1;
            min-width: 150px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .setting-group label {
            font-weight: bold;
            color: #667eea;
        }

        .color-picker {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-input {
            width: 60px !important;
            padding: 5px;
        }

        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid #ddd;
        }

        .players-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .player-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
        }

        .btn-red {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }

        .btn-green {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
        }

        /* Winners List */
        #winnersList {
            list-style: none;
            padding: 10px;
        }

        #winnersList li {
            padding: 10px;
            margin: 5px 0;
            background: #f0f4ff;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }

        /* Notifications */
        .notifications-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 300px;
        }

        .notification {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .notification.success {
            background-color: #4CAF50;
        }

        .notification.info {
            background-color: #2196F3;
        }

        .notification.warning {
            background-color: #ff9800;
        }

        .notification.error {
            background-color: #f44336;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .screen {
                margin: 20px;
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }

            .player-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .bingo-card {
                grid-template-columns: repeat(5, 1fr);
                gap: 3px;
            }

            .card-cell {
                font-size: 1em;
            }

            .admin-controls {
                flex-direction: column;
            }

            .nav-btn {
                width: 100%;
            }
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- Notifications Container -->
    <div id="notifications" class="notifications-container"></div>

    <!-- Login Screen -->
    <div id="loginScreen" class="screen login-screen">
        <h1 id="headerTitle">MX BINGO</h1>
        <p id="welcomeText" class="welcome-text">Welcome to MX BINGO! Enter your name to join the game.</p>
        
        <input type="text" id="playerNameInput" placeholder="Enter your name" maxlength="20">
        
        <button id="joinGameBtn" onclick="joinGame()">Join Game</button>
        
        <div id="playerIdDisplay" class="player-id hidden">
            <strong>Your Player ID:</strong>
            <div id="playerId"></div>
            <small>Save this ID to reconnect later</small>
        </div>
        
        <div class="admin-login">
            <h3>Admin Login</h3>
            <input type="password" id="adminPassword" placeholder="Admin Password">
            <button id="adminLoginBtn" onclick="adminLogin()">Login as Admin</button>
        </div>
    </div>

    <!-- Player Screen -->
    <div id="playerScreen" class="screen player-screen hidden">
        <div class="player-header">
            <div class="player-info">
                <div id="gamePlayerName">Player Name</div>
                <div class="player-id">ID: <span id="currentPlayerId"></span></div>
            </div>
            <div id="gameStatus" class="game-status waiting hidden">Waiting for game to start</div>
            <button onclick="logout()" class="btn-red">Logout</button>
        </div>

        <div class="card-container">
            <div id="cardTitle" class="card-title">BINGO Card 1/1</div>
            
            <div id="bingoCard" class="bingo-card">
                <!-- Bingo card cells will be generated here -->
            </div>

            <div class="card-controls">
                <button id="prevCardBtn" onclick="prevCard()" class="nav-btn">Previous Card</button>
                <button id="nextCardBtn" onclick="nextCard()" class="nav-btn">Next Card</button>
            </div>
        </div>

        <div class="called-numbers-container">
            <h3>Called Numbers</h3>
            <div id="calledNumbers" class="called-numbers">
                <!-- Called numbers will appear here -->
            </div>
        </div>

        <div class="winners-container hidden">
            <h3>Winners</h3>
            <ul id="winnersList">
                <!-- Winners will appear here -->
            </ul>
        </div>
    </div>

    <!-- Admin Screen -->
    <div id="adminScreen" class="screen admin-screen hidden">
        <div class="admin-header">
            <h1>Admin Panel</h1>
            <button onclick="logout()" class="btn-red">Logout</button>
        </div>

        <!-- Game Controls -->
        <div class="admin-section">
            <h2>Game Controls</h2>
            <div class="admin-controls">
                <button id="startGameBtn" onclick="startGame()" class="admin-btn btn-green">Start Game</button>
                <button id="endGameBtn" onclick="endGame()" class="admin-btn btn-red" disabled>End Game</button>
                <button id="callNumberBtn" onclick="callNumber()" class="admin-btn" disabled>Call Next Number</button>
                <button id="resetGameBtn" onclick="resetGame()" class="admin-btn">Reset Game</button>
            </div>
            
            <div class="current-number">
                <h3>Current Number: <span id="currentNumberDisplay">-</span></h3>
                <div id="adminCalledNumbers" class="called-numbers">
                    <!-- Called numbers for admin -->
                </div>
            </div>
        </div>

        <!-- Game Settings -->
        <div class="admin-section">
            <h2>Game Settings</h2>
            <div class="settings-grid">
                <div class="setting-group">
                    <label>Header Text:</label>
                    <input type="text" id="headerTextInput" placeholder="MX BINGO">
                </div>
                
                <div class="setting-group">
                    <label>Welcome Text:</label>
                    <input type="text" id="welcomeTextInput" placeholder="Welcome to MX BINGO!">
                </div>
                
                <div class="setting-group">
                    <label>Card Title Format:</label>
                    <input type="text" id="cardTitleTextInput" placeholder="Card {current}/{total}">
                </div>
                
                <div class="setting-group">
                    <label>Player Name Color:</label>
                    <div class="color-picker">
                        <input type="number" id="playerNameColorR" min="0" max="255" value="118" class="color-input">
                        <input type="number" id="playerNameColorG" min="0" max="255" value="75" class="color-input">
                        <input type="number" id="playerNameColorB" min="0" max="255" value="162" class="color-input">
                        <div id="playerNameColorPreview" class="color-preview" style="background: rgb(118, 75, 162)"></div>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label>Player Name Size (px):</label>
                    <input type="number" id="playerNameSizeInput" min="12" max="48" value="24">
                </div>
                
                <div class="setting-group">
                    <label>Cell Background Color:</label>
                    <div class="color-picker">
                        <input type="number" id="cellColorR" min="0" max="255" value="255" class="color-input">
                        <input type="number" id="cellColorG" min="0" max="255" value="255" class="color-input">
                        <input type="number" id="cellColorB" min="0" max="255" value="255" class="color-input">
                        <div id="cellColorPreview" class="color-preview" style="background: rgb(255, 255, 255)"></div>
                    </div>
                </div>
            </div>
            
            <button onclick="saveSettings()" class="btn-green" style="margin-top: 20px;">Save Settings</button>
        </div>

        <!-- Player Management -->
        <div class="admin-section">
            <h2>Player Management</h2>
            <div class="player-count">
                Connected Players: <span id="playerCount">0</span>
            </div>
            <div class="players-list" id="playersList">
                <!-- Player list will appear here -->
            </div>
            <button onclick="generateCardsForAll()" class="btn-green" style="margin-top: 20px;">Generate Cards for All</button>
        </div>

        <!-- Winners List -->
        <div class="admin-section">
            <h2>Winners</h2>
            <ul id="adminWinnersList">
                <!-- Winners will appear here -->
            </ul>
        </div>

        <!-- Announcements -->
        <div class="admin-section">
            <h2>Send Announcement</h2>
            <input type="text" id="announcementInput" placeholder="Type announcement here..." style="margin-bottom: 10px;">
            <button onclick="sendAnnouncement()" class="btn-green">Send Announcement</button>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const playerScreen = document.getElementById('playerScreen');
        const adminScreen = document.getElementById('adminScreen');
        const headerTitle = document.getElementById('headerTitle');
        const welcomeText = document.getElementById('welcomeText');
        const playerNameInput = document.getElementById('playerNameInput');
        const gamePlayerName = document.getElementById('gamePlayerName');
        const currentPlayerId = document.getElementById('currentPlayerId');
        const gameStatus = document.getElementById('gameStatus');
        const bingoCard = document.getElementById('bingoCard');
        const cardTitle = document.getElementById('cardTitle');
        const calledNumbers = document.getElementById('calledNumbers');
        const winnersList = document.getElementById('winnersList');

        // Game State
        let currentPlayerIdValue = '';
        let isAdmin = false;
        let gameSettings = {
            headerText: "MX BINGO",
            welcomeText: "Welcome to MX BINGO!",
            cardTitleText: "Card {current}/{total}",
            playerNameColorR: 118,
            playerNameColorG: 75,
            playerNameColorB: 162,
            playerNameSize: 24,
            cellColorR: 255,
            cellColorG: 255,
            cellColorB: 255
        };
        
        let playerCards = [];
        let currentCardIndex = 0;
        let isGameStarted = false;
        let currentNumber = 0;
        let calledNumbersList = [];
        let winners = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved player ID from localStorage
            const savedPlayerId = localStorage.getItem('bingoPlayerId');
            if (savedPlayerId) {
                currentPlayerIdValue = savedPlayerId;
                checkPlayerExists(savedPlayerId);
            }
            
            initializeEventListeners();
            loadSettings();
            startRealTimeListeners();
        });

        function initializeEventListeners() {
            // Color preview updates
            document.getElementById('playerNameColorR')?.addEventListener('input', updateColorPreview);
            document.getElementById('playerNameColorG')?.addEventListener('input', updateColorPreview);
            document.getElementById('playerNameColorB')?.addEventListener('input', updateColorPreview);
            document.getElementById('cellColorR')?.addEventListener('input', updateCellColorPreview);
            document.getElementById('cellColorG')?.addEventListener('input', updateCellColorPreview);
            document.getElementById('cellColorB')?.addEventListener('input', updateCellColorPreview);
        }

        function startRealTimeListeners() {
            // Settings listener
            database.ref('settings').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const loadedSettings = snapshot.val();
                    gameSettings = { ...gameSettings, ...loadedSettings };
                    console.log('Settings updated:', loadedSettings);
                    
                    updateUIFromSettings();
                    
                    if (isAdmin) {
                        updateAdminSettingsUI();
                    }
                }
            });

            // Game state listener
            database.ref('gameState').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const gameState = snapshot.val();
                    console.log('Game state updated:', gameState);
                    
                    isGameStarted = gameState.isGameStarted || false;
                    currentNumber = gameState.currentNumber || 0;
                    calledNumbersList = gameState.calledNumbers || [];
                    
                    updateGameStatusDisplay();
                    updateCalledNumbersDisplay();
                    
                    if (playerCards.length > 0) {
                        updateAllPlayerCards();
                    }
                    
                    if (isAdmin) {
                        updateAdminGameControls();
                    }
                }
            });

            // Called numbers listener
            database.ref('calledNumbers').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    calledNumbersList = snapshot.val();
                    console.log('Called numbers updated:', calledNumbersList);
                    
                    updateCalledNumbersDisplay();
                    updateAllPlayerCards();
                    
                    if (isAdmin) {
                        updateAdminCalledNumbers();
                    }
                }
            });

            // Player cards listener
            database.ref('playerCards').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const allPlayerCards = snapshot.val();
                    
                    if (currentPlayerIdValue && allPlayerCards[currentPlayerIdValue]) {
                        playerCards = allPlayerCards[currentPlayerIdValue];
                        console.log('Player cards loaded:', playerCards.length);
                        
                        if (playerCards.length > 0) {
                            displayCurrentCard();
                            updateCardTitle();
                        }
                    }
                }
            });

            // Winners listener
            database.ref('winners').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    winners = snapshot.val();
                    console.log('Winners updated:', winners);
                    
                    updateWinnersDisplay();
                    
                    if (currentPlayerIdValue && winners.some(w => w.playerId === currentPlayerIdValue)) {
                        showNotification('Congratulations! You won!', 'success');
                    }
                }
            });

            // Announcements listener
            database.ref('announcements').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const announcements = snapshot.val();
                    if (announcements && announcements.length > 0) {
                        const latest = announcements[announcements.length - 1];
                        showNotification(latest.text, 'info');
                    }
                }
            });
        }

        function updateUIFromSettings() {
            headerTitle.textContent = gameSettings.headerText;
            welcomeText.textContent = gameSettings.welcomeText;
            
            if (gamePlayerName) {
                const color = `rgb(${gameSettings.playerNameColorR}, ${gameSettings.playerNameColorG}, ${gameSettings.playerNameColorB})`;
                gamePlayerName.style.color = color;
                gamePlayerName.style.fontSize = `${gameSettings.playerNameSize}px`;
            }
            
            applyCellStyling();
        }

        function updateAdminSettingsUI() {
            document.getElementById('headerTextInput').value = gameSettings.headerText;
            document.getElementById('welcomeTextInput').value = gameSettings.welcomeText;
            document.getElementById('cardTitleTextInput').value = gameSettings.cardTitleText;
            document.getElementById('playerNameColorR').value = gameSettings.playerNameColorR;
            document.getElementById('playerNameColorG').value = gameSettings.playerNameColorG;
            document.getElementById('playerNameColorB').value = gameSettings.playerNameColorB;
            document.getElementById('playerNameSizeInput').value = gameSettings.playerNameSize;
            document.getElementById('cellColorR').value = gameSettings.cellColorR;
            document.getElementById('cellColorG').value = gameSettings.cellColorG;
            document.getElementById('cellColorB').value = gameSettings.cellColorB;
            
            updateColorPreview();
            updateCellColorPreview();
        }

        function updateColorPreview() {
            const r = document.getElementById('playerNameColorR').value;
            const g = document.getElementById('playerNameColorG').value;
            const b = document.getElementById('playerNameColorB').value;
            const preview = document.getElementById('playerNameColorPreview');
            if (preview) {
                preview.style.background = `rgb(${r}, ${g}, ${b})`;
            }
        }

        function updateCellColorPreview() {
            const r = document.getElementById('cellColorR').value;
            const g = document.getElementById('cellColorG').value;
            const b = document.getElementById('cellColorB').value;
            const preview = document.getElementById('cellColorPreview');
            if (preview) {
                preview.style.background = `rgb(${r}, ${g}, ${b})`;
            }
        }

        function applyCellStyling() {
            const cells = document.querySelectorAll('.card-cell');
            const color = `rgb(${gameSettings.cellColorR}, ${gameSettings.cellColorG}, ${gameSettings.cellColorB})`;
            cells.forEach(cell => {
                if (!cell.classList.contains('marked') && !cell.classList.contains('free')) {
                    cell.style.background = color;
                }
            });
        }

        // Game Functions
        function joinGame() {
            const playerName = playerNameInput.value.trim();
            if (!playerName) {
                alert('Please enter your name');
                return;
            }

            if (!currentPlayerIdValue) {
                currentPlayerIdValue = generatePlayerId();
                localStorage.setItem('bingoPlayerId', currentPlayerIdValue);
            }

            const playerData = {
                name: playerName,
                joinedAt: Date.now(),
                isOnline: true
            };

            database.ref(`players/${currentPlayerIdValue}`).set(playerData);
            
            gamePlayerName.textContent = playerName;
            currentPlayerId.textContent = currentPlayerIdValue;
            
            loginScreen.classList.add('hidden');
            playerScreen.classList.remove('hidden');
            
            showNotification('Successfully joined the game!', 'success');
            
            // Check for existing cards
            database.ref(`playerCards/${currentPlayerIdValue}`).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    playerCards = snapshot.val();
                    if (playerCards.length > 0) {
                        displayCurrentCard();
                        updateCardTitle();
                    }
                }
            });
        }

        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            // In production, use proper authentication
            if (password === "admin123") {
                isAdmin = true;
                loginScreen.classList.add('hidden');
                adminScreen.classList.remove('hidden');
                showNotification('Admin login successful', 'success');
                loadAdminData();
            } else {
                alert('Invalid admin password');
            }
        }

        function logout() {
            if (currentPlayerIdValue) {
                database.ref(`players/${currentPlayerIdValue}/isOnline`).set(false);
            }
            
            isAdmin = false;
            playerCards = [];
            currentCardIndex = 0;
            
            playerScreen.classList.add('hidden');
            adminScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            
            showNotification('Logged out successfully', 'info');
        }

        function generatePlayerId() {
            return 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function checkPlayerExists(playerId) {
            database.ref(`players/${playerId}`).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const player = snapshot.val();
                    if (player.isOnline) {
                        playerNameInput.value = player.name;
                        joinGame();
                    }
                }
            });
        }

        function displayCurrentCard() {
            if (playerCards.length === 0) return;
            
            const card = playerCards[currentCardIndex];
            bingoCard.innerHTML = '';
            
            // BINGO header
            for (let i = 0; i < 5; i++) {
                const headerCell = document.createElement('div');
                headerCell.className = 'card-cell free';
                headerCell.textContent = 'BINGO'[i];
                bingoCard.appendChild(headerCell);
            }
            
            // Card numbers
            for (let i = 0; i < 25; i++) {
                if (i === 12) { // Free space
                    const freeCell = document.createElement('div');
                    freeCell.className = 'card-cell free';
                    freeCell.textContent = 'FREE';
                    freeCell.onclick = () => toggleCell(i);
                    bingoCard.appendChild(freeCell);
                } else {
                    const cell = document.createElement('div');
                    cell.className = 'card-cell';
                    cell.textContent = card[i] || '';
                    cell.onclick = () => toggleCell(i);
                    
                    if (calledNumbersList.includes(card[i])) {
                        cell.classList.add('called');
                    }
                    
                    if (card.marked && card.marked.includes(i)) {
                        cell.classList.add('marked');
                    }
                    
                    bingoCard.appendChild(cell);
                }
            }
            
            applyCellStyling();
        }

        function toggleCell(index) {
            if (index === 12) return; // Free space can't be toggled
            
            const cell = bingoCard.children[index];
            cell.classList.toggle('marked');
            
            // Update marked cells in Firebase
            const card = playerCards[currentCardIndex];
            if (!card.marked) card.marked = [];
            
            const markedIndex = card.marked.indexOf(index);
            if (markedIndex === -1) {
                card.marked.push(index);
            } else {
                card.marked.splice(markedIndex, 1);
            }
            
            database.ref(`playerCards/${currentPlayerIdValue}/${currentCardIndex}`).update(card);
            
            // Check for win
            checkForWin();
        }

        function checkForWin() {
            // Win pattern checking logic
            // This is a simplified version - implement your actual win logic
            const card = playerCards[currentCardIndex];
            if (!card || !card.marked) return;
            
            const markedCount = card.marked.length;
            if (markedCount >= 5) {
                // Check patterns
                const patterns = [
                    [0,1,2,3,4], // Top row
                    [5,6,7,8,9], // Second row
                    // Add more patterns as needed
                ];
                
                for (const pattern of patterns) {
                    if (pattern.every(index => card.marked.includes(index) || index === 12)) {
                        declareWin("Pattern matched!");
                        return;
                    }
                }
            }
        }

        function declareWin(pattern) {
            if (!currentPlayerIdValue) return;
            
            const winner = {
                playerId: currentPlayerIdValue,
                playerName: gamePlayerName.textContent,
                pattern: pattern,
                cardIndex: currentCardIndex,
                timestamp: Date.now()
            };
            
            database.ref('winners').transaction(winners => {
                if (!winners) return [winner];
                return [...winners, winner];
            });
            
            showNotification('BINGO! You won!', 'success');
        }

        function prevCard() {
            if (playerCards.length === 0) return;
            currentCardIndex = (currentCardIndex - 1 + playerCards.length) % playerCards.length;
            displayCurrentCard();
            updateCardTitle();
        }

        function nextCard() {
            if (playerCards.length === 0) return;
            currentCardIndex = (currentCardIndex + 1) % playerCards.length;
            displayCurrentCard();
            updateCardTitle();
        }

        function updateCardTitle() {
            const text = gameSettings.cardTitleText
                .replace('{current}', currentCardIndex + 1)
                .replace('{total}', playerCards.length);
            cardTitle.textContent = text;
        }

        function updateGameStatusDisplay() {
            gameStatus.textContent = isGameStarted ? 'Game in Progress' : 'Waiting for game to start';
            gameStatus.className = `game-status ${isGameStarted ? 'playing' : 'waiting'}`;
            gameStatus.classList.remove('hidden');
        }

        function updateCalledNumbersDisplay() {
            calledNumbers.innerHTML = calledNumbersList
                .map(num => `<span class="called-number">${num}</span>`)
                .join('');
        }

        function updateAllPlayerCards() {
            if (playerCards.length > 0) {
                displayCurrentCard();
            }
        }

        function updateWinnersDisplay() {
            winnersList.innerHTML = winners
                .map(w => `<li>${w.playerName} - ${w.pattern}</li>`)
                .join('');
        }

        // Admin Functions
        function loadAdminData() {
            updatePlayerCount();
            renderPlayerList();
            loadSettings();
        }

        function updatePlayerCount() {
            database.ref('players').once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const players = snapshot.val();
                    const count = Object.values(players).filter(p => p.isOnline).length;
                    document.getElementById('playerCount').textContent = count;
                }
            });
        }

        function renderPlayerList() {
            database.ref('players').once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const players = snapshot.val();
                    const container = document.getElementById('playersList');
                    container.innerHTML = '';
                    
                    Object.entries(players).forEach(([id, player]) => {
                        const div = document.createElement('div');
                        div.className = 'player-item';
                        div.innerHTML = `
                            <div>
                                <strong>${player.name}</strong><br>
                                <small>${id}</small>
                            </div>
                            <div class="player-actions">
                                <button class="btn-small" onclick="generateCardsForPlayer('${id}')">Give Cards</button>
                                <button class="btn-small btn-red" onclick="removePlayer('${id}')">Remove</button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
            });
        }

        function saveSettings() {
            const settings = {
                headerText: document.getElementById('headerTextInput').value,
                welcomeText: document.getElementById('welcomeTextInput').value,
                cardTitleText: document.getElementById('cardTitleTextInput').value,
                playerNameColorR: parseInt(document.getElementById('playerNameColorR').value),
                playerNameColorG: parseInt(document.getElementById('playerNameColorG').value),
                playerNameColorB: parseInt(document.getElementById('playerNameColorB').value),
                playerNameSize: parseInt(document.getElementById('playerNameSizeInput').value),
                cellColorR: parseInt(document.getElementById('cellColorR').value),
                cellColorG: parseInt(document.getElementById('cellColorG').value),
                cellColorB: parseInt(document.getElementById('cellColorB').value)
            };
            
            database.ref('settings').set(settings)
                .then(() => showNotification('Settings saved!', 'success'))
                .catch(error => showNotification('Error saving settings: ' + error, 'error'));
        }

        function loadSettings() {
            database.ref('settings').once('value', (snapshot) => {
                if (snapshot.exists()) {
                    gameSettings = snapshot.val();
                    if (isAdmin) {
                        updateAdminSettingsUI();
                    }
                    updateUIFromSettings();
                }
            });
        }

        function startGame() {
            const gameState = {
                isGameStarted: true,
                startedAt: Date.now(),
                calledNumbers: [],
                currentNumber: 0
            };
            
            database.ref('gameState').set(gameState)
                .then(() => showNotification('Game started!', 'success'))
                .catch(error => showNotification('Error starting game: ' + error, 'error'));
        }

        function endGame() {
            const gameState = {
                isGameStarted: false,
                endedAt: Date.now()
            };
            
            database.ref('gameState').update(gameState)
                .then(() => showNotification('Game ended!', 'success'))
                .catch(error => showNotification('Error ending game: ' + error, 'error'));
        }

        function callNumber() {
            if (!isGameStarted) return;
            
            let newNumber;
            do {
                newNumber = Math.floor(Math.random() * 75) + 1;
            } while (calledNumbersList.includes(newNumber));
            
            const updatedNumbers = [...calledNumbersList, newNumber];
            
            database.ref('gameState').update({
                currentNumber: newNumber,
                calledNumbers: updatedNumbers
            })
            .then(() => showNotification(`Number called: ${newNumber}`, 'info'))
            .catch(error => showNotification('Error calling number: ' + error, 'error'));
        }

        function resetGame() {
            if (confirm('Are you sure you want to reset the game? This will clear all called numbers and winners.')) {
                const gameState = {
                    isGameStarted: false,
                    currentNumber: 0,
                    calledNumbers: [],
                    lastReset: Date.now()
                };
                
                database.ref('gameState').set(gameState);
                database.ref('winners').set([]);
                database.ref('calledNumbers').set([]);
                
                showNotification('Game reset successfully!', 'success');
            }
        }

        function generateCardsForPlayer(playerId) {
            // Generate 4 random bingo cards
            const cards = [];
            for (let i = 0; i < 4; i++) {
                cards.push(generateBingoCard());
            }
            
            database.ref(`playerCards/${playerId}`).set(cards)
                .then(() => showNotification('Cards generated for player!', 'success'))
                .catch(error => showNotification('Error generating cards: ' + error, 'error'));
        }

        function generateCardsForAll() {
            database.ref('players').once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const players = snapshot.val();
                    Object.keys(players).forEach(playerId => {
                        generateCardsForPlayer(playerId);
                    });
                }
            });
        }

        function removePlayer(playerId) {
            if (confirm('Are you sure you want to remove this player?')) {
                database.ref(`players/${playerId}`).remove()
                    .then(() => {
                        database.ref(`playerCards/${playerId}`).remove();
                        showNotification('Player removed!', 'success');
                        renderPlayerList();
                        updatePlayerCount();
                    })
                    .catch(error => showNotification('Error removing player: ' + error, 'error'));
            }
        }

        function sendAnnouncement() {
            const input = document.getElementById('announcementInput');
            const text = input.value.trim();
            if (!text) return;
            
            const announcement = {
                text: text,
                timestamp: Date.now(),
                sender: isAdmin ? 'Admin' : gamePlayerName.textContent
            };
            
            database.ref('announcements').transaction(announcements => {
                if (!announcements) return [announcement];
                return [...announcements, announcement];
            })
            .then(() => {
                input.value = '';
                showNotification('Announcement sent!', 'success');
            })
            .catch(error => showNotification('Error sending announcement: ' + error, 'error'));
        }

        function generateBingoCard() {
            const card = [];
            const ranges = [
                {min: 1, max: 15},   // B
                {min: 16, max: 30},  // I
                {min: 31, max: 45},  // N
                {min: 46, max: 60},  // G
                {min: 61, max: 75}   // O
            ];
            
            for (let col = 0; col < 5; col++) {
                const numbers = new Set();
                for (let row = 0; row < 5; row++) {
                    if (col === 2 && row === 2) continue; // Free space
                    
                    let num;
                    do {
                        num = Math.floor(Math.random() * (ranges[col].max - ranges[col].min + 1)) + ranges[col].min;
                    } while (numbers.has(num));
                    numbers.add(num);
                    card.push(num);
                }
            }
            
            return card;
        }

        function updateAdminGameControls() {
            const startBtn = document.getElementById('startGameBtn');
            const endBtn = document.getElementById('endGameBtn');
            const callBtn = document.getElementById('callNumberBtn');
            
            if (startBtn) startBtn.disabled = isGameStarted;
            if (endBtn) endBtn.disabled = !isGameStarted;
            if (callBtn) callBtn.disabled = !isGameStarted;
            
            const currentNumberDisplay = document.getElementById('currentNumberDisplay');
            if (currentNumberDisplay) {
                currentNumberDisplay.textContent = currentNumber || '-';
            }
        }

        function updateAdminCalledNumbers() {
            const container = document.getElementById('adminCalledNumbers');
            if (container) {
                container.innerHTML = calledNumbersList
                    .map(num => `<span class="called-number">${num}</span>`)
                    .join('');
            }
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            if (!container) return;
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode === container) {
                    container.removeChild(notification);
                }
            }, 5000);
        }

        // Utility function for color conversion
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
    </script>
</body>
</html>
