<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MX BINGO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --accent: #f72585;
            --success: #4cc9f0;
            --danger: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border-radius: 12px;
            --shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Poppins', sans-serif;
            color: var(--light);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        /* Container */
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Game Header - Player Screen */
        .game-header {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .game-header-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }

        .game-header-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 1.5rem;
            background: linear-gradient(90deg, #FF6B35, #FFD166);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 1px;
        }

        .game-player-name {
            font-size: 35px; /* Default 35px as requested */
            font-weight: 600;
            color: white;
            text-transform: capitalize;
            line-height: 1.2;
        }

        .game-lucky-number {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: white;
            padding: 12px 16px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 1.3rem;
            min-width: 90px;
            text-align: center;
            letter-spacing: 2px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Admin Header */
        .admin-header {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-header h1 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 1.8rem;
            background: linear-gradient(90deg, #FF6B35, #FFD166);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 1px;
        }

        /* Login Screen */
        .login-screen {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 30px 25px;
            margin-top: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .login-screen h2 {
            text-align: center;
            margin-bottom: 25px;
            font-weight: 700;
            font-size: 1.8rem;
            color: white;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
        }

        .input-group input {
            width: 100%;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 1rem;
            transition: var(--transition);
        }

        .input-group input:focus {
            outline: none;
            border-color: #FF6B35;
            background: rgba(0, 0, 0, 0.3);
        }

        /* Buttons */
        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            text-decoration: none;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF6B35, #FF9E6D);
            color: white;
            box-shadow: 0 6px 0 rgba(255, 107, 53, 0.3);
        }

        .btn-primary:hover, .btn-primary:active {
            background: linear-gradient(135deg, #E55A2E, #FF8B5A);
            transform: translateY(-2px);
            box-shadow: 0 8px 0 rgba(255, 107, 53, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover, .btn-secondary:active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .btn-info {
            background: linear-gradient(135deg, #118AB2, #06D6A0);
            color: white;
            box-shadow: 0 6px 0 rgba(6, 214, 160, 0.3);
        }

        .btn-info:hover, .btn-info:active {
            background: linear-gradient(135deg, #0F7A9C, #05C18F);
            transform: translateY(-2px);
            box-shadow: 0 8px 0 rgba(6, 214, 160, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #EF476F, #FF9E6D);
            color: white;
            box-shadow: 0 6px 0 rgba(239, 71, 111, 0.3);
        }

        .btn-danger:hover, .btn-danger:active {
            background: linear-gradient(135deg, #D43F63, #FF8B5A);
            transform: translateY(-2px);
            box-shadow: 0 8px 0 rgba(239, 71, 111, 0.3);
        }

        .btn-small {
            padding: 10px 15px;
            font-size: 0.9rem;
            width: auto;
        }

        /* Card Container */
        .card-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .bingo-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            /* Border removed as requested */
        }

        .card-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .card-header h3 {
            font-weight: 700;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 5px;
        }

        .card-header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        /* Bingo Grid */
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 0 auto;
        }

        .cell {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
            user-select: none;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .cell:hover, .cell:active {
            background: rgba(255, 255, 255, 0.12);
            transform: scale(1.03);
        }

        .cell.marked {
            background: linear-gradient(135deg, #06D6A0, #118AB2);
            color: white;
            box-shadow: 0 6px 0 rgba(6, 214, 160, 0.3);
        }

        .cell.free {
            background: transparent;
            border: none;
            padding: 0;
        }

        .free-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        /* Card Navigation */
        .card-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .card-nav button {
            flex: 1;
        }

        .card-indicator {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        /* Custom Confirmation Modal */
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .confirmation-dialog {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 30px;
            width: 100%;
            max-width: 350px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .confirmation-icon {
            font-size: 3rem;
            color: #EF476F;
            margin-bottom: 20px;
        }

        .confirmation-message {
            color: white;
            font-size: 1.2rem;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .confirmation-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirmation-buttons .btn {
            flex: 1;
            margin: 0;
        }

        /* Admin Panel */
        .admin-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-top: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 70vh;
            overflow-y: auto;
        }

        .admin-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-section h3 {
            color: #06D6A0;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-section h3 i {
            font-size: 1.1rem;
        }

        .admin-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
        }

        .control-group input, .control-group select, .control-group textarea {
            width: 100%;
            padding: 12px 15px;
            border-radius: var(--border-radius);
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 0.95rem;
            transition: var(--transition);
            font-family: 'Poppins', sans-serif;
        }

        .control-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .control-group input:focus, .control-group select:focus, .control-group textarea:focus {
            outline: none;
            border-color: #FF6B35;
        }

        .color-picker {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .rgb-inputs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 5px;
        }

        .rgb-inputs input {
            text-align: center;
            padding: 8px;
        }

        /* Player List Management */
        .player-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .player-count {
            background: rgba(255, 107, 53, 0.2);
            color: #FF6B35;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .player-list-editor {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
        }

        .player-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .player-list-item:last-child {
            margin-bottom: 0;
        }

        .player-list-item input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            padding: 8px;
            font-size: 0.95rem;
            text-transform: capitalize;
        }

        .player-list-item input:focus {
            outline: none;
        }

        .player-list-controls {
            display: flex;
            gap: 10px;
        }

        .player-list-controls button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-list-controls button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .player-list-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        /* Registered Players Table */
        .registered-players-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .registered-players-table th {
            background: rgba(255, 107, 53, 0.3);
            color: #FF6B35;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .registered-players-table td {
            padding: 12px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }

        .registered-players-table tr:last-child td {
            border-bottom: none;
        }

        .registered-players-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .player-number {
            color: rgba(255, 255, 255, 0.6);
            font-weight: 600;
            width: 30px;
        }

        .player-name-cell {
            font-weight: 600;
            text-transform: capitalize;
        }

        .player-lucky-number {
            font-weight: 700;
            color: #06D6A0;
            text-align: center;
            letter-spacing: 2px;
        }

        .player-date {
            color: rgba(255, 255, 255, 0.8);
            white-space: nowrap;
        }

        .player-time {
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
        }

        .no-players-message {
            text-align: center;
            padding: 30px;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }

        /* Export Options */
        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        /* Import Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 25px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #06D6A0;
            font-weight: 600;
            font-size: 1.3rem;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-textarea {
            width: 100%;
            padding: 15px;
            border-radius: var(--border-radius);
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            resize: vertical;
            min-height: 120px;
        }

        .modal-textarea:focus {
            outline: none;
            border-color: #FF6B35;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .duplicate-warning {
            background: rgba(239, 71, 111, 0.2);
            border: 1px solid rgba(239, 71, 111, 0.3);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            color: #EF476F;
            font-size: 0.9rem;
        }

        .duplicate-warning ul {
            margin-top: 8px;
            padding-left: 20px;
        }

        .duplicate-warning li {
            margin-bottom: 4px;
        }

        /* File Upload */
        .file-upload {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .file-upload-preview {
            width: 100%;
            height: 150px;
            border-radius: var(--border-radius);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
        }

        .file-upload-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .file-upload-placeholder {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            padding: 20px;
        }

        .file-upload-placeholder i {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .file-upload-controls {
            display: flex;
            gap: 10px;
        }

        .file-upload-controls input[type="file"] {
            display: none;
        }

        .file-upload-controls label {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .file-upload-controls label:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .current-image-info {
            margin-top: 10px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .tab.active {
            background: #FF6B35;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 15px 25px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 15px;
            max-width: 90%;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            border-left: 5px solid #06D6A0;
        }

        .notification.error {
            border-left: 5px solid #EF476F;
        }

        @keyframes slideIn {
            from { top: -100px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }

        /* Game Status */
        .game-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-active {
            background: rgba(6, 214, 160, 0.2);
            color: #06D6A0;
        }

        .status-inactive {
            background: rgba(108, 117, 125, 0.2);
            color: var(--gray);
        }

        /* Responsive Adjustments */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .admin-header h1, .game-header-title {
                font-size: 1.5rem;
            }
            
            .game-player-name {
                font-size: 28px; /* Slightly smaller on mobile */
            }
            
            .game-lucky-number {
                padding: 10px 14px;
                font-size: 1.1rem;
                min-width: 80px;
            }
            
            .cell {
                font-size: 1rem;
            }
            
            .admin-controls {
                grid-template-columns: 1fr;
            }
            
            .card-nav {
                gap: 8px;
            }
            
            .card-nav button {
                padding: 10px 8px;
                font-size: 0.85rem;
            }
            
            .registered-players-table {
                display: block;
                overflow-x: auto;
            }
            
            .registered-players-table th,
            .registered-players-table td {
                padding: 8px 6px;
                font-size: 0.8rem;
            }
            
            .confirmation-dialog {
                padding: 20px;
            }
            
            .confirmation-message {
                font-size: 1.1rem;
            }
        }

        /* Hide elements */
        .hidden {
            display: none !important;
        }

        /* Loading Spinner */
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: #FF6B35;
            animation: spin 1s ease-in-out infinite;
            margin: 30px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Admin Header -->
        <div class="admin-header hidden" id="adminHeader">
            <h1 id="headerTitle">MX BINGO</h1>
        </div>

        <!-- Game Header - Player Screen -->
        <div class="game-header hidden" id="gameHeader">
            <div class="game-header-center">
                <div class="game-player-name" id="gamePlayerName">Player Name</div>
            </div>
            <div class="game-lucky-number" id="gameLuckyNumber">1234</div>
        </div>

        <!-- Tabs for Admin -->
        <div class="tabs hidden" id="adminTabs">
            <div class="tab active" data-tab="settings">Settings</div>
            <div class="tab" data-tab="players">Players</div>
            <div class="tab" data-tab="preview">Preview</div>
        </div>

        <!-- Game Status Indicator -->
        <div class="game-status hidden" id="gameStatus">
            <div class="status-indicator status-inactive" id="statusIndicator">
                <i class="fas fa-circle"></i>
                <span>Game Not Active</span>
            </div>
        </div>

        <!-- Login Screen -->
        <div class="login-screen" id="loginScreen">
            <h2 id="welcomeText">Welcome to MX BINGO!</h2>
            <div class="input-group">
                <label for="playerName">Player Name</label>
                <input type="text" id="playerName" placeholder="Enter your name">
            </div>
            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter password">
            </div>
            <button class="btn btn-primary" id="loginBtn">Login</button>
        </div>

        <!-- Player Game Screen -->
        <div class="card-container hidden" id="playerScreen">
            <div class="bingo-card">
                <div class="card-header">
                    <h3 id="cardTitle">BINGO CARD 1/3</h3>
                </div>
                
                <div class="bingo-grid" id="bingoGrid">
                    <!-- Cells will be generated by JavaScript -->
                </div>
            </div>
            
            <div class="card-nav">
                <button class="btn btn-secondary btn-small" id="prevCardBtn">
                    <i class="fas fa-chevron-left"></i> Back
                </button>
                <button class="btn btn-danger btn-small" id="clearCardBtn">
                    <i class="fas fa-eraser"></i> Clear Card
                </button>
                <button class="btn btn-secondary btn-small" id="nextCardBtn">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Admin Panel -->
        <div class="admin-panel hidden" id="adminPanel">
            <!-- Settings Tab -->
            <div class="tab-content active" id="settingsTab">
                <div class="admin-section">
                    <h3><i class="fas fa-users"></i> Game Settings</h3>
                    <div class="admin-controls">
                        <div class="control-group">
                            <label for="maxPlayers">Max Players (1-100)</label>
                            <input type="number" id="maxPlayers" min="1" max="100" value="50">
                        </div>
                        <div class="control-group">
                            <label for="cardsPerPlayer">Cards Per Player (1-10)</label>
                            <input type="number" id="cardsPerPlayer" min="1" max="10" value="3">
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="gameActive">Game Status</label>
                        <select id="gameActive">
                            <option value="false">Not Active / Join Closed</option>
                            <option value="true">Active / Join Open</option>
                        </select>
                    </div>
                </div>
                
                <div class="admin-section">
                    <h3><i class="fas fa-user-shield"></i> Admin Credentials</h3>
                    <div class="admin-controls">
                        <div class="control-group">
                            <label for="adminId">Admin ID</label>
                            <input type="text" id="adminId" value="admin">
                        </div>
                        <div class="control-group">
                            <label for="adminPassword">Admin Password</label>
                            <input type="password" id="adminPassword" value="1234">
                        </div>
                    </div>
                </div>
                
                <div class="admin-section">
                    <h3><i class="fas fa-palette"></i> Text Customization</h3>
                    <div class="control-group">
                        <label for="headerText">Header Title</label>
                        <input type="text" id="headerText" value="MX BINGO">
                    </div>
                    <div class="control-group">
                        <label for="welcomeTextInput">Welcome Text</label>
                        <input type="text" id="welcomeTextInput" value="Welcome to MX BINGO!">
                    </div>
                    <div class="control-group">
                        <label for="cardTitleText">Card Title Format</label>
                        <input type="text" id="cardTitleText" value="GAME CARD {current}/{total}">
                        <small style="color: rgba(255, 255, 255, 0.6); font-size: 0.85rem;">
                            Use {current} for current card number and {total} for total cards
                        </small>
                    </div>
                    <div class="control-group">
                        <label for="generalPassword">General Password (for all players)</label>
                        <input type="text" id="generalPassword" value="bingo123">
                    </div>
                </div>
                
                <div class="admin-section">
                    <h3><i class="fas fa-palette"></i> Player Name Design</h3>
                    <div class="control-group">
                        <label>Player Name Color (RGB)</label>
                        <div class="rgb-inputs">
                            <input type="number" id="playerNameColorR" min="0" max="255" value="255" placeholder="R">
                            <input type="number" id="playerNameColorG" min="0" max="255" value="255" placeholder="G">
                            <input type="number" id="playerNameColorB" min="0" max="255" value="255" placeholder="B">
                        </div>
                    </div>
                    <div class="control-group">
                        <label for="playerNameSize">Player Name Font Size (px)</label>
                        <input type="number" id="playerNameSize" min="10" max="50" value="35">
                    </div>
                </div>
                
                <div class="admin-section">
                    <h3><i class="fas fa-palette"></i> Cell Design Settings</h3>
                    <div class="admin-controls">
                        <div class="control-group">
                            <label>Cell Background Color (RGB)</label>
                            <div class="rgb-inputs">
                                <input type="number" id="cellColorR" min="0" max="255" value="67" placeholder="R">
                                <input type="number" id="cellColorG" min="0" max="255" value="97" placeholder="G">
                                <input type="number" id="cellColorB" min="0" max="255" value="238" placeholder="B">
                            </div>
                        </div>
                        <div class="control-group">
                            <label>Cell Number Color (RGB)</label>
                            <div class="rgb-inputs">
                                <input type="number" id="cellNumberColorR" min="0" max="255" value="255" placeholder="R">
                                <input type="number" id="cellNumberColorG" min="0" max="255" value="255" placeholder="G">
                                <input type="number" id="cellNumberColorB" min="0" max="255" value="255" placeholder="B">
                            </div>
                        </div>
                    </div>
                    
                    <div class="admin-controls">
                        <div class="control-group">
                            <label for="cellNumberSize">Cell Number Font Size (px)</label>
                            <input type="number" id="cellNumberSize" min="8" max="30" value="16">
                        </div>
                        <div class="control-group">
                            <label for="cellSpacing">Cell Spacing (px)</label>
                            <input type="number" id="cellSpacing" min="0" max="20" value="8">
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="cellBorder">Cell Border</label>
                        <input type="text" id="cellBorder" placeholder="2px solid #4361ee" value="2px solid #4361ee">
                    </div>
                </div>
                
                <div class="admin-section">
                    <h3><i class="fas fa-image"></i> FREE Cell Image</h3>
                    <div class="file-upload">
                        <div class="file-upload-preview" id="freeCellPreview">
                            <div class="file-upload-placeholder">
                                <i class="fas fa-image"></i>
                                <div>No image selected</div>
                            </div>
                        </div>
                        <div class="file-upload-controls">
                            <input type="file" id="freeCellImage" accept=".png,.jpg,.jpeg,.webp,.gif">
                            <label for="freeCellImage">
                                <i class="fas fa-upload"></i> Upload Image
                            </label>
                            <button class="btn btn-secondary btn-small" id="removeFreeCellImage">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                        <div class="current-image-info" id="freeCellImageInfo">
                            Current: Default "FREE" text
                        </div>
                        <small style="color: rgba(255, 255, 255, 0.6); font-size: 0.85rem;">
                            Upload an image to replace the "FREE" text in the center cell. Recommended: Square image (1:1 aspect ratio)
                        </small>
                    </div>
                </div>
                
                <div class="admin-section">
                    <h3><i class="fas fa-image"></i> Background Image</h3>
                    <div class="file-upload">
                        <div class="file-upload-preview" id="backgroundPreview">
                            <div class="file-upload-placeholder">
                                <i class="fas fa-image"></i>
                                <div>No image selected</div>
                            </div>
                        </div>
                        <div class="file-upload-controls">
                            <input type="file" id="backgroundImage" accept=".png,.jpg,.jpeg,.webp,.gif">
                            <label for="backgroundImage">
                                <i class="fas fa-upload"></i> Upload Image
                            </label>
                            <button class="btn btn-secondary btn-small" id="removeBackgroundImage">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                        <div class="current-image-info" id="backgroundImageInfo">
                            Current: Color gradient background
                        </div>
                        <small style="color: rgba(255, 255, 255, 0.6); font-size: 0.85rem;">
                            Upload a background image for the entire game. Recommended: High-quality image that works well with overlay content.
                        </small>
                    </div>
                </div>
                
                <div class="admin-section">
                    <h3><i class="fas fa-palette"></i> Background Fallback Color</h3>
                    <div class="control-group">
                        <label>Background Color (RGB) - Used if no image</label>
                        <div class="rgb-inputs">
                            <input type="number" id="bgColorR" min="0" max="255" value="26" placeholder="R">
                            <input type="number" id="bgColorG" min="0" max="255" value="26" placeholder="G">
                            <input type="number" id="bgColorB" min="0" max="255" value="46" placeholder="B">
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="saveSettingsBtn">
                    <i class="fas fa-save"></i> Save All Settings
                </button>
                <button class="btn btn-secondary" id="resetPlayersBtn">
                    <i class="fas fa-trash"></i> Reset All Players
                </button>
            </div>
            
            <!-- Players Tab -->
            <div class="tab-content" id="playersTab">
                <div class="admin-section">
                    <div class="player-list-header">
                        <h3><i class="fas fa-list"></i> Player List Management</h3>
                        <div class="player-count" id="playerCount">0 players</div>
                    </div>
                    
                    <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 15px; font-size: 0.9rem;">
                        Add players who are allowed to join. Each player will be automatically assigned a 4-digit lucky number.
                        <br><br>
                        <strong>Format for import:</strong> Names separated by commas. Example: "calvin, cindy, JF,"
                    </p>
                    
                    <div class="player-list-editor" id="playerListEditor">
                        <!-- Player list items will be added here -->
                    </div>
                    
                    <div class="player-list-actions">
                        <button class="btn btn-secondary btn-small" id="addPlayerBtn">
                            <i class="fas fa-plus"></i> Add Player
                        </button>
                        <button class="btn btn-secondary btn-small" id="importPlayersBtn">
                            <i class="fas fa-file-import"></i> Import List
                        </button>
                        <button class="btn btn-info btn-small" id="exportPlayersBtn">
                            <i class="fas fa-file-export"></i> Export List
                        </button>
                    </div>
                </div>
                
                <div class="admin-section">
                    <div class="player-list-header">
                        <h3><i class="fas fa-users"></i> Registered Players</h3>
                        <div class="export-options">
                            <button class="btn btn-secondary btn-small" id="exportNamesBtn">
                                <i class="fas fa-file-export"></i> Names Only
                            </button>
                            <button class="btn btn-info btn-small" id="exportFullBtn">
                                <i class="fas fa-file-excel"></i> Full Details
                            </button>
                        </div>
                    </div>
                    
                    <div id="registeredPlayersTableContainer">
                        <!-- Registered players table will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Preview Tab -->
            <div class="tab-content" id="previewTab">
                <div class="admin-section">
                    <h3><i class="fas fa-eye"></i> Card Preview</h3>
                    <div class="bingo-grid" id="previewGrid">
                        <!-- Preview cells will be generated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <button class="btn btn-secondary" id="adminLogoutBtn">Logout</button>
        </div>

        <!-- Import Modal -->
        <div class="modal-overlay hidden" id="importModal">
            <div class="modal">
                <div class="modal-header">
                    <h3>Import Player List</h3>
                </div>
                <div class="modal-body">
                    <div id="duplicateWarning" class="duplicate-warning hidden"></div>
                    <textarea id="importTextarea" class="modal-textarea" placeholder="Enter names separated by commas (e.g., calvin, cindy, JF, )"></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary btn-small" id="cancelImportBtn">Cancel</button>
                    <button class="btn btn-primary btn-small" id="proceedImportBtn">Proceed (Skip Duplicates)</button>
                    <button class="btn btn-danger btn-small" id="cancelAllImportBtn">Cancel All</button>
                </div>
            </div>
        </div>

        <!-- Custom Confirmation Modal -->
        <div class="confirmation-modal hidden" id="confirmationModal">
            <div class="confirmation-dialog">
                <div class="confirmation-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="confirmation-message" id="confirmationMessage">
                    Clear all marks from this card? This cannot be undone.
                </div>
                <div class="confirmation-buttons">
                    <button class="btn btn-secondary" id="confirmCancelBtn">Cancel</button>
                    <button class="btn btn-danger" id="confirmClearBtn">Clear Card</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification hidden" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Settings saved successfully!</span>
    </div>

    <script>
        // ===========================================
        // FIREBASE CONFIGURATION FOR MX BINGO
        // ===========================================
        const firebaseConfig = {
            apiKey: "AIzaSyB01PdqxQOdevXQNcYJMGzuYmG1u-S77ec",
            authDomain: "mx-bingo.firebaseapp.com",
            databaseURL: "https://mx-bingo-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mx-bingo",
            storageBucket: "mx-bingo.firebasestorage.app",
            messagingSenderId: "480388469034",
            appId: "1:480388469034:web:a6edab28faf37e3e0c4e53"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // App state
        let currentUser = null;
        let isAdmin = false;
        let playerCards = [];
        let currentCardIndex = 0;
        let gameSettings = {
            maxPlayers: 50,
            cardsPerPlayer: 3,
            gameActive: false,
            cellColorR: 67,
            cellColorG: 97,
            cellColorB: 238,
            cellNumberColorR: 255,
            cellNumberColorG: 255,
            cellNumberColorB: 255,
            cellNumberSize: 16,
            cellSpacing: 8,
            cellBorder: "2px solid #4361ee",
            bgColorR: 26,
            bgColorG: 26,
            bgColorB: 46,
            headerText: "MX BINGO",
            welcomeText: "Welcome to MX BINGO!",
            cardTitleText: "GAME CARD {current}/{total}",
            generalPassword: "bingo123",
            adminId: "admin",
            adminPassword: "1234",
            playerNameColorR: 255,
            playerNameColorG: 255,
            playerNameColorB: 255,
            playerNameSize: 35,
            freeCellImageUrl: null,
            backgroundImageUrl: null,
            allowedPlayers: []
        };

        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const playerScreen = document.getElementById('playerScreen');
        const adminPanel = document.getElementById('adminPanel');
        const adminHeader = document.getElementById('adminHeader');
        const gameHeader = document.getElementById('gameHeader');
        const gamePlayerName = document.getElementById('gamePlayerName');
        const gameLuckyNumber = document.getElementById('gameLuckyNumber');
        const bingoGrid = document.getElementById('bingoGrid');
        const previewGrid = document.getElementById('previewGrid');
        const cardTitle = document.getElementById('cardTitle');
        const prevCardBtn = document.getElementById('prevCardBtn');
        const nextCardBtn = document.getElementById('nextCardBtn');
        const clearCardBtn = document.getElementById('clearCardBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const loginBtn = document.getElementById('loginBtn');
        const adminTabs = document.getElementById('adminTabs');
        const gameStatus = document.getElementById('gameStatus');
        const statusIndicator = document.getElementById('statusIndicator');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');
        const headerTitle = document.getElementById('headerTitle');
        const welcomeText = document.getElementById('welcomeText');
        const playerCount = document.getElementById('playerCount');
        const registeredPlayersTableContainer = document.getElementById('registeredPlayersTableContainer');

        // Confirmation modal elements
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');
        const confirmClearBtn = document.getElementById('confirmClearBtn');

        // Admin controls
        const maxPlayersInput = document.getElementById('maxPlayers');
        const cardsPerPlayerInput = document.getElementById('cardsPerPlayer');
        const gameActiveSelect = document.getElementById('gameActive');
        const cellColorRInput = document.getElementById('cellColorR');
        const cellColorGInput = document.getElementById('cellColorG');
        const cellColorBInput = document.getElementById('cellColorB');
        const cellNumberColorRInput = document.getElementById('cellNumberColorR');
        const cellNumberColorGInput = document.getElementById('cellNumberColorG');
        const cellNumberColorBInput = document.getElementById('cellNumberColorB');
        const cellNumberSizeInput = document.getElementById('cellNumberSize');
        const cellSpacingInput = document.getElementById('cellSpacing');
        const cellBorderInput = document.getElementById('cellBorder');
        const bgColorRInput = document.getElementById('bgColorR');
        const bgColorGInput = document.getElementById('bgColorG');
        const bgColorBInput = document.getElementById('bgColorB');
        const headerTextInput = document.getElementById('headerText');
        const welcomeTextInput = document.getElementById('welcomeTextInput');
        const cardTitleTextInput = document.getElementById('cardTitleText');
        const generalPasswordInput = document.getElementById('generalPassword');
        const adminIdInput = document.getElementById('adminId');
        const adminPasswordInput = document.getElementById('adminPassword');
        const playerNameColorRInput = document.getElementById('playerNameColorR');
        const playerNameColorGInput = document.getElementById('playerNameColorG');
        const playerNameColorBInput = document.getElementById('playerNameColorB');
        const playerNameSizeInput = document.getElementById('playerNameSize');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const resetPlayersBtn = document.getElementById('resetPlayersBtn');
        const playerListContainer = document.getElementById('playerListContainer');
        const playerListEditor = document.getElementById('playerListEditor');
        const addPlayerBtn = document.getElementById('addPlayerBtn');
        const importPlayersBtn = document.getElementById('importPlayersBtn');
        const exportPlayersBtn = document.getElementById('exportPlayersBtn');
        const exportNamesBtn = document.getElementById('exportNamesBtn');
        const exportFullBtn = document.getElementById('exportFullBtn');

        // Image upload elements
        const freeCellImageInput = document.getElementById('freeCellImage');
        const freeCellPreview = document.getElementById('freeCellPreview');
        const removeFreeCellImageBtn = document.getElementById('removeFreeCellImage');
        const freeCellImageInfo = document.getElementById('freeCellImageInfo');
        
        const backgroundImageInput = document.getElementById('backgroundImage');
        const backgroundPreview = document.getElementById('backgroundPreview');
        const removeBackgroundImageBtn = document.getElementById('removeBackgroundImage');
        const backgroundImageInfo = document.getElementById('backgroundImageInfo');

        // Import modal elements
        const importModal = document.getElementById('importModal');
        const importTextarea = document.getElementById('importTextarea');
        const duplicateWarning = document.getElementById('duplicateWarning');
        const cancelImportBtn = document.getElementById('cancelImportBtn');
        const proceedImportBtn = document.getElementById('proceedImportBtn');
        const cancelAllImportBtn = document.getElementById('cancelAllImportBtn');

        // Helper functions for RGB
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        // Custom confirmation dialog
        function showConfirmationDialog(message) {
            return new Promise((resolve) => {
                confirmationMessage.textContent = message;
                confirmationModal.classList.remove('hidden');
                
                confirmCancelBtn.onclick = function() {
                    confirmationModal.classList.add('hidden');
                    resolve(false);
                };
                
                confirmClearBtn.onclick = function() {
                    confirmationModal.classList.add('hidden');
                    resolve(true);
                };
            });
        }

        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show corresponding content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId + 'Tab').classList.add('active');
            });
        });

        // Generate a random 4-digit lucky number
        function generateLuckyNumber() {
            let number = '';
            for (let i = 0; i < 4; i++) {
                number += Math.floor(Math.random() * 10);
            }
            return number;
        }

        // Generate a unique BINGO card with no duplicates across all players
        async function generateUniqueBingoCard() {
            let card;
            let isUnique = false;
            let attempts = 0;
            const maxAttempts = 100;
            
            while (!isUnique && attempts < maxAttempts) {
                card = generateBingoCard();
                
                // Check if this card already exists for any player
                const playersRef = database.ref('players');
                const snapshot = await playersRef.once('value');
                
                let cardExists = false;
                if (snapshot.exists()) {
                    snapshot.forEach(player => {
                        const playerData = player.val();
                        if (playerData.cards) {
                            playerData.cards.forEach(playerCard => {
                                if (JSON.stringify(playerCard.numbers) === JSON.stringify(card)) {
                                    cardExists = true;
                                }
                            });
                        }
                    });
                }
                
                if (!cardExists) {
                    isUnique = true;
                }
                
                attempts++;
            }
            
            // If we couldn't find a unique card after max attempts, generate any card
            if (!isUnique) {
                console.warn('Could not generate unique card after', maxAttempts, 'attempts. Using random card.');
                card = generateBingoCard();
            }
            
            return card;
        }

        // Generate a BINGO card with random numbers (standard BINGO rules)
        function generateBingoCard() {
            const card = [];
            
            // B column: 1-15
            const bNumbers = new Set();
            while (bNumbers.size < 5) {
                bNumbers.add(Math.floor(Math.random() * 15) + 1);
            }
            card.push(...Array.from(bNumbers));
            
            // I column: 16-30
            const iNumbers = new Set();
            while (iNumbers.size < 5) {
                iNumbers.add(Math.floor(Math.random() * 15) + 16);
            }
            card.push(...Array.from(iNumbers));
            
            // N column: 31-45 (with FREE in the middle)
            const nNumbers = new Set();
            while (nNumbers.size < 4) {
                nNumbers.add(Math.floor(Math.random() * 15) + 31);
            }
            const nArray = Array.from(nNumbers);
            nArray.splice(2, 0, 'FREE');
            card.push(...nArray);
            
            // G column: 46-60
            const gNumbers = new Set();
            while (gNumbers.size < 5) {
                gNumbers.add(Math.floor(Math.random() * 15) + 46);
            }
            card.push(...Array.from(gNumbers));
            
            // O column: 61-75
            const oNumbers = new Set();
            while (oNumbers.size < 5) {
                oNumbers.add(Math.floor(Math.random() * 15) + 61);
            }
            card.push(...Array.from(oNumbers));
            
            return card;
        }

        // Format date and time
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = date.toLocaleString('en-US', { month: 'short' });
            const year = date.getFullYear();
            
            let hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'pm' : 'am';
            hours = hours % 12;
            hours = hours ? hours : 12; // Convert 0 to 12
            
            return {
                date: `${day} ${month} ${year}`,
                time: `${hours}:${minutes}${ampm}`
            };
        }

        // Parse comma-separated names
        function parseCommaSeparatedNames(text) {
            if (!text || text.trim() === '') return [];
            
            // Split by comma, trim spaces, remove empty entries
            return text.split(',')
                .map(name => name.trim())
                .filter(name => name !== '');
        }

        // Format player name: first character uppercase, rest lowercase
        function formatPlayerName(name) {
            if (!name || name.trim() === '') return '';
            const trimmedName = name.trim();
            return trimmedName.charAt(0).toUpperCase() + trimmedName.slice(1).toLowerCase();
        }

        // Export player names only
        function exportPlayerNamesOnly() {
            if (!gameSettings.allowedPlayers || gameSettings.allowedPlayers.length === 0) {
                showNotification('No players to export', false);
                return;
            }
            
            // Sort alphabetically before export
            const sortedPlayers = [...gameSettings.allowedPlayers].sort((a, b) => 
                a.name.localeCompare(b.name)
            );
            
            // Create CSV with only names
            const names = sortedPlayers.map(player => player.name);
            const csvContent = names.join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `mx-bingo-names-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`Exported ${names.length} player names`);
        }

        // Export full player details
        function exportFullPlayerDetails() {
            const playersRef = database.ref('players');
            playersRef.once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    showNotification('No registered players to export', false);
                    return;
                }
                
                const players = [];
                snapshot.forEach(child => {
                    const player = child.val();
                    players.push({
                        name: player.name,
                        luckyNumber: player.luckyNumber,
                        joinedAt: player.joinedAt
                    });
                });
                
                // Sort alphabetically by name
                players.sort((a, b) => a.name.localeCompare(b.name));
                
                // Create CSV with full details
                const headers = ['No.', 'Name', '4D No.', 'Login Date', 'Time'];
                const rows = players.map((player, index) => {
                    const datetime = formatDateTime(player.joinedAt);
                    return [
                        index + 1,
                        player.name,
                        player.luckyNumber,
                        datetime.date,
                        datetime.time
                    ];
                });
                
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.join(','))
                ].join('\n');
                
                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `mx-bingo-registered-players-${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`Exported ${players.length} registered players`);
            });
        }

        // Check for duplicate names
        function findDuplicateNames(names) {
            const formattedNames = names.map(name => formatPlayerName(name).toLowerCase());
            const currentNames = gameSettings.allowedPlayers.map(player => 
                player.name.toLowerCase()
            );
            
            const duplicates = [];
            formattedNames.forEach((name, index) => {
                if (currentNames.includes(name)) {
                    duplicates.push(names[index]);
                }
            });
            
            return duplicates;
        }

        // Render BINGO card grid
        function renderBingoGrid(card, container, isPreview = false) {
            container.innerHTML = '';
            
            // Apply cell spacing from settings
            container.style.gap = `${gameSettings.cellSpacing}px`;
            
            // Add card cells (25 cells total - NO BINGO headers)
            for (let i = 0; i < 25; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.index = i;
                
                if (i === 12) { // Center cell (FREE cell)
                    cell.classList.add('free');
                    
                    // Check if we have a FREE cell image
                    if (gameSettings.freeCellImageUrl) {
                        const img = document.createElement('img');
                        img.className = 'free-image';
                        img.src = gameSettings.freeCellImageUrl;
                        img.alt = 'FREE';
                        img.onerror = function() {
                            // If image fails to load, show "FREE" text
                            console.error('Failed to load FREE cell image');
                            this.remove();
                            cell.textContent = 'FREE';
                        };
                        cell.appendChild(img);
                        cell.textContent = ''; // Remove text
                    } else {
                        cell.textContent = card[i]; // Show "FREE" text
                    }
                } else {
                    cell.textContent = card[i];
                }
                
                // Apply cell number styling
                const cellNumberColor = rgbToHex(gameSettings.cellNumberColorR, gameSettings.cellNumberColorG, gameSettings.cellNumberColorB);
                cell.style.color = cellNumberColor;
                cell.style.fontSize = `${gameSettings.cellNumberSize}px`;
                
                // For player cards, add click event to mark cells
                if (!isPreview && i !== 12) { // Don't add click to FREE cell
                    cell.addEventListener('click', function() {
                        if (!this.classList.contains('free')) {
                            this.classList.toggle('marked');
                            // Save marked state to Firebase
                            saveMarkedState(i, this.classList.contains('marked'));
                        }
                    });
                }
                
                container.appendChild(cell);
            }
            
            // Apply cell styling from settings
            applyCellStyling();
        }

        // Save marked state to Firebase
        function saveMarkedState(cellIndex, isMarked) {
            if (!currentUser || isAdmin) return;
            
            const playerRef = database.ref('players/' + currentUser.id);
            playerRef.child('cards/' + currentCardIndex + '/marked/' + cellIndex).set(isMarked);
        }

        // Load marked state from Firebase
        function loadMarkedState(card, markedData) {
            if (!markedData) return card;
            
            // Apply marked state to cells in the grid
            const cells = document.querySelectorAll('#bingoGrid .cell');
            Object.keys(markedData).forEach(cellIndex => {
                if (markedData[cellIndex] && cells[cellIndex]) {
                    cells[cellIndex].classList.add('marked');
                }
            });
            
            return card;
        }

        // Clear current card marks
        async function clearCurrentCard() {
            if (!currentUser || isAdmin) return;
            
            // Use custom confirmation dialog instead of browser alert
            const confirmed = await showConfirmationDialog('Clear all marks from this card? This cannot be undone.');
            
            if (confirmed) {
                const playerRef = database.ref('players/' + currentUser.id);
                // Clear marked state for current card
                await playerRef.child('cards/' + currentCardIndex + '/marked').remove();
                
                // Clear visual marks
                const cells = document.querySelectorAll('#bingoGrid .cell');
                cells.forEach(cell => {
                    if (!cell.classList.contains('free')) {
                        cell.classList.remove('marked');
                    }
                });
                
                showNotification('Card cleared successfully');
            }
        }

        // Apply cell styling from settings
        function applyCellStyling() {
            const cells = document.querySelectorAll('.cell:not(.cell-header)');
            const cellColor = rgbToHex(gameSettings.cellColorR, gameSettings.cellColorG, gameSettings.cellColorB);
            const cellNumberColor = rgbToHex(gameSettings.cellNumberColorR, gameSettings.cellNumberColorG, gameSettings.cellNumberColorB);
            
            cells.forEach(cell => {
                if (!cell.classList.contains('free')) {
                    cell.style.backgroundColor = cellColor;
                    cell.style.border = gameSettings.cellBorder;
                }
                cell.style.color = cellNumberColor;
                cell.style.fontSize = `${gameSettings.cellNumberSize}px`;
            });
            
            // Apply grid spacing
            const grids = document.querySelectorAll('.bingo-grid');
            grids.forEach(grid => {
                grid.style.gap = `${gameSettings.cellSpacing}px`;
            });
            
            // Apply background image or color
            if (gameSettings.backgroundImageUrl) {
                document.body.style.backgroundImage = `linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('${gameSettings.backgroundImageUrl}')`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundRepeat = 'no-repeat';
                document.body.style.backgroundAttachment = 'fixed';
            } else {
                const bgColor = rgbToHex(gameSettings.bgColorR, gameSettings.bgColorG, gameSettings.bgColorB);
                document.body.style.background = `linear-gradient(135deg, ${bgColor} 0%, ${adjustColor(bgColor, -20)} 100%)`;
                document.body.style.backgroundImage = 'none';
            }
            
            // Apply player name styling
            const playerNameColor = rgbToHex(gameSettings.playerNameColorR, gameSettings.playerNameColorG, gameSettings.playerNameColorB);
            gamePlayerName.style.color = playerNameColor;
            gamePlayerName.style.fontSize = `${gameSettings.playerNameSize}px`;
        }

        // Helper to adjust color brightness
        function adjustColor(hex, percent) {
            const num = parseInt(hex.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            
            return "#" + (
                0x1000000 + 
                (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + 
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + 
                (B < 255 ? B < 1 ? 0 : B : 255)
            ).toString(16).slice(1);
        }

        // Update player count display
        function updatePlayerCount() {
            const count = gameSettings.allowedPlayers ? gameSettings.allowedPlayers.length : 0;
            playerCount.textContent = `${count} player${count !== 1 ? 's' : ''}`;
        }

        // Update card navigation and title
        function updateCardNavigation() {
            const totalCards = playerCards.length;
            
            // Update card title with custom format
            const cardTitleText = gameSettings.cardTitleText
                .replace('{current}', currentCardIndex + 1)
                .replace('{total}', totalCards);
            cardTitle.textContent = cardTitleText;
            
            prevCardBtn.disabled = currentCardIndex === 0;
            nextCardBtn.disabled = currentCardIndex === totalCards - 1;
            
            // Render current card
            renderBingoGrid(playerCards[currentCardIndex].numbers, bingoGrid);
            
            // Load marked state if available
            if (playerCards[currentCardIndex].marked) {
                loadMarkedState(playerCards[currentCardIndex].numbers, playerCards[currentCardIndex].marked);
            }
        }

        // Show notification
        function showNotification(message, isSuccess = true) {
            notificationText.textContent = message;
            notification.className = `notification ${isSuccess ? 'success' : 'error'}`;
            notification.classList.remove('hidden');
            
            // Update icon based on success/error
            const icon = notification.querySelector('i');
            icon.className = isSuccess ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
            
            // Hide after 3 seconds
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        // Check if player is in allowed list
        function isPlayerAllowed(playerName) {
            const formattedName = formatPlayerName(playerName);
            return gameSettings.allowedPlayers.some(player => 
                player.name.toLowerCase() === formattedName.toLowerCase()
            );
        }

        // Load registered players and display in table (alphabetically sorted)
        async function loadRegisteredPlayersTable() {
            const playersRef = database.ref('players');
            const snapshot = await playersRef.once('value');
            
            registeredPlayersTableContainer.innerHTML = '';
            
            if (!snapshot.exists()) {
                registeredPlayersTableContainer.innerHTML = '<div class="no-players-message">No players registered yet</div>';
                return;
            }
            
            const players = [];
            snapshot.forEach(child => {
                const player = child.val();
                players.push({
                    name: player.name,
                    luckyNumber: player.luckyNumber,
                    joinedAt: player.joinedAt
                });
            });
            
            // Sort alphabetically by name
            players.sort((a, b) => a.name.localeCompare(b.name));
            
            // Create table
            const table = document.createElement('table');
            table.className = 'registered-players-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th style="width: 50px;">No.</th>
                        <th>Name</th>
                        <th style="width: 80px;">4D No.</th>
                        <th style="width: 100px;">Login Date</th>
                        <th style="width: 80px;">Time</th>
                    </tr>
                </thead>
                <tbody>
                    ${players.map((player, index) => {
                        const datetime = formatDateTime(player.joinedAt);
                        return `
                            <tr>
                                <td class="player-number">${index + 1}.</td>
                                <td class="player-name-cell">${player.name}</td>
                                <td class="player-lucky-number">${player.luckyNumber}</td>
                                <td class="player-date">${datetime.date}</td>
                                <td class="player-time">${datetime.time}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;
            
            registeredPlayersTableContainer.appendChild(table);
        }

        // Upload image to Firebase Storage - FIXED VERSION
        async function uploadImage(file, path) {
            try {
                console.log('Starting upload for file:', file.name, 'to path:', path);
                
                // Show loading notification
                showNotification('Uploading image...', true);
                
                // Create storage reference
                const storageRef = storage.ref();
                const imageRef = storageRef.child(path);
                
                console.log('Storage reference created');
                
                // Upload file with metadata
                const metadata = {
                    contentType: file.type,
                    customMetadata: {
                        'uploadedBy': 'MX BINGO Admin',
                        'uploadedAt': new Date().toISOString()
                    }
                };
                
                console.log('Starting upload...');
                const snapshot = await imageRef.put(file, metadata);
                console.log('Upload completed, snapshot:', snapshot);
                
                // Get download URL
                const downloadURL = await snapshot.ref.getDownloadURL();
                console.log('Download URL obtained:', downloadURL);
                
                showNotification('Image uploaded successfully!', true);
                return downloadURL;
            } catch (error) {
                console.error('Error uploading image:', error);
                console.error('Error details:', error.message, error.code, error.stack);
                
                // Show detailed error message
                let errorMessage = 'Error uploading image';
                if (error.code === 'storage/unauthorized') {
                    errorMessage = 'Storage access denied. Check Firebase Storage rules.';
                } else if (error.code === 'storage/canceled') {
                    errorMessage = 'Upload was canceled.';
                } else if (error.code === 'storage/unknown') {
                    errorMessage = 'Unknown error occurred during upload.';
                }
                
                showNotification(errorMessage, false);
                throw error;
            }
        }

        // Delete image from Firebase Storage
        async function deleteImage(url) {
            try {
                if (!url) return;
                
                console.log('Deleting image with URL:', url);
                
                // Extract path from URL
                const startIndex = url.indexOf('/o/') + 3;
                const endIndex = url.indexOf('?');
                if (startIndex === -1 || endIndex === -1) {
                    console.error('Invalid URL format for deletion');
                    return false;
                }
                
                const path = decodeURIComponent(url.substring(startIndex, endIndex));
                console.log('Extracted path for deletion:', path);
                
                // Create reference and delete
                const storageRef = storage.ref();
                const imageRef = storageRef.child(path);
                await imageRef.delete();
                
                console.log('Image deleted successfully');
                return true;
            } catch (error) {
                console.error('Error deleting image:', error);
                console.error('Error details:', error.message, error.code);
                
                let errorMessage = 'Error deleting image';
                if (error.code === 'storage/object-not-found') {
                    errorMessage = 'Image not found in storage.';
                }
                
                showNotification(errorMessage, false);
                throw error;
            }
        }

        // Update image preview
        function updateImagePreview(previewElement, imageUrl, infoElement, defaultText) {
            previewElement.innerHTML = '';
            
            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = 'Preview';
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'contain';
                img.onerror = function() {
                    console.error('Failed to load preview image:', imageUrl);
                    previewElement.innerHTML = `
                        <div class="file-upload-placeholder">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>Failed to load image</div>
                        </div>
                    `;
                };
                previewElement.appendChild(img);
                infoElement.textContent = 'Current: Custom image';
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'file-upload-placeholder';
                placeholder.innerHTML = `
                    <i class="fas fa-image"></i>
                    <div>${defaultText}</div>
                `;
                previewElement.appendChild(placeholder);
                infoElement.textContent = `Current: ${defaultText}`;
            }
        }

        // Login function (combined for both player and admin)
        loginBtn.addEventListener('click', async function() {
            const playerName = document.getElementById('playerName').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!playerName) {
                showNotification('Please enter your name', false);
                return;
            }
            
            if (!password) {
                showNotification('Please enter password', false);
                return;
            }
            
            // Check if it's admin login
            if (playerName.toLowerCase() === gameSettings.adminId.toLowerCase() && password === gameSettings.adminPassword) {
                // Admin login
                isAdmin = true;
                currentUser = { name: 'Admin' };
                
                // Show admin panel and header
                loginScreen.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                adminHeader.classList.remove('hidden');
                adminTabs.classList.remove('hidden');
                gameStatus.classList.remove('hidden');
                
                // Load settings from Firebase
                loadSettings();
                
                // Load player list
                loadRegisteredPlayersTable();
                
                // Generate preview card
                const previewCard = generateBingoCard();
                renderBingoGrid(previewCard, previewGrid, true);
                
                showNotification('Admin login successful');
                return;
            }
            
            // Regular player login
            const formattedName = formatPlayerName(playerName);
            
            // Check if game is active
            if (!gameSettings.gameActive) {
                showNotification('Game is not active. Cannot login.', false);
                return;
            }
            
            // Check if player is in allowed list
            if (!isPlayerAllowed(formattedName)) {
                showNotification('Player not in allowed list. Please contact admin.', false);
                return;
            }
            
            // Check password (non-case sensitive, using general password)
            if (password.toLowerCase() !== gameSettings.generalPassword.toLowerCase()) {
                showNotification('Incorrect password', false);
                return;
            }
            
            // Check if player exists in Firebase
            const playersRef = database.ref('players');
            const snapshot = await playersRef.orderByChild('name').equalTo(formattedName).once('value');
            
            if (snapshot.exists()) {
                // Player exists, login
                let playerData;
                snapshot.forEach(child => {
                    playerData = child.val();
                    playerData.id = child.key;
                });
                
                // Login successful
                currentUser = {
                    id: playerData.id,
                    name: formattedName,
                    luckyNumber: playerData.luckyNumber
                };
                
                // Load player cards
                playerCards = playerData.cards || [];
                
                // If no cards exist, generate unique cards
                if (playerCards.length === 0) {
                    for (let i = 0; i < gameSettings.cardsPerPlayer; i++) {
                        const uniqueCard = await generateUniqueBingoCard();
                        playerCards.push({
                            numbers: uniqueCard,
                            marked: {}
                        });
                    }
                    // Save to Firebase
                    await playersRef.child(playerData.id).update({ cards: playerCards });
                }
                
                // Show player screen with game header
                loginScreen.classList.add('hidden');
                playerScreen.classList.remove('hidden');
                gameHeader.classList.remove('hidden');
                
                // Update game header (4D number on RIGHT side)
                gamePlayerName.textContent = formattedName;
                gameLuckyNumber.textContent = playerData.luckyNumber;
                
                // Apply player name styling
                const playerNameColor = rgbToHex(gameSettings.playerNameColorR, gameSettings.playerNameColorG, gameSettings.playerNameColorB);
                gamePlayerName.style.color = playerNameColor;
                gamePlayerName.style.fontSize = `${gameSettings.playerNameSize}px`;
                
                // Update card navigation
                currentCardIndex = 0;
                updateCardNavigation();
                
                // Setup real-time listener for marked state changes
                setupPlayerMarkedListener();
                
                showNotification(`Welcome back, ${formattedName}!`);
            } else {
                // Create new player
                const luckyNumber = generateLuckyNumber();
                const newPlayer = {
                    name: formattedName,
                    luckyNumber: luckyNumber,
                    joinedAt: new Date().toISOString(),
                    cards: []
                };
                
                // Generate unique cards for the player
                for (let i = 0; i < gameSettings.cardsPerPlayer; i++) {
                    const uniqueCard = await generateUniqueBingoCard();
                    newPlayer.cards.push({
                        numbers: uniqueCard,
                        marked: {}
                    });
                }
                
                // Save to Firebase
                const newPlayerRef = await playersRef.push(newPlayer);
                
                // Set current user
                currentUser = {
                    id: newPlayerRef.key,
                    name: formattedName,
                    luckyNumber: luckyNumber
                };
                
                playerCards = newPlayer.cards;
                
                // Show player screen with game header
                loginScreen.classList.add('hidden');
                playerScreen.classList.remove('hidden');
                gameHeader.classList.remove('hidden');
                
                // Update game header (4D number on RIGHT side)
                gamePlayerName.textContent = formattedName;
                gameLuckyNumber.textContent = luckyNumber;
                
                // Apply player name styling
                const playerNameColor = rgbToHex(gameSettings.playerNameColorR, gameSettings.playerNameColorG, gameSettings.playerNameColorB);
                gamePlayerName.style.color = playerNameColor;
                gamePlayerName.style.fontSize = `${gameSettings.playerNameSize}px`;
                
                // Update card navigation
                currentCardIndex = 0;
                updateCardNavigation();
                
                // Setup real-time listener for marked state changes
                setupPlayerMarkedListener();
                
                showNotification(`Welcome to MX BINGO, ${formattedName}! Your lucky number is ${luckyNumber}`);
            }
        });

        // Load settings from Firebase
        async function loadSettings() {
            const settingsRef = database.ref('settings');
            const snapshot = await settingsRef.once('value');
            
            if (snapshot.exists()) {
                const loadedSettings = snapshot.val();
                gameSettings = { ...gameSettings, ...loadedSettings };
                
                // Update UI with loaded settings
                maxPlayersInput.value = gameSettings.maxPlayers;
                cardsPerPlayerInput.value = gameSettings.cardsPerPlayer;
                gameActiveSelect.value = gameSettings.gameActive.toString();
                cellColorRInput.value = gameSettings.cellColorR || 67;
                cellColorGInput.value = gameSettings.cellColorG || 97;
                cellColorBInput.value = gameSettings.cellColorB || 238;
                cellNumberColorRInput.value = gameSettings.cellNumberColorR || 255;
                cellNumberColorGInput.value = gameSettings.cellNumberColorG || 255;
                cellNumberColorBInput.value = gameSettings.cellNumberColorB || 255;
                cellNumberSizeInput.value = gameSettings.cellNumberSize || 16;
                cellSpacingInput.value = gameSettings.cellSpacing || 8;
                cellBorderInput.value = gameSettings.cellBorder || "2px solid #4361ee";
                bgColorRInput.value = gameSettings.bgColorR || 26;
                bgColorGInput.value = gameSettings.bgColorG || 26;
                bgColorBInput.value = gameSettings.bgColorB || 46;
                headerTextInput.value = gameSettings.headerText || "MX BINGO";
                welcomeTextInput.value = gameSettings.welcomeText || "Welcome to MX BINGO!";
                cardTitleTextInput.value = gameSettings.cardTitleText || "GAME CARD {current}/{total}";
                generalPasswordInput.value = gameSettings.generalPassword || "bingo123";
                adminIdInput.value = gameSettings.adminId || "admin";
                adminPasswordInput.value = gameSettings.adminPassword || "1234";
                playerNameColorRInput.value = gameSettings.playerNameColorR || 255;
                playerNameColorGInput.value = gameSettings.playerNameColorG || 255;
                playerNameColorBInput.value = gameSettings.playerNameColorB || 255;
                playerNameSizeInput.value = gameSettings.playerNameSize || 35;
                
                // Update image previews
                updateImagePreview(
                    freeCellPreview, 
                    gameSettings.freeCellImageUrl, 
                    freeCellImageInfo, 
                    'Default "FREE" text'
                );
                
                updateImagePreview(
                    backgroundPreview, 
                    gameSettings.backgroundImageUrl, 
                    backgroundImageInfo, 
                    'Color gradient background'
                );
                
                // Update displayed texts
                headerTitle.textContent = gameSettings.headerText || "MX BINGO";
                welcomeText.textContent = gameSettings.welcomeText || "Welcome to MX BINGO!";
                
                // Update game status indicator
                updateGameStatusIndicator();
                
                // Apply styling
                applyCellStyling();
                
                // Render player list editor
                renderPlayerListEditor();
                updatePlayerCount();
            }
        }

        // Render player list editor
        function renderPlayerListEditor() {
            playerListEditor.innerHTML = '';
            
            if (!gameSettings.allowedPlayers || gameSettings.allowedPlayers.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.textContent = 'No players added yet. Click "Add Player" to add players.';
                emptyMessage.style.color = 'rgba(255, 255, 255, 0.5)';
                emptyMessage.style.textAlign = 'center';
                emptyMessage.style.padding = '20px';
                playerListEditor.appendChild(emptyMessage);
                updatePlayerCount();
                return;
            }
            
            // Sort allowed players alphabetically
            gameSettings.allowedPlayers.sort((a, b) => a.name.localeCompare(b.name));
            
            gameSettings.allowedPlayers.forEach((player, index) => {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-list-item';
                playerItem.innerHTML = `
                    <input type="text" value="${player.name}" data-index="${index}" placeholder="Player Name">
                    <div class="player-list-controls">
                        <button class="remove-player" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                playerListEditor.appendChild(playerItem);
            });
            
            // Add event listeners for remove buttons
            document.querySelectorAll('.remove-player').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    removePlayerFromList(index);
                });
            });
            
            // Add event listeners for input changes
            document.querySelectorAll('#playerListEditor input').forEach(input => {
                input.addEventListener('change', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    const newName = this.value.trim();
                    if (newName) {
                        updatePlayerInList(index, newName);
                    }
                });
                
                // Auto-format name to uppercase first letter
                input.addEventListener('blur', function() {
                    if (this.value.trim()) {
                        const formattedName = formatPlayerName(this.value);
                        this.value = formattedName;
                        const index = parseInt(this.getAttribute('data-index'));
                        updatePlayerInList(index, formattedName);
                    }
                });
            });
            
            updatePlayerCount();
        }

        // Add player to list
        function addPlayerToList() {
            if (!gameSettings.allowedPlayers) {
                gameSettings.allowedPlayers = [];
            }
            
            const newPlayer = {
                name: `Player ${gameSettings.allowedPlayers.length + 1}`,
                luckyNumber: generateLuckyNumber()
            };
            
            gameSettings.allowedPlayers.push(newPlayer);
            // Sort alphabetically after adding
            gameSettings.allowedPlayers.sort((a, b) => a.name.localeCompare(b.name));
            renderPlayerListEditor();
        }

        // Update player in list
        function updatePlayerInList(index, newName) {
            if (gameSettings.allowedPlayers && gameSettings.allowedPlayers[index]) {
                const formattedName = formatPlayerName(newName);
                gameSettings.allowedPlayers[index].name = formattedName;
                // Sort alphabetically after updating
                gameSettings.allowedPlayers.sort((a, b) => a.name.localeCompare(b.name));
                renderPlayerListEditor();
            }
        }

        // Remove player from list
        function removePlayerFromList(index) {
            if (gameSettings.allowedPlayers && gameSettings.allowedPlayers[index]) {
                gameSettings.allowedPlayers.splice(index, 1);
                renderPlayerListEditor();
            }
        }

        // Import players from text
        function importPlayersFromText() {
            importTextarea.value = '';
            duplicateWarning.classList.add('hidden');
            importModal.classList.remove('hidden');
        }

        // Show duplicate warning
        function showDuplicateWarning(duplicates) {
            duplicateWarning.innerHTML = `
                <strong><i class="fas fa-exclamation-triangle"></i> Found ${duplicates.length} duplicate name${duplicates.length !== 1 ? 's' : ''}:</strong>
                <ul>
                    ${duplicates.map(name => `<li>${formatPlayerName(name)}</li>`).join('')}
                </ul>
                <div style="margin-top: 8px;">
                    Choose "Proceed" to import other names (skip duplicates) or "Cancel All" to cancel entire import.
                </div>
            `;
            duplicateWarning.classList.remove('hidden');
        }

        // Process import
        function processImport(skipDuplicates = false) {
            const importText = importTextarea.value.trim();
            if (!importText) {
                showNotification('Please enter names to import', false);
                return;
            }
            
            const names = parseCommaSeparatedNames(importText);
            if (names.length === 0) {
                showNotification('No valid names found', false);
                return;
            }
            
            const duplicates = findDuplicateNames(names);
            
            if (duplicates.length > 0 && !skipDuplicates) {
                showDuplicateWarning(duplicates);
                return;
            }
            
            // Filter out duplicates if skipping
            const uniqueNames = skipDuplicates 
                ? names.filter(name => {
                    const formattedName = formatPlayerName(name);
                    return !gameSettings.allowedPlayers.some(player => 
                        player.name.toLowerCase() === formattedName.toLowerCase()
                    );
                })
                : names;
            
            if (uniqueNames.length === 0) {
                showNotification('No new names to add (all names already exist)', false);
                importModal.classList.add('hidden');
                return;
            }
            
            // Add new players
            uniqueNames.forEach(name => {
                const formattedName = formatPlayerName(name);
                gameSettings.allowedPlayers.push({
                    name: formattedName,
                    luckyNumber: generateLuckyNumber()
                });
            });
            
            // Sort alphabetically after import
            gameSettings.allowedPlayers.sort((a, b) => a.name.localeCompare(b.name));
            renderPlayerListEditor();
            importModal.classList.add('hidden');
            showNotification(`Successfully added ${uniqueNames.length} new player${uniqueNames.length !== 1 ? 's' : ''}`);
        }

        // Update game status indicator
        function updateGameStatusIndicator() {
            if (gameSettings.gameActive) {
                statusIndicator.className = 'status-indicator status-active';
                statusIndicator.innerHTML = '<i class="fas fa-circle"></i><span>Game Active - Join Open</span>';
            } else {
                statusIndicator.className = 'status-indicator status-inactive';
                statusIndicator.innerHTML = '<i class="fas fa-circle"></i><span>Game Not Active - Join Closed</span>';
            }
        }

        // Save settings to Firebase
        saveSettingsBtn.addEventListener('click', async function() {
            // Update gameSettings object
            gameSettings = {
                maxPlayers: parseInt(maxPlayersInput.value),
                cardsPerPlayer: parseInt(cardsPerPlayerInput.value),
                gameActive: gameActiveSelect.value === 'true',
                cellColorR: parseInt(cellColorRInput.value),
                cellColorG: parseInt(cellColorGInput.value),
                cellColorB: parseInt(cellColorBInput.value),
                cellNumberColorR: parseInt(cellNumberColorRInput.value),
                cellNumberColorG: parseInt(cellNumberColorGInput.value),
                cellNumberColorB: parseInt(cellNumberColorBInput.value),
                cellNumberSize: parseInt(cellNumberSizeInput.value),
                cellSpacing: parseInt(cellSpacingInput.value),
                cellBorder: cellBorderInput.value,
                bgColorR: parseInt(bgColorRInput.value),
                bgColorG: parseInt(bgColorGInput.value),
                bgColorB: parseInt(bgColorBInput.value),
                headerText: headerTextInput.value,
                welcomeText: welcomeTextInput.value,
                cardTitleText: cardTitleTextInput.value,
                generalPassword: generalPasswordInput.value,
                adminId: adminIdInput.value,
                adminPassword: adminPasswordInput.value,
                playerNameColorR: parseInt(playerNameColorRInput.value),
                playerNameColorG: parseInt(playerNameColorGInput.value),
                playerNameColorB: parseInt(playerNameColorBInput.value),
                playerNameSize: parseInt(playerNameSizeInput.value),
                freeCellImageUrl: gameSettings.freeCellImageUrl,
                backgroundImageUrl: gameSettings.backgroundImageUrl,
                allowedPlayers: gameSettings.allowedPlayers || []
            };
            
            // Save to Firebase
            await database.ref('settings').set(gameSettings);
            
            // Update displayed texts
            headerTitle.textContent = gameSettings.headerText;
            welcomeText.textContent = gameSettings.welcomeText;
            
            // Update game status indicator
            updateGameStatusIndicator();
            
            // Apply styling
            applyCellStyling();
            
            showNotification('All settings saved successfully!');
        });

        // Reset all players
        resetPlayersBtn.addEventListener('click', async function() {
            if (await showConfirmationDialog('Are you sure you want to reset all players? This will remove ALL registered player data including their marked cards.')) {
                await database.ref('players').remove();
                loadRegisteredPlayersTable();
                showNotification('All players have been reset');
            }
        });

        // Clear current card button
        clearCardBtn.addEventListener('click', function() {
            clearCurrentCard();
        });

        // Add player button
        addPlayerBtn.addEventListener('click', function() {
            addPlayerToList();
        });

        // Import players button
        importPlayersBtn.addEventListener('click', function() {
            importPlayersFromText();
        });

        // Export players button (allowed list)
        exportPlayersBtn.addEventListener('click', function() {
            exportPlayerNamesOnly();
        });

        // Export names only button (registered players)
        exportNamesBtn.addEventListener('click', function() {
            exportPlayerNamesOnly();
        });

        // Export full details button (registered players)
        exportFullBtn.addEventListener('click', function() {
            exportFullPlayerDetails();
        });

        // Import modal buttons
        cancelImportBtn.addEventListener('click', function() {
            importModal.classList.add('hidden');
        });

        proceedImportBtn.addEventListener('click', function() {
            processImport(true);
        });

        cancelAllImportBtn.addEventListener('click', function() {
            importModal.classList.add('hidden');
        });

        // Card navigation - Remember marked numbers when switching cards
        prevCardBtn.addEventListener('click', function() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                updateCardNavigation();
            }
        });

        nextCardBtn.addEventListener('click', function() {
            if (currentCardIndex < playerCards.length - 1) {
                currentCardIndex++;
                updateCardNavigation();
            }
        });

        // Admin logout
        adminLogoutBtn.addEventListener('click', function() {
            isAdmin = false;
            currentUser = null;
            
            adminPanel.classList.add('hidden');
            adminHeader.classList.add('hidden');
            adminTabs.classList.add('hidden');
            gameStatus.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            
            // Clear login form
            document.getElementById('playerName').value = '';
            document.getElementById('password').value = '';
            
            showNotification('Admin logged out');
        });

        // FREE Cell Image Upload - FIXED
        freeCellImageInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/webp', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                showNotification('Please select a valid image file (PNG, JPG, JPEG, WEBP, GIF)', false);
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('Image size should be less than 5MB', false);
                return;
            }
            
            console.log('Selected file for FREE cell:', file.name, file.type, file.size);
            
            // Show loading
            freeCellPreview.innerHTML = '<div class="spinner"></div>';
            
            try {
                // Create unique filename with timestamp
                const timestamp = Date.now();
                const fileExtension = file.name.split('.').pop().toLowerCase();
                const fileName = `free-cell-${timestamp}.${fileExtension}`;
                const path = `mx-bingo-images/${fileName}`;
                
                console.log('Uploading to path:', path);
                
                // Upload to Firebase Storage
                const downloadURL = await uploadImage(file, path);
                console.log('Upload successful, URL:', downloadURL);
                
                // Delete old image if exists
                if (gameSettings.freeCellImageUrl) {
                    try {
                        await deleteImage(gameSettings.freeCellImageUrl);
                        console.log('Old FREE cell image deleted');
                    } catch (deleteError) {
                        console.warn('Could not delete old image, continuing:', deleteError);
                    }
                }
                
                // Update settings
                gameSettings.freeCellImageUrl = downloadURL;
                
                // Update preview
                updateImagePreview(
                    freeCellPreview, 
                    downloadURL, 
                    freeCellImageInfo, 
                    'Default "FREE" text'
                );
                
                // Save to Firebase
                await database.ref('settings/freeCellImageUrl').set(downloadURL);
                console.log('FREE cell image URL saved to database');
                
                // Clear file input
                freeCellImageInput.value = '';
                
                showNotification('FREE cell image uploaded successfully!');
            } catch (error) {
                console.error('Error uploading FREE cell image:', error);
                showNotification('Error uploading FREE cell image: ' + error.message, false);
                updateImagePreview(
                    freeCellPreview, 
                    gameSettings.freeCellImageUrl, 
                    freeCellImageInfo, 
                    'Default "FREE" text'
                );
            }
        });

        // Remove FREE Cell Image
        removeFreeCellImageBtn.addEventListener('click', async function() {
            if (!gameSettings.freeCellImageUrl) {
                showNotification('No FREE cell image to remove', false);
                return;
            }
            
            if (await showConfirmationDialog('Are you sure you want to remove the FREE cell image?')) {
                try {
                    // Delete from Firebase Storage
                    await deleteImage(gameSettings.freeCellImageUrl);
                    
                    // Update settings
                    gameSettings.freeCellImageUrl = null;
                    
                    // Update preview
                    updateImagePreview(
                        freeCellPreview, 
                        null, 
                        freeCellImageInfo, 
                        'Default "FREE" text'
                    );
                    
                    // Save to Firebase
                    await database.ref('settings/freeCellImageUrl').set(null);
                    
                    showNotification('FREE cell image removed successfully!');
                } catch (error) {
                    console.error('Error removing FREE cell image:', error);
                    showNotification('Error removing FREE cell image: ' + error.message, false);
                }
            }
        });

        // Background Image Upload - FIXED
        backgroundImageInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/webp', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                showNotification('Please select a valid image file (PNG, JPG, JPEG, WEBP, GIF)', false);
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('Image size should be less than 5MB', false);
                return;
            }
            
            console.log('Selected file for background:', file.name, file.type, file.size);
            
            // Show loading
            backgroundPreview.innerHTML = '<div class="spinner"></div>';
            
            try {
                // Create unique filename with timestamp
                const timestamp = Date.now();
                const fileExtension = file.name.split('.').pop().toLowerCase();
                const fileName = `background-${timestamp}.${fileExtension}`;
                const path = `mx-bingo-images/${fileName}`;
                
                console.log('Uploading to path:', path);
                
                // Upload to Firebase Storage
                const downloadURL = await uploadImage(file, path);
                console.log('Upload successful, URL:', downloadURL);
                
                // Delete old image if exists
                if (gameSettings.backgroundImageUrl) {
                    try {
                        await deleteImage(gameSettings.backgroundImageUrl);
                        console.log('Old background image deleted');
                    } catch (deleteError) {
                        console.warn('Could not delete old image, continuing:', deleteError);
                    }
                }
                
                // Update settings
                gameSettings.backgroundImageUrl = downloadURL;
                
                // Update preview
                updateImagePreview(
                    backgroundPreview, 
                    downloadURL, 
                    backgroundImageInfo, 
                    'Color gradient background'
                );
                
                // Save to Firebase
                await database.ref('settings/backgroundImageUrl').set(downloadURL);
                console.log('Background image URL saved to database');
                
                // Apply background
                applyCellStyling();
                
                // Clear file input
                backgroundImageInput.value = '';
                
                showNotification('Background image uploaded successfully!');
            } catch (error) {
                console.error('Error uploading background image:', error);
                showNotification('Error uploading background image: ' + error.message, false);
                updateImagePreview(
                    backgroundPreview, 
                    gameSettings.backgroundImageUrl, 
                    backgroundImageInfo, 
                    'Color gradient background'
                );
            }
        });

        // Remove Background Image
        removeBackgroundImageBtn.addEventListener('click', async function() {
            if (!gameSettings.backgroundImageUrl) {
                showNotification('No background image to remove', false);
                return;
            }
            
            if (await showConfirmationDialog('Are you sure you want to remove the background image?')) {
                try {
                    // Delete from Firebase Storage
                    await deleteImage(gameSettings.backgroundImageUrl);
                    
                    // Update settings
                    gameSettings.backgroundImageUrl = null;
                    
                    // Update preview
                    updateImagePreview(
                        backgroundPreview, 
                        null, 
                        backgroundImageInfo, 
                        'Color gradient background'
                    );
                    
                    // Save to Firebase
                    await database.ref('settings/backgroundImageUrl').set(null);
                    
                    // Apply background
                    applyCellStyling();
                    
                    showNotification('Background image removed successfully!');
                } catch (error) {
                    console.error('Error removing background image:', error);
                    showNotification('Error removing background image: ' + error.message, false);
                }
            }
        });

        // Firebase real-time listeners - settings changes
        database.ref('settings').on('value', (snapshot) => {
            if (snapshot.exists()) {
                const loadedSettings = snapshot.val();
                gameSettings = { ...gameSettings, ...loadedSettings };
                
                // Update displayed texts for everyone
                headerTitle.textContent = gameSettings.headerText || "MX BINGO";
                welcomeText.textContent = gameSettings.welcomeText || "Welcome to MX BINGO!";
                
                // Apply styling for everyone
                applyCellStyling();
                
                // Update game status indicator if visible
                if (gameStatus && !gameStatus.classList.contains('hidden')) {
                    updateGameStatusIndicator();
                }
                
                // Update player game screen if visible
                if (playerScreen && !playerScreen.classList.contains('hidden')) {
                    // Update card title with current settings
                    const totalCards = playerCards.length;
                    const cardTitleText = gameSettings.cardTitleText
                        .replace('{current}', currentCardIndex + 1)
                        .replace('{total}', totalCards);
                    cardTitle.textContent = cardTitleText;
                    
                    // Apply player name styling
                    const playerNameColor = rgbToHex(gameSettings.playerNameColorR, gameSettings.playerNameColorG, gameSettings.playerNameColorB);
                    gamePlayerName.style.color = playerNameColor;
                    gamePlayerName.style.fontSize = `${gameSettings.playerNameSize}px`;
                    
                    // Show game status indicator for players
                    gameStatus.classList.remove('hidden');
                    updateGameStatusIndicator();
                }
                
                // Update admin panel if visible
                if (adminPanel && !adminPanel.classList.contains('hidden')) {
                    // Update UI with loaded settings
                    maxPlayersInput.value = gameSettings.maxPlayers;
                    cardsPerPlayerInput.value = gameSettings.cardsPerPlayer;
                    gameActiveSelect.value = gameSettings.gameActive.toString();
                    cellColorRInput.value = gameSettings.cellColorR || 67;
                    cellColorGInput.value = gameSettings.cellColorG || 97;
                    cellColorBInput.value = gameSettings.cellColorB || 238;
                    cellNumberColorRInput.value = gameSettings.cellNumberColorR || 255;
                    cellNumberColorGInput.value = gameSettings.cellNumberColorG || 255;
                    cellNumberColorBInput.value = gameSettings.cellNumberColorB || 255;
                    cellNumberSizeInput.value = gameSettings.cellNumberSize || 16;
                    cellSpacingInput.value = gameSettings.cellSpacing || 8;
                    cellBorderInput.value = gameSettings.cellBorder || "2px solid #4361ee";
                    bgColorRInput.value = gameSettings.bgColorR || 26;
                    bgColorGInput.value = gameSettings.bgColorG || 26;
                    bgColorBInput.value = gameSettings.bgColorB || 46;
                    headerTextInput.value = gameSettings.headerText || "MX BINGO";
                    welcomeTextInput.value = gameSettings.welcomeText || "Welcome to MX BINGO!";
                    cardTitleTextInput.value = gameSettings.cardTitleText || "GAME CARD {current}/{total}";
                    generalPasswordInput.value = gameSettings.generalPassword || "bingo123";
                    adminIdInput.value = gameSettings.adminId || "admin";
                    adminPasswordInput.value = gameSettings.adminPassword || "1234";
                    playerNameColorRInput.value = gameSettings.playerNameColorR || 255;
                    playerNameColorGInput.value = gameSettings.playerNameColorG || 255;
                    playerNameColorBInput.value = gameSettings.playerNameColorB || 255;
                    playerNameSizeInput.value = gameSettings.playerNameSize || 35;
                    
                    // Update image previews
                    updateImagePreview(
                        freeCellPreview, 
                        gameSettings.freeCellImageUrl, 
                        freeCellImageInfo, 
                        'Default "FREE" text'
                    );
                    
                    updateImagePreview(
                        backgroundPreview, 
                        gameSettings.backgroundImageUrl, 
                        backgroundImageInfo, 
                        'Color gradient background'
                    );
                    
                    // Update game status indicator
                    updateGameStatusIndicator();
                    
                    // Render player list editor
                    renderPlayerListEditor();
                    updatePlayerCount();
                }
            }
        });

        // Setup real-time listener for marked state changes
        function setupPlayerMarkedListener() {
            if (currentUser && !isAdmin) {
                database.ref('players/' + currentUser.id + '/cards').on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const cardsData = snapshot.val();
                        playerCards = cardsData;
                        
                        // Update current card if needed
                        if (playerCards[currentCardIndex]) {
                            renderBingoGrid(playerCards[currentCardIndex].numbers, bingoGrid);
                            
                            // Load marked state if available
                            if (playerCards[currentCardIndex].marked) {
                                loadMarkedState(playerCards[currentCardIndex].numbers, playerCards[currentCardIndex].marked);
                            }
                        }
                    }
                });
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Generate a sample preview card
            const previewCard = generateBingoCard();
            if (previewGrid) {
                renderBingoGrid(previewCard, previewGrid, true);
            }
            
            // Check Firebase connection
            testFirebaseConnection();
            
            // Add initial player to list if empty
            if (!gameSettings.allowedPlayers || gameSettings.allowedPlayers.length === 0) {
                gameSettings.allowedPlayers = [
                    { name: "Player 1", luckyNumber: generateLuckyNumber() },
                    { name: "Player 2", luckyNumber: generateLuckyNumber() },
                    { name: "Player 3", luckyNumber: generateLuckyNumber() }
                ];
            }
        });

        // Test Firebase connection
        async function testFirebaseConnection() {
            try {
                const testRef = database.ref('connectionTest');
                await testRef.set({
                    timestamp: new Date().toISOString(),
                    message: 'MX BINGO connected successfully',
                    project: 'mx-bingo'
                });
                console.log(' Firebase connection successful for MX BINGO');
                
                // Test storage connection
                const storageRef = storage.ref();
                const testFileRef = storageRef.child('test-connection.txt');
                await testFileRef.putString('Test connection', 'raw');
                console.log(' Firebase Storage connection successful');
            } catch (error) {
                console.error(' Firebase connection error:', error);
                showNotification('Firebase connection issue. Check your API key and storage rules.', false);
            }
        }
    </script>
</body>
</html>
