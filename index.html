<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Bingo Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* [KEEP ALL PREVIOUS CSS STYLES - NO CHANGES] */
        /* Only adding new styles for the confirmation dialog */
        
        .confirmation-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .confirmation-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: center;
        }
        
        .confirmation-buttons .btn {
            flex: 1;
        }
        
        .player-id-display {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .player-id-display code {
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: monospace;
            color: #6a11cb;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Confirmation Dialog -->
    <div class="confirmation-dialog" id="confirmationDialog">
        <div class="confirmation-content">
            <h3><i class="fas fa-user-check"></i> Welcome Back!</h3>
            <p>Name "<span id="returningPlayerName"></span>" is already registered in room "<span id="returningPlayerRoom"></span>".</p>
            <p>Is this you? Would you like to continue with your existing cards?</p>
            
            <div class="player-id-display">
                <p><i class="fas fa-info-circle"></i> Your Player ID: <code id="playerIdDisplay"></code></p>
                <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">Save this ID if you want to login on another device</p>
            </div>
            
            <div class="confirmation-buttons">
                <button class="btn btn-secondary" id="confirmNewPlayerBtn">
                    <i class="fas fa-user-plus"></i> No, I'm Different
                </button>
                <button class="btn btn-primary" id="confirmReturningPlayerBtn">
                    <i class="fas fa-sign-in-alt"></i> Yes, It's Me
                </button>
            </div>
        </div>
    </div>
    
    <!-- Loading Indicator -->
    <div class="loading-indicator" id="loadingIndicator">
        <div class="loading-spinner"></div>
        <p>Loading your game...</p>
    </div>
    
    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus">Connecting...</div>
    
    <!-- Sync Notification -->
    <div class="sync-notification" id="syncNotification">
        <i class="fas fa-sync-alt"></i> Settings Updated
    </div>
    
    <!-- Random Picture Frames -->
    <div class="random-picture-frame" id="frame1" style="top: 10%; left: 5%;"></div>
    <div class="random-picture-frame" id="frame2" style="top: 15%; right: 5%;"></div>
    <div class="random-picture-frame" id="frame3" style="bottom: 20%; left: 10%;"></div>
    <div class="random-picture-frame" id="frame4" style="bottom: 15%; right: 10%;"></div>
    
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-dice"></i> Mobile Bingo</h1>
            <p>Login to play with your unique bingo cards</p>
        </div>
        
        <div class="content">
            <!-- Login Screen -->
            <div id="loginScreen">
                <h2>Welcome to Bingo!</h2>
                <p>Enter your name to join the game. Maximum <span id="maxPlayersDisplay">30</span> players.</p>
                
                <form class="login-form" id="loginForm">
                    <div class="input-group">
                        <label for="playerName">Your Name</label>
                        <input type="text" id="playerName" placeholder="Enter your name" required autocomplete="off">
                        <small style="color: #666; font-size: 0.85rem;">Returning players will be asked to confirm identity</small>
                    </div>
                    
                    <div class="input-group">
                        <label for="gameRoomCode">Game Room Code (Optional)</label>
                        <input type="text" id="gameRoomCode" placeholder="Leave empty for default room">
                    </div>
                    
                    <!-- Optional: Player ID input for advanced login -->
                    <div class="input-group" id="playerIdInputGroup" style="display: none;">
                        <label for="playerId">Player ID (Optional)</label>
                        <input type="text" id="playerId" placeholder="Enter your Player ID if you have one">
                        <small style="color: #666; font-size: 0.85rem;">Found in your confirmation screen</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Join Game
                    </button>
                </form>
                
                <div class="players-count">
                    Players joined: <span id="currentPlayers">0</span> / <span id="maxPlayers">30</span>
                </div>
                
                <div class="admin-login-link">
                    <a href="#" id="adminLoginLink">Admin Login</a>
                </div>
            </div>
            
            <!-- Game Screen -->
            <div id="gameScreen">
                <div class="player-info">
                    <div class="player-name" id="displayPlayerName">Player</div>
                    <div class="card-counter">Card <span id="currentCard">1</span> of <span id="totalCards">3</span></div>
                </div>
                
                <div class="player-id-display" style="margin-bottom: 15px;">
                    <p><i class="fas fa-id-card"></i> Your Player ID: <code id="currentPlayerId"></code></p>
                    <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">Save this ID to login on another device</p>
                </div>
                
                <div class="bingo-card-container">
                    <div class="bingo-grid" id="bingoGrid">
                        <!-- Bingo cells will be generated here -->
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-secondary" id="prevCardBtn">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-primary" id="nextCardBtn">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                
                <div style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 10px; font-size: 0.9rem;">
                    <p><strong>Game Room:</strong> <span id="currentGameRoom">Default</span></p>
                    <p><i class="fas fa-info-circle"></i> Admin changes will automatically update for all players.</p>
                </div>
                
                <button class="btn btn-primary" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
            
            <!-- Admin Screen -->
            <div id="adminScreen">
                <!-- [KEEP ADMIN SCREEN EXACTLY AS BEFORE - NO CHANGES] -->
                <!-- Admin screen content remains the same -->
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>Mobile Bingo Game &copy; 2023 | Real-time synchronized for all players</p>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyB01PdqxQOdevXQNcYJMGzuYmG1u-S77ec",
            authDomain: "mx-bingo.firebaseapp.com",
            databaseURL: "https://mx-bingo-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mx-bingo",
            storageBucket: "mx-bingo.firebasestorage.app",
            messagingSenderId: "480388469034",
            appId: "1:480388469034:web:a6edab28faf37e3e0c4e53"
        };
        
        // Initialize Firebase
        let firebaseApp, database;
        let useFirebase = true;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("Firebase initialized successfully!");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            useFirebase = false;
        }
        
        // ==================== GAME VARIABLES ====================
        const simulatedDB = {
            players: [],
            cardsPool: [],
            issuedCards: new Set(),
            playerCards: {}
        };

        const ADMIN_CREDENTIALS = {
            id: "admin",
            password: "1234"
        };

        const DEFAULT_PICTURES = [
            'https://images.unsplash.com/photo-1518837695005-2083093ee35b?w=150&h=150&fit=crop',
            'https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=150&h=150&fit=crop',
            'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=150&h=150&fit=crop',
            'https://images.unsplash.com/photo-1579546929662-711aa81148cf?w=150&h=150&fit=crop'
        ];

        // Current game room (default)
        let currentGameRoom = "Default";
        
        // Game settings with defaults
        let gameSettings = {
            maxPlayers: 30,
            cardsPerPlayer: 3
        };

        // UI Customization settings with defaults
        let uiSettings = {
            loginBg: "linear-gradient(135deg, #6a11cb 0%, #2575fc 100%)",
            gameBg: "#f5f5f5",
            customBackground: null,
            randomPictures: true,
            primaryBtnColor: "#6a11cb",
            primaryBtnTextColor: "#ffffff",
            secondaryBtnColor: "#f0f0f0",
            secondaryBtnTextColor: "#333333",
            markedCellColor: "#6a11cb",
            freeCellColor: "#ffd166",
            playerNameColor: "#6a11cb",
            numberBackgrounds: [],
            enableNumberBackgrounds: false
        };

        // Track last update time to avoid loops
        let lastFirebaseUpdate = 0;

        // ==================== PLAYER ID SYSTEM ====================
        
        // Generate a unique player ID (4-digit number)
        function generatePlayerId() {
            return Math.floor(1000 + Math.random() * 9000); // 1000-9999
        }
        
        // Generate a unique session ID for this browser/device
        function getSessionId() {
            let sessionId = localStorage.getItem('playerSessionId');
            if (!sessionId) {
                sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('playerSessionId', sessionId);
            }
            return sessionId;
        }
        
        // Check if this session belongs to the player
        function isSameSession(player) {
            const sessionId = getSessionId();
            return player.sessionId === sessionId;
        }
        
        // ==================== FIXED LOGIN LOGIC ====================
        
        function handleLogin(e) {
            e.preventDefault();
            
            const playerNameInput = document.getElementById('playerName');
            const playerName = playerNameInput.value.trim();
            const roomCodeInput = document.getElementById('gameRoomCode');
            const playerIdInput = document.getElementById('playerId');
            const enteredPlayerId = playerIdInput ? playerIdInput.value.trim() : '';
            
            // Update game room if provided
            if (roomCodeInput.value.trim()) {
                currentGameRoom = roomCodeInput.value.trim();
                localStorage.setItem('bingoGameRoom', currentGameRoom);
                updateRoomDisplays();
                reloadSettingsForNewRoom();
            }
            
            if (!playerName) {
                alert('Please enter your name');
                return;
            }
            
            // Check for admin login
            if (playerName.toLowerCase() === ADMIN_CREDENTIALS.id) {
                showAdminLogin();
                playerNameInput.value = '';
                return;
            }
            
            // Check if name already exists in this room
            const existingPlayer = simulatedDB.players.find(p => 
                p.name.toLowerCase() === playerName.toLowerCase() && 
                p.room === currentGameRoom
            );
            
            if (existingPlayer) {
                // Player name exists - show confirmation dialog
                showReturningPlayerDialog(existingPlayer, playerName);
                return;
            }
            
            // New player - proceed with registration
            registerNewPlayer(playerName);
        }
        
        function showReturningPlayerDialog(existingPlayer, playerName) {
            // Show confirmation dialog
            document.getElementById('returningPlayerName').textContent = playerName;
            document.getElementById('returningPlayerRoom').textContent = currentGameRoom;
            document.getElementById('playerIdDisplay').textContent = existingPlayer.playerId || 'N/A';
            
            const dialog = document.getElementById('confirmationDialog');
            dialog.style.display = 'flex';
            
            // Setup button handlers
            document.getElementById('confirmReturningPlayerBtn').onclick = function() {
                dialog.style.display = 'none';
                loginAsReturningPlayer(existingPlayer);
            };
            
            document.getElementById('confirmNewPlayerBtn').onclick = function() {
                dialog.style.display = 'none';
                // Force create new player with different name
                registerNewPlayerWithDifferentName(playerName);
            };
        }
        
        function loginAsReturningPlayer(existingPlayer) {
            showLoading(true);
            
            setTimeout(() => {
                currentPlayer = existingPlayer;
                
                // Update session ID to track this device
                currentPlayer.sessionId = getSessionId();
                
                // Update UI
                document.getElementById('displayPlayerName').textContent = currentPlayer.name;
                document.getElementById('totalCards').textContent = currentPlayer.cards.length;
                document.getElementById('currentPlayerId').textContent = currentPlayer.playerId || 'N/A';
                currentCardIndex = 0;
                updateCardDisplay();
                
                // Switch to game screen
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('gameScreen').style.display = 'block';
                document.getElementById('adminScreen').style.display = 'none';
                
                updatePlayersCount();
                updateSettingsDisplay();
                
                // Save last player for auto-login
                localStorage.setItem('lastPlayerName', currentPlayer.name);
                localStorage.setItem('lastPlayerRoom', currentGameRoom);
                localStorage.setItem('lastPlayerId', currentPlayer.playerId);
                
                // Save to localStorage
                saveToLocalStorage();
                
                showLoading(false);
                showNotification(`Welcome back, ${currentPlayer.name}!`);
            }, 500);
        }
        
        function registerNewPlayer(playerName) {
            showLoading(true);
            
            setTimeout(() => {
                // Check if we've reached the player limit
                if (simulatedDB.players.length >= gameSettings.maxPlayers) {
                    alert(`Sorry, the game is full! Maximum ${gameSettings.maxPlayers} players allowed.`);
                    showLoading(false);
                    return;
                }
                
                // Create new player
                const playerId = simulatedDB.players.length + 1;
                const playerUniqueId = generatePlayerId();
                
                currentPlayer = {
                    id: playerId,
                    playerId: playerUniqueId, // Public 4-digit ID
                    sessionId: getSessionId(), // Private session ID for this device
                    name: playerName,
                    room: currentGameRoom,
                    cards: []
                };
                
                assignCardsToPlayer(currentPlayer);
                simulatedDB.players.push(currentPlayer);
                simulatedDB.playerCards[playerId] = currentPlayer.cards.map(card => card.id);
                
                // Save last player for auto-login
                localStorage.setItem('lastPlayerName', playerName);
                localStorage.setItem('lastPlayerRoom', currentGameRoom);
                localStorage.setItem('lastPlayerId', playerUniqueId);
                
                // Update UI
                document.getElementById('displayPlayerName').textContent = currentPlayer.name;
                document.getElementById('totalCards').textContent = currentPlayer.cards.length;
                document.getElementById('currentPlayerId').textContent = currentPlayer.playerId;
                currentCardIndex = 0;
                updateCardDisplay();
                
                // Switch to game screen
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('gameScreen').style.display = 'block';
                document.getElementById('adminScreen').style.display = 'none';
                
                updatePlayersCount();
                updateSettingsDisplay();
                
                // Clear the input
                document.getElementById('playerName').value = '';
                
                // Save to localStorage for persistence
                saveToLocalStorage();
                
                showLoading(false);
                showNotification(`Welcome to the game, ${playerName}! Your Player ID is ${playerUniqueId}`);
            }, 500);
        }
        
        function registerNewPlayerWithDifferentName(baseName) {
            let newName = baseName;
            let counter = 1;
            
            // Keep trying until we find an available name
            while (simulatedDB.players.find(p => 
                p.name.toLowerCase() === newName.toLowerCase() && 
                p.room === currentGameRoom
            )) {
                counter++;
                newName = `${baseName}${counter}`;
                
                // Safety check
                if (counter > 100) {
                    alert("Could not find available name. Please choose a different name.");
                    return;
                }
            }
            
            // Update input field with new name
            document.getElementById('playerName').value = newName;
            
            // Show message
            alert(`Name "${baseName}" is taken. Using "${newName}" instead. You can change it if you want.`);
            
            // Register with new name
            registerNewPlayer(newName);
        }
        
        // ==================== MODIFIED AUTO-LOGIN ====================
        
        function checkAutoLogin() {
            // Check if player was previously logged in
            const lastPlayerName = localStorage.getItem('lastPlayerName');
            const lastPlayerRoom = localStorage.getItem('lastPlayerRoom');
            const lastPlayerId = localStorage.getItem('lastPlayerId');
            
            if (lastPlayerName && lastPlayerRoom === currentGameRoom) {
                // Find the player in the database
                const existingPlayer = simulatedDB.players.find(p => 
                    p.name.toLowerCase() === lastPlayerName.toLowerCase() && 
                    p.room === currentGameRoom
                );
                
                if (existingPlayer) {
                    // Check if player ID matches (extra security)
                    if (lastPlayerId && existingPlayer.playerId != lastPlayerId) {
                        console.log("Player ID mismatch - requiring re-login");
                        return;
                    }
                    
                    // Auto-login the player
                    currentPlayer = existingPlayer;
                    showLoading(true);
                    
                    // Small delay to ensure UI is ready
                    setTimeout(() => {
                        document.getElementById('displayPlayerName').textContent = currentPlayer.name;
                        document.getElementById('totalCards').textContent = currentPlayer.cards.length;
                        document.getElementById('currentPlayerId').textContent = currentPlayer.playerId || 'N/A';
                        currentCardIndex = 0;
                        updateCardDisplay();
                        
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('gameScreen').style.display = 'block';
                        document.getElementById('adminScreen').style.display = 'none';
                        
                        updatePlayersCount();
                        updateSettingsDisplay();
                        
                        showLoading(false);
                        showNotification(`Welcome back, ${currentPlayer.name}!`);
                    }, 500);
                }
            }
        }
        
        // ==================== MODIFIED LOAD FROM LOCALSTORAGE ====================
        
        function loadFromLocalStorage() {
            const savedState = localStorage.getItem(`mobileBingoGame_${currentGameRoom}`);
            if (savedState) {
                try {
                    const gameState = JSON.parse(savedState);
                    simulatedDB.players = gameState.players || [];
                    simulatedDB.issuedCards = new Set(gameState.issuedCards || []);
                    simulatedDB.playerCards = gameState.playerCards || {};
                    
                    // Add room and generate missing player IDs
                    simulatedDB.players.forEach(player => {
                        if (!player.room) {
                            player.room = currentGameRoom;
                        }
                        if (!player.playerId) {
                            player.playerId = generatePlayerId();
                        }
                        
                        const cardIds = simulatedDB.playerCards[player.id] || [];
                        player.cards = cardIds.map(id => 
                            simulatedDB.cardsPool.find(card => card.id === id)
                        ).filter(card => card);
                    });
                    
                    console.log(`Loaded ${simulatedDB.players.length} players for room: ${currentGameRoom}`);
                } catch (error) {
                    console.error('Failed to load game state:', error);
                }
            }
        }
        
        // ==================== MODIFIED LOGOUT ====================
        
        function handleLogout() {
            // Show confirmation
            if (confirm("Are you sure you want to logout?")) {
                // Clear last player data
                localStorage.removeItem('lastPlayerName');
                localStorage.removeItem('lastPlayerRoom');
                localStorage.removeItem('lastPlayerId');
                
                currentPlayer = null;
                currentCardIndex = 0;
                
                document.getElementById('gameScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('adminScreen').style.display = 'none';
                
                saveToLocalStorage();
                
                showNotification("Logged out successfully!");
            }
        }
        
        // ==================== MODIFIED CLEAR PLAYERS ====================
        
        function clearAllPlayers() {
            if (confirm("Are you sure you want to clear ALL players? This will remove all player data including Player IDs.")) {
                simulatedDB.players = [];
                simulatedDB.issuedCards.clear();
                simulatedDB.playerCards = {};
                
                // Clear all player-related localStorage
                localStorage.removeItem('lastPlayerName');
                localStorage.removeItem('lastPlayerRoom');
                localStorage.removeItem('lastPlayerId');
                localStorage.removeItem('playerSessionId');
                
                // Update UI
                updatePlayersCount();
                updateSettingsDisplay();
                
                // Save changes
                saveToLocalStorage();
                
                // Show confirmation
                alert("All players have been cleared! All Player IDs are now invalid.");
            }
        }
        
        // ==================== THE REST OF THE FUNCTIONS REMAIN THE SAME ====================
        
        // [KEEP ALL OTHER FUNCTIONS EXACTLY AS THEY WERE IN THE PREVIOUS CODE]
        // Only the login/logout/player management functions above have changed
        
        // Initialize the rest of the game (same as before)
        function initGame() {
            generateBingoCards();
            
            // Get game room from URL or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const roomFromUrl = urlParams.get('room');
            if (roomFromUrl) {
                currentGameRoom = roomFromUrl;
            } else {
                const savedRoom = localStorage.getItem('bingoGameRoom');
                if (savedRoom) currentGameRoom = savedRoom;
            }
            
            // Update room displays
            updateRoomDisplays();
            
            // Initialize Firebase connection
            if (useFirebase) {
                listenForSettingsUpdates();
            }
            
            // Load settings
            loadSettingsFromFirebase();
            
            // Load player data
            loadFromLocalStorage();
            
            // Update displays
            updatePlayersCount();
            updateSettingsDisplay();
            
            // Check if player was already logged in
            checkAutoLogin();
            
            // Setup event listeners
            setupEventListeners();
            
            // Load random pictures if enabled
            if (uiSettings.randomPictures) {
                loadRandomPictures();
            }
        }
        
        // [KEEP ALL OTHER FUNCTIONS: generateBingoCards, setupEventListeners, etc.]
        // They remain exactly the same as in the previous code
        
        // Initialize the game
        window.addEventListener('DOMContentLoaded', () => {
            showLoading(true);
            setTimeout(() => {
                initGame();
                showLoading(false);
            }, 500);
        });
        
        // Make sure to include all other functions from the previous code
        // They should be copied exactly as they were
        
    </script>
</body>
</html>
