<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Bingo Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin: 20px 0;
        }
        
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            text-align: center;
            padding: 25px 20px;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }
        
        .content {
            padding: 25px 20px;
            position: relative;
            min-height: 500px;
        }
        
        /* Login Screen */
        #loginScreen {
            text-align: center;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 25px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            text-align: left;
        }
        
        .input-group label {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .input-group input {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .input-group input:focus {
            border-color: #6a11cb;
            outline: none;
        }
        
        .btn {
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background-color: #6a11cb;
            color: white;
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .players-count {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .players-count span {
            font-weight: 700;
            color: #6a11cb;
        }
        
        /* Game Screen */
        #gameScreen {
            display: none;
        }
        
        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .player-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #6a11cb;
        }
        
        .card-counter {
            background-color: #f0f0f0;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .bingo-card-container {
            background-color: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        
        .bingo-cell {
            aspect-ratio: 1;
            background-color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.05);
        }
        
        .bingo-cell.free {
            background-color: #ffd166;
            color: #333;
        }
        
        .bingo-cell.marked {
            background-color: #6a11cb;
            color: white;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .controls .btn {
            flex: 1;
        }
        
        .footer {
            margin-top: 20px;
            text-align: center;
            font-size: 0.85rem;
            color: #777;
        }
        
        /* Lucky 4D Number Display */
        .password-display {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            display: none;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.3);
            min-width: 250px;
            text-align: center;
        }
        
        /* Confirmation Dialog */
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .confirmation-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: center;
        }
        
        .confirmation-buttons .btn {
            flex: 1;
        }
        
        /* Admin Screen */
        #adminScreen {
            display: none;
        }
        
        .admin-controls {
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .textarea-group, .input-group-admin {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .textarea-group label, .input-group-admin label {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .textarea-group textarea, .input-group-admin input {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .textarea-group textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .textarea-group textarea:focus, .input-group-admin input:focus {
            border-color: #6a11cb;
            outline: none;
        }
        
        .admin-settings {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .admin-customization {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .admin-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }
        
        .admin-actions h3 {
            color: #dc3545;
        }
        
        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .color-picker-group label {
            flex: 1;
            font-weight: 600;
        }
        
        .color-picker-group input[type="color"] {
            width: 60px;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .color-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .color-input-group input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
        }
        
        .transparency-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        
        .transparency-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        
        .preview-box {
            width: 100%;
            height: 100px;
            border-radius: 10px;
            border: 2px dashed #ddd;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-position: center;
        }
        
        .preview-box.small {
            height: 60px;
            margin-top: 5px;
        }
        
        .preview-text {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .file-upload-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .file-upload-group input[type="file"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
        }
        
        .reset-btn {
            width: 100%;
            margin-top: 10px;
        }
        
        .color-format-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }
        
        @media (max-width: 480px) {
            .container {
                border-radius: 15px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .content {
                padding: 20px 15px;
            }
            
            .bingo-cell {
                font-size: 1rem;
            }
            
            .password-display {
                min-width: 200px;
                font-size: 1rem;
                padding: 10px 20px;
            }
            
            .admin-controls {
                max-height: 60vh;
            }
        }
    </style>
</head>
<body>
    <!-- Confirmation Dialog -->
    <div class="confirmation-dialog" id="confirmationDialog">
        <div class="confirmation-content">
            <h3><i class="fas fa-user-check"></i> Welcome Back!</h3>
            <p>Name "<span id="returningPlayerName"></span>" is already registered.</p>
            <p>Is this you? Would you like to continue with your existing cards?</p>
            
            <div class="confirmation-buttons">
                <button class="btn btn-secondary" id="confirmNewPlayerBtn">
                    <i class="fas fa-user-times"></i> No, I'm Different
                </button>
                <button class="btn btn-primary" id="confirmReturningPlayerBtn">
                    <i class="fas fa-sign-in-alt"></i> Yes, It's Me
                </button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1 id="gameTitle">Mobile Bingo</h1>
            <p id="gameSubtitle">Login to play with your unique bingo cards</p>
        </div>
        
        <div class="content">
            <!-- Login Screen -->
            <div id="loginScreen">
                <h2 id="welcomeTitle">Welcome to Bingo!</h2>
                <p id="welcomeMessage">Enter your name and password to join the game.</p>
                
                <form class="login-form" id="loginForm">
                    <div class="input-group">
                        <label for="playerName">Your Name</label>
                        <input type="text" id="playerName" placeholder="Enter your name" required autocomplete="off">
                    </div>
                    
                    <div class="input-group">
                        <label for="playerPassword">Password</label>
                        <input type="password" id="playerPassword" placeholder="Enter password" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="loginButton">
                        <i class="fas fa-sign-in-alt"></i> Join Game
                    </button>
                </form>
                
                <div class="players-count" id="playersCountBox">
                    Players joined: <span id="currentPlayers">0</span> / <span id="maxPlayers">30</span>
                </div>
            </div>
            
            <!-- Game Screen -->
            <div id="gameScreen">
                <div class="player-info">
                    <div class="player-name" id="displayPlayerName">Player</div>
                    <div class="card-counter" id="cardCounterBox">Card <span id="currentCard">1</span> of <span id="totalCards">3</span></div>
                </div>
                
                <div class="bingo-card-container" id="bingoCardContainer">
                    <div class="bingo-grid" id="bingoGrid">
                        <!-- Bingo cells will be generated here -->
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-secondary" id="prevCardBtn">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-primary" id="nextCardBtn">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Admin Screen -->
            <div id="adminScreen">
                <h2><i class="fas fa-cogs"></i> Admin Controls</h2>
                <p>For admin access, use ID: <strong>admin</strong> and Password: <strong>1234</strong></p>
                
                <div class="admin-controls">
                    <!-- Game Content Customization -->
                    <div class="admin-customization">
                        <h3><i class="fas fa-paint-brush"></i> Game Content & Text</h3>
                        
                        <div class="input-group-admin">
                            <label for="gameTitleText">Game Title</label>
                            <input type="text" id="gameTitleText" value="Mobile Bingo">
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="gameSubtitleText">Game Subtitle</label>
                            <input type="text" id="gameSubtitleText" value="Login to play with your unique bingo cards">
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="welcomeTitleText">Welcome Title</label>
                            <input type="text" id="welcomeTitleText" value="Welcome to Bingo!">
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="welcomeMessageText">Welcome Message</label>
                            <input type="text" id="welcomeMessageText" value="Enter your name and password to join the game.">
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="loginButtonText">Login Button Text</label>
                            <input type="text" id="loginButtonText" value="Join Game">
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="footerText">Footer Text</label>
                            <input type="text" id="footerText" value="Mobile Bingo Game © 2023">
                        </div>
                    </div>
                    
                    <!-- Header Background Customization -->
                    <div class="admin-customization">
                        <h3><i class="fas fa-image"></i> Header Background</h3>
                        
                        <div class="file-upload-group">
                            <label>Upload Header Background Image</label>
                            <input type="file" id="headerBackgroundUpload" accept="image/*">
                            <div class="preview-box" id="headerBackgroundPreview">
                                <div class="preview-text">Header Background Preview</div>
                            </div>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Or use solid color:</label>
                            <div class="color-input-group">
                                <input type="color" id="headerBackgroundColor" value="#6a11cb">
                                <input type="text" id="headerBackgroundColorText" value="#6a11cb" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="transparency-checkbox">
                            <input type="checkbox" id="headerTransparent">
                            <label for="headerTransparent">Make header background transparent</label>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Header Text Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="headerTextColor" value="#ffffff">
                                <input type="text" id="headerTextColorText" value="#ffffff" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <button class="btn btn-secondary reset-btn" id="resetHeaderBtn">
                            <i class="fas fa-undo"></i> Reset Header to Default
                        </button>
                    </div>
                    
                    <!-- Main Background Customization -->
                    <div class="admin-customization">
                        <h3><i class="fas fa-desktop"></i> Main Background</h3>
                        
                        <div class="file-upload-group">
                            <label>Upload Main Background Image</label>
                            <input type="file" id="mainBackgroundUpload" accept="image/*">
                            <div class="preview-box" id="mainBackgroundPreview">
                                <div class="preview-text">Main Background Preview</div>
                            </div>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Or use solid color:</label>
                            <div class="color-input-group">
                                <input type="color" id="mainBackgroundColor" value="#f5f5f5">
                                <input type="text" id="mainBackgroundColorText" value="#f5f5f5" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="transparency-checkbox">
                            <input type="checkbox" id="mainTransparent">
                            <label for="mainTransparent">Make main background transparent</label>
                        </div>
                        
                        <button class="btn btn-secondary reset-btn" id="resetMainBackgroundBtn">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                    </div>
                    
                    <!-- Card Background Customization -->
                    <div class="admin-customization">
                        <h3><i class="fas fa-th"></i> Bingo Card Background</h3>
                        
                        <div class="file-upload-group">
                            <label>Upload Card Background Image</label>
                            <input type="file" id="cardBackgroundUpload" accept="image/*">
                            <div class="preview-box" id="cardBackgroundPreview">
                                <div class="preview-text">Card Background Preview</div>
                            </div>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Card Container Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="cardBackgroundColor" value="#f8f9fa">
                                <input type="text" id="cardBackgroundColorText" value="#f8f9fa" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Number Cell Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="cellBackgroundColor" value="#ffffff">
                                <input type="text" id="cellBackgroundColorText" value="#ffffff" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Marked Cell Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="markedCellColor" value="#6a11cb">
                                <input type="text" id="markedCellColorText" value="#6a11cb" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Free Cell Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="freeCellColor" value="#ffd166">
                                <input type="text" id="freeCellColorText" value="#ffd166" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <button class="btn btn-secondary reset-btn" id="resetCardBackgroundBtn">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                    </div>
                    
                    <!-- Button Colors Customization -->
                    <div class="admin-customization">
                        <h3><i class="fas fa-square"></i> Button Colors</h3>
                        
                        <div class="color-picker-group">
                            <label>Primary Button Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="primaryButtonColor" value="#6a11cb">
                                <input type="text" id="primaryButtonColorText" value="#6a11cb" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Secondary Button Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="secondaryButtonColor" value="#f0f0f0">
                                <input type="text" id="secondaryButtonColorText" value="#f0f0f0" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Danger Button Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="dangerButtonColor" value="#dc3545">
                                <input type="text" id="dangerButtonColorText" value="#dc3545" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Button Text Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="buttonTextColor" value="#ffffff">
                                <input type="text" id="buttonTextColorText" value="#ffffff" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="preview-box small" id="buttonPreview">
                            <div style="display: flex; gap: 10px;">
                                <button style="padding: 8px 16px; border: none; border-radius: 5px; background-color: #6a11cb; color: white;">Primary</button>
                                <button style="padding: 8px 16px; border: none; border-radius: 5px; background-color: #f0f0f0; color: #333;">Secondary</button>
                                <button style="padding: 8px 16px; border: none; border-radius: 5px; background-color: #dc3545; color: white;">Danger</button>
                            </div>
                        </div>
                        
                        <button class="btn btn-secondary reset-btn" id="resetButtonsBtn">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                    </div>
                    
                    <!-- Game Settings -->
                    <div class="admin-settings">
                        <h3><i class="fas fa-sliders-h"></i> Game Settings</h3>
                        
                        <div class="input-group-admin">
                            <label for="playerList">Authorized Player Names (comma-separated)</label>
                            <textarea id="playerList" placeholder="Enter player names, e.g., Calvin, JF, Cindy, PIG">Calvin, JF, Cindy, PIG</textarea>
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="maxPlayers">Maximum Players (1-100)</label>
                            <input type="number" id="maxPlayers" min="1" max="100" value="30">
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="cardsPerPlayer">Cards per Player (1-10)</label>
                            <input type="number" id="cardsPerPlayer" min="1" max="10" value="3">
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="playerPasswordSetting">Player Login Password</label>
                            <input type="text" id="playerPasswordSetting" value="8888">
                        </div>
                    </div>
                    
                    <!-- Admin Actions -->
                    <div class="admin-actions">
                        <h3><i class="fas fa-exclamation-triangle"></i> Admin Actions</h3>
                        
                        <button class="btn btn-danger" id="clearPlayerDataBtn">
                            <i class="fas fa-trash-alt"></i> Clear All Player Data
                        </button>
                        
                        <p style="font-size: 0.9rem; color: #666;">
                            This will remove all player cards and Lucky 4D numbers. Authorized player list will be preserved.
                        </p>
                    </div>
                    
                    <button class="btn btn-primary" id="saveSettingsBtn">
                        <i class="fas fa-save"></i> Save All Settings
                    </button>
                    
                    <button class="btn btn-secondary" id="adminLogoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Exit Admin
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lucky 4D Number Display (Fixed at bottom center) -->
    <div class="password-display" id="passwordDisplay">
        Lucky 4D Number: <span id="luckyNumber">XXXX</span>
    </div>
    
    <div class="footer" id="gameFooter">
        <p>Mobile Bingo Game &copy; 2023</p>
    </div>

    <script>
        // ==================== GAME STATE ====================
        
        let gameState = {
            players: [],
            currentPlayer: null,
            currentCardIndex: 0,
            settings: {
                maxPlayers: 30,
                cardsPerPlayer: 3,
                defaultPassword: "8888",
                authorizedPlayers: ["Calvin", "JF", "Cindy", "PIG"],
                customization: {
                    // Header
                    headerBackgroundImage: null,
                    headerBackgroundColor: "#6a11cb",
                    headerTextColor: "#ffffff",
                    headerTransparent: false,
                    
                    // Main background
                    mainBackgroundImage: null,
                    mainBackgroundColor: "#f5f5f5",
                    mainTransparent: false,
                    
                    // Card background
                    cardBackgroundImage: null,
                    cardBackgroundColor: "#f8f9fa",
                    cellBackgroundColor: "#ffffff",
                    markedCellColor: "#6a11cb",
                    freeCellColor: "#ffd166",
                    
                    // Buttons
                    primaryButtonColor: "#6a11cb",
                    secondaryButtonColor: "#f0f0f0",
                    dangerButtonColor: "#dc3545",
                    buttonTextColor: "#ffffff",
                    
                    // Text content
                    gameTitle: "Mobile Bingo",
                    gameSubtitle: "Login to play with your unique bingo cards",
                    welcomeTitle: "Welcome to Bingo!",
                    welcomeMessage: "Enter your name and password to join the game.",
                    loginButtonText: "Join Game",
                    footerText: "Mobile Bingo Game © 2023"
                }
            }
        };
        
        const ADMIN_CREDENTIALS = {
            id: "admin",
            password: "1234"
        };
        
        // Variables to track login attempts
        let pendingLoginName = '';
        let existingPlayerFound = null;
        
        // ==================== GAME FUNCTIONS ====================
        
        function generateBingoCards(count) {
            const cards = [];
            const ranges = {
                B: [1, 15],
                I: [16, 30],
                N: [31, 45],
                G: [46, 60],
                O: [61, 75]
            };
            
            for (let cardId = 1; cardId <= count; cardId++) {
                const card = { id: cardId, numbers: {} };
                
                for (let col = 0; col < 5; col++) {
                    const letter = Object.keys(ranges)[col];
                    const [min, max] = ranges[letter];
                    const columnNumbers = [];
                    
                    while (columnNumbers.length < 5) {
                        const num = Math.floor(Math.random() * (max - min + 1)) + min;
                        if (!columnNumbers.includes(num)) {
                            columnNumbers.push(num);
                        }
                    }
                    
                    card.numbers[letter] = columnNumbers;
                }
                
                card.numbers.N[2] = "FREE";
                cards.push(card);
            }
            
            return cards;
        }
        
        function generate4DPassword() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }
        
        function assignCardsToPlayer(player, cardsPool, count) {
            const assignedCards = [];
            const cardsToAssign = count || gameState.settings.cardsPerPlayer;
            
            const availableCards = cardsPool.filter(card => 
                !gameState.players.some(p => 
                    p !== player && p.cards && p.cards.some(c => c.id === card.id)
                )
            );
            
            const cardsToUse = availableCards.length >= cardsToAssign ? availableCards : cardsPool;
            
            if (player.cards && player.cards.length > 0) {
                assignedCards.push(...player.cards.slice(0, Math.min(cardsToAssign, player.cards.length)));
            }
            
            for (let i = assignedCards.length; i < cardsToAssign; i++) {
                if (cardsToUse.length === 0) {
                    const newCard = generateNewBingoCard();
                    assignedCards.push(newCard);
                    continue;
                }
                
                const randomIndex = Math.floor(Math.random() * cardsToUse.length);
                const selectedCard = cardsToUse[randomIndex];
                assignedCards.push(selectedCard);
                cardsToUse.splice(randomIndex, 1);
            }
            
            player.cards = assignedCards;
            return assignedCards;
        }
        
        function generateNewBingoCard() {
            const ranges = {
                B: [1, 15],
                I: [16, 30],
                N: [31, 45],
                G: [46, 60],
                O: [61, 75]
            };
            
            const card = { id: Date.now(), numbers: {} };
            
            for (let col = 0; col < 5; col++) {
                const letter = Object.keys(ranges)[col];
                const [min, max] = ranges[letter];
                const columnNumbers = [];
                
                while (columnNumbers.length < 5) {
                    const num = Math.floor(Math.random() * (max - min + 1)) + min;
                    if (!columnNumbers.includes(num)) {
                        columnNumbers.push(num);
                    }
                }
                
                card.numbers[letter] = columnNumbers;
            }
            
            card.numbers.N[2] = "FREE";
            return card;
        }
        
        function updatePlayerCardsForAllPlayers(newCardsPerPlayer) {
            const totalCardsNeeded = gameState.settings.maxPlayers * newCardsPerPlayer;
            const cardsPool = generateBingoCards(totalCardsNeeded);
            
            gameState.players.forEach(player => {
                if (!player.luckyNumber) {
                    player.luckyNumber = generate4DPassword();
                }
                
                assignCardsToPlayer(player, cardsPool, newCardsPerPlayer);
            });
            
            if (gameState.currentPlayer) {
                const currentPlayerUpdated = gameState.players.find(p => 
                    p.name.toLowerCase() === gameState.currentPlayer.name.toLowerCase()
                );
                
                if (currentPlayerUpdated) {
                    gameState.currentPlayer = currentPlayerUpdated;
                    document.getElementById('displayPlayerName').textContent = currentPlayerUpdated.name;
                    document.getElementById('totalCards').textContent = currentPlayerUpdated.cards.length;
                    
                    if (gameState.currentCardIndex >= currentPlayerUpdated.cards.length) {
                        gameState.currentCardIndex = Math.max(0, currentPlayerUpdated.cards.length - 1);
                    }
                    
                    updateCardDisplay();
                    updatePasswordDisplay();
                }
            }
            
            saveGameState();
        }
        
        function updateCardDisplay() {
            if (!gameState.currentPlayer || !gameState.currentPlayer.cards) return;
            
            const card = gameState.currentPlayer.cards[gameState.currentCardIndex];
            if (!card) return;
            
            const bingoGrid = document.getElementById('bingoGrid');
            const currentCardSpan = document.getElementById('currentCard');
            
            currentCardSpan.textContent = gameState.currentCardIndex + 1;
            bingoGrid.innerHTML = '';
            
            const letters = ['B', 'I', 'N', 'G', 'O'];
            
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    const cell = document.createElement('div');
                    const letter = letters[col];
                    const number = card.numbers[letter][row];
                    
                    cell.className = 'bingo-cell';
                    cell.textContent = number;
                    
                    // Apply cell background color
                    cell.style.backgroundColor = gameState.settings.customization.cellBackgroundColor;
                    
                    if (col === 2 && row === 2) {
                        cell.classList.add('free');
                        cell.style.backgroundColor = gameState.settings.customization.freeCellColor;
                    }
                    
                    cell.addEventListener('click', function() {
                        if (!this.classList.contains('free')) {
                            this.classList.toggle('marked');
                            if (this.classList.contains('marked')) {
                                this.style.backgroundColor = gameState.settings.customization.markedCellColor;
                                this.style.color = gameState.settings.customization.buttonTextColor;
                            } else {
                                this.style.backgroundColor = gameState.settings.customization.cellBackgroundColor;
                                this.style.color = '#333';
                            }
                        }
                    });
                    
                    bingoGrid.appendChild(cell);
                }
            }
        }
        
        function updatePasswordDisplay() {
            const passwordDisplay = document.getElementById('passwordDisplay');
            const luckyNumberSpan = document.getElementById('luckyNumber');
            
            if (gameState.currentPlayer && gameState.currentPlayer.luckyNumber) {
                passwordDisplay.style.display = 'block';
                luckyNumberSpan.textContent = gameState.currentPlayer.luckyNumber;
            } else {
                passwordDisplay.style.display = 'none';
            }
        }
        
        function clearAllPlayerData() {
            gameState.players = [];
            gameState.currentPlayer = null;
            gameState.currentCardIndex = 0;
            
            updatePlayersCount();
            saveGameState();
            
            showCustomAlert(`
                <strong>All player data has been cleared!</strong><br><br>
                • Player cards removed<br>
                • Lucky 4D numbers reset<br>
                • Authorized player list preserved<br><br>
                Players will receive new cards and Lucky 4D numbers on next login.
            `);
        }
        
        // ==================== COLOR VALIDATION FUNCTIONS ====================
        
        function isValidHexColor(color) {
            return /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(color);
        }
        
        function updateColorInputFromPicker(pickerId, textId) {
            const picker = document.getElementById(pickerId);
            const textInput = document.getElementById(textId);
            
            picker.addEventListener('input', function() {
                textInput.value = this.value;
            });
            
            textInput.addEventListener('input', function() {
                const color = this.value.trim();
                if (isValidHexColor(color)) {
                    picker.value = color;
                }
            });
            
            textInput.addEventListener('blur', function() {
                const color = this.value.trim();
                if (!isValidHexColor(color) && color !== '') {
                    showCustomAlert('Invalid color format. Please use #RRGGBB format (e.g., #FF0000 for red).');
                    this.value = picker.value;
                }
            });
        }
        
        // ==================== CUSTOMIZATION FUNCTIONS ====================
        
        function applyCustomizations() {
            const customization = gameState.settings.customization;
            
            // Apply header background
            const header = document.querySelector('.header');
            if (customization.headerTransparent) {
                header.style.background = 'transparent';
            } else if (customization.headerBackgroundImage) {
                header.style.background = `url('${customization.headerBackgroundImage}')`;
                header.style.backgroundSize = 'cover';
                header.style.backgroundPosition = 'center';
            } else {
                header.style.background = customization.headerBackgroundColor;
            }
            
            // Apply header text color
            header.style.color = customization.headerTextColor;
            
            // Apply main background
            if (customization.mainTransparent) {
                document.body.style.backgroundColor = 'transparent';
                document.body.style.backgroundImage = 'none';
            } else if (customization.mainBackgroundImage) {
                document.body.style.backgroundColor = 'transparent';
                document.body.style.backgroundImage = `url('${customization.mainBackgroundImage}')`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundAttachment = 'fixed';
            } else {
                document.body.style.backgroundImage = 'none';
                document.body.style.backgroundColor = customization.mainBackgroundColor;
            }
            
            // Apply card container background
            const cardContainer = document.getElementById('bingoCardContainer');
            if (customization.cardBackgroundImage) {
                cardContainer.style.background = `url('${customization.cardBackgroundImage}')`;
                cardContainer.style.backgroundSize = 'cover';
                cardContainer.style.backgroundPosition = 'center';
            } else {
                cardContainer.style.backgroundColor = customization.cardBackgroundColor;
            }
            
            // Apply button colors
            const primaryButtons = document.querySelectorAll('.btn-primary');
            primaryButtons.forEach(btn => {
                btn.style.backgroundColor = customization.primaryButtonColor;
                btn.style.color = customization.buttonTextColor;
            });
            
            const secondaryButtons = document.querySelectorAll('.btn-secondary');
            secondaryButtons.forEach(btn => {
                btn.style.backgroundColor = customization.secondaryButtonColor;
                btn.style.color = '#333';
            });
            
            const dangerButtons = document.querySelectorAll('.btn-danger');
            dangerButtons.forEach(btn => {
                btn.style.backgroundColor = customization.dangerButtonColor;
                btn.style.color = customization.buttonTextColor;
            });
            
            // Update text content
            document.getElementById('gameTitle').textContent = customization.gameTitle;
            document.getElementById('gameSubtitle').textContent = customization.gameSubtitle;
            document.getElementById('welcomeTitle').textContent = customization.welcomeTitle;
            document.getElementById('welcomeMessage').textContent = customization.welcomeMessage;
            document.getElementById('gameFooter').innerHTML = `<p>${customization.footerText}</p>`;
            
            const loginButton = document.getElementById('loginButton');
            if (loginButton) {
                loginButton.innerHTML = `<i class="fas fa-sign-in-alt"></i> ${customization.loginButtonText}`;
            }
            
            // Update card display if player is logged in
            if (gameState.currentPlayer) {
                updateCardDisplay();
            }
        }
        
        function loadImageAsBase64(fileInput, callback) {
            const file = fileInput.files[0];
            if (!file) {
                callback(null);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                callback(e.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        function updatePreview(elementId, imageData, isColor = false) {
            const preview = document.getElementById(elementId);
            if (!preview) return;
            
            if (isColor) {
                preview.style.background = imageData;
                preview.style.backgroundImage = 'none';
            } else if (imageData) {
                preview.style.backgroundImage = `url('${imageData}')`;
                preview.style.backgroundSize = 'cover';
                preview.style.backgroundPosition = 'center';
            } else {
                preview.style.background = '#f0f0f0';
                preview.style.backgroundImage = 'none';
            }
        }
        
        function loadCustomizationSettings() {
            const customization = gameState.settings.customization;
            
            // Load text fields
            document.getElementById('gameTitleText').value = customization.gameTitle;
            document.getElementById('gameSubtitleText').value = customization.gameSubtitle;
            document.getElementById('welcomeTitleText').value = customization.welcomeTitle;
            document.getElementById('welcomeMessageText').value = customization.welcomeMessage;
            document.getElementById('loginButtonText').value = customization.loginButtonText;
            document.getElementById('footerText').value = customization.footerText;
            
            // Load color pickers and text inputs
            document.getElementById('headerBackgroundColor').value = customization.headerBackgroundColor;
            document.getElementById('headerBackgroundColorText').value = customization.headerBackgroundColor;
            document.getElementById('headerTextColor').value = customization.headerTextColor;
            document.getElementById('headerTextColorText').value = customization.headerTextColor;
            document.getElementById('headerTransparent').checked = customization.headerTransparent;
            
            document.getElementById('mainBackgroundColor').value = customization.mainBackgroundColor;
            document.getElementById('mainBackgroundColorText').value = customization.mainBackgroundColor;
            document.getElementById('mainTransparent').checked = customization.mainTransparent;
            
            document.getElementById('cardBackgroundColor').value = customization.cardBackgroundColor;
            document.getElementById('cardBackgroundColorText').value = customization.cardBackgroundColor;
            document.getElementById('cellBackgroundColor').value = customization.cellBackgroundColor;
            document.getElementById('cellBackgroundColorText').value = customization.cellBackgroundColor;
            document.getElementById('markedCellColor').value = customization.markedCellColor;
            document.getElementById('markedCellColorText').value = customization.markedCellColor;
            document.getElementById('freeCellColor').value = customization.freeCellColor;
            document.getElementById('freeCellColorText').value = customization.freeCellColor;
            
            document.getElementById('primaryButtonColor').value = customization.primaryButtonColor;
            document.getElementById('primaryButtonColorText').value = customization.primaryButtonColor;
            document.getElementById('secondaryButtonColor').value = customization.secondaryButtonColor;
            document.getElementById('secondaryButtonColorText').value = customization.secondaryButtonColor;
            document.getElementById('dangerButtonColor').value = customization.dangerButtonColor;
            document.getElementById('dangerButtonColorText').value = customization.dangerButtonColor;
            document.getElementById('buttonTextColor').value = customization.buttonTextColor;
            document.getElementById('buttonTextColorText').value = customization.buttonTextColor;
            
            // Update previews
            updatePreview('headerBackgroundPreview', customization.headerBackgroundImage);
            updatePreview('mainBackgroundPreview', customization.mainBackgroundImage);
            updatePreview('cardBackgroundPreview', customization.cardBackgroundImage);
        }
        
        // ==================== UI FUNCTIONS ====================
        
        function showScreen(screenId) {
            ['loginScreen', 'gameScreen', 'adminScreen'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = id === screenId ? 'block' : 'none';
                }
            });
        }
        
        function updatePlayersCount() {
            const currentPlayersElement = document.getElementById('currentPlayers');
            const maxPlayersElement = document.getElementById('maxPlayers');
            
            if (currentPlayersElement) {
                currentPlayersElement.textContent = gameState.players.length;
            }
            if (maxPlayersElement) {
                maxPlayersElement.textContent = gameState.settings.maxPlayers;
            }
        }
        
        function showConfirmationDialog(playerName) {
            document.getElementById('returningPlayerName').textContent = playerName;
            document.getElementById('confirmationDialog').style.display = 'flex';
        }
        
        function hideConfirmationDialog() {
            document.getElementById('confirmationDialog').style.display = 'none';
        }
        
        function showCustomAlert(message, isFirstTime = false) {
            const dialog = document.createElement('div');
            dialog.className = 'confirmation-dialog';
            dialog.style.display = 'flex';
            
            const content = document.createElement('div');
            content.className = 'confirmation-content';
            
            let icon = '<i class="fas fa-info-circle"></i>';
            let title = 'Information';
            let buttons = `
                <div class="confirmation-buttons">
                    <button class="btn btn-primary" id="customAlertOkBtn">
                        OK
                    </button>
                </div>
            `;
            
            if (isFirstTime) {
                icon = '<i class="fas fa-gift"></i>';
                title = 'Welcome!';
                buttons = `
                    <div class="confirmation-buttons">
                        <button class="btn btn-primary" id="customAlertOkBtn">
                            <i class="fas fa-thumbs-up"></i> Got it!
                        </button>
                    </div>
                `;
            }
            
            content.innerHTML = `
                <h3>${icon} ${title}</h3>
                <div style="text-align: left; line-height: 1.6;">
                    ${message}
                </div>
                ${buttons}
            `;
            
            dialog.appendChild(content);
            document.body.appendChild(dialog);
            
            document.getElementById('customAlertOkBtn').addEventListener('click', function() {
                document.body.removeChild(dialog);
            });
        }
        
        // ==================== EVENT HANDLERS ====================
        
        function setupEventListeners() {
            // Login form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            // Navigation buttons
            const prevBtn = document.getElementById('prevCardBtn');
            const nextBtn = document.getElementById('nextCardBtn');
            if (prevBtn) prevBtn.addEventListener('click', showPrevCard);
            if (nextBtn) nextBtn.addEventListener('click', showNextCard);
            
            // Admin logout button
            const adminLogoutBtn = document.getElementById('adminLogoutBtn');
            if (adminLogoutBtn) adminLogoutBtn.addEventListener('click', handleAdminLogout);
            
            // Confirmation dialog buttons
            document.getElementById('confirmReturningPlayerBtn').addEventListener('click', function() {
                hideConfirmationDialog();
                loginAsReturningPlayer();
            });
            
            document.getElementById('confirmNewPlayerBtn').addEventListener('click', function() {
                hideConfirmationDialog();
                const playerNameInput = document.getElementById('playerName');
                const playerPasswordInput = document.getElementById('playerPassword');
                if (playerNameInput) {
                    playerNameInput.value = '';
                    playerNameInput.focus();
                }
                if (playerPasswordInput) {
                    playerPasswordInput.value = '';
                }
            });
            
            // Admin controls
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', saveAdminSettings);
            }
            
            // Clear player data button
            const clearPlayerDataBtn = document.getElementById('clearPlayerDataBtn');
            if (clearPlayerDataBtn) {
                clearPlayerDataBtn.addEventListener('click', confirmClearPlayerData);
            }
            
            // File upload handlers
            document.getElementById('headerBackgroundUpload').addEventListener('change', function() {
                loadImageAsBase64(this, function(base64) {
                    gameState.settings.customization.headerBackgroundImage = base64;
                    gameState.settings.customization.headerTransparent = false;
                    document.getElementById('headerTransparent').checked = false;
                    updatePreview('headerBackgroundPreview', base64);
                });
            });
            
            document.getElementById('mainBackgroundUpload').addEventListener('change', function() {
                loadImageAsBase64(this, function(base64) {
                    gameState.settings.customization.mainBackgroundImage = base64;
                    gameState.settings.customization.mainTransparent = false;
                    document.getElementById('mainTransparent').checked = false;
                    updatePreview('mainBackgroundPreview', base64);
                });
            });
            
            document.getElementById('cardBackgroundUpload').addEventListener('change', function() {
                loadImageAsBase64(this, function(base64) {
                    gameState.settings.customization.cardBackgroundImage = base64;
                    updatePreview('cardBackgroundPreview', base64);
                });
            });
            
            // Setup color input synchronization
            updateColorInputFromPicker('headerBackgroundColor', 'headerBackgroundColorText');
            updateColorInputFromPicker('headerTextColor', 'headerTextColorText');
            updateColorInputFromPicker('mainBackgroundColor', 'mainBackgroundColorText');
            updateColorInputFromPicker('cardBackgroundColor', 'cardBackgroundColorText');
            updateColorInputFromPicker('cellBackgroundColor', 'cellBackgroundColorText');
            updateColorInputFromPicker('markedCellColor', 'markedCellColorText');
            updateColorInputFromPicker('freeCellColor', 'freeCellColorText');
            updateColorInputFromPicker('primaryButtonColor', 'primaryButtonColorText');
            updateColorInputFromPicker('secondaryButtonColor', 'secondaryButtonColorText');
            updateColorInputFromPicker('dangerButtonColor', 'dangerButtonColorText');
            updateColorInputFromPicker('buttonTextColor', 'buttonTextColorText');
            
            // Color picker handlers
            document.getElementById('headerBackgroundColor').addEventListener('change', function() {
                gameState.settings.customization.headerBackgroundImage = null;
                gameState.settings.customization.headerBackgroundColor = this.value;
                gameState.settings.customization.headerTransparent = false;
                document.getElementById('headerTransparent').checked = false;
                updatePreview('headerBackgroundPreview', this.value, true);
            });
            
            document.getElementById('headerTextColor').addEventListener('change', function() {
                gameState.settings.customization.headerTextColor = this.value;
            });
            
            document.getElementById('headerTransparent').addEventListener('change', function() {
                gameState.settings.customization.headerTransparent = this.checked;
                if (this.checked) {
                    gameState.settings.customization.headerBackgroundImage = null;
                }
            });
            
            document.getElementById('mainBackgroundColor').addEventListener('change', function() {
                gameState.settings.customization.mainBackgroundImage = null;
                gameState.settings.customization.mainBackgroundColor = this.value;
                gameState.settings.customization.mainTransparent = false;
                document.getElementById('mainTransparent').checked = false;
                updatePreview('mainBackgroundPreview', this.value, true);
            });
            
            document.getElementById('mainTransparent').addEventListener('change', function() {
                gameState.settings.customization.mainTransparent = this.checked;
                if (this.checked) {
                    gameState.settings.customization.mainBackgroundImage = null;
                }
            });
            
            document.getElementById('cardBackgroundColor').addEventListener('change', function() {
                gameState.settings.customization.cardBackgroundImage = null;
                gameState.settings.customization.cardBackgroundColor = this.value;
                updatePreview('cardBackgroundPreview', this.value, true);
            });
            
            document.getElementById('cellBackgroundColor').addEventListener('change', function() {
                gameState.settings.customization.cellBackgroundColor = this.value;
            });
            
            document.getElementById('markedCellColor').addEventListener('change', function() {
                gameState.settings.customization.markedCellColor = this.value;
            });
            
            document.getElementById('freeCellColor').addEventListener('change', function() {
                gameState.settings.customization.freeCellColor = this.value;
            });
            
            document.getElementById('primaryButtonColor').addEventListener('change', function() {
                gameState.settings.customization.primaryButtonColor = this.value;
            });
            
            document.getElementById('secondaryButtonColor').addEventListener('change', function() {
                gameState.settings.customization.secondaryButtonColor = this.value;
            });
            
            document.getElementById('dangerButtonColor').addEventListener('change', function() {
                gameState.settings.customization.dangerButtonColor = this.value;
            });
            
            document.getElementById('buttonTextColor').addEventListener('change', function() {
                gameState.settings.customization.buttonTextColor = this.value;
            });
            
            // Text field handlers
            document.getElementById('gameTitleText').addEventListener('change', function() {
                gameState.settings.customization.gameTitle = this.value;
            });
            
            document.getElementById('gameSubtitleText').addEventListener('change', function() {
                gameState.settings.customization.gameSubtitle = this.value;
            });
            
            document.getElementById('welcomeTitleText').addEventListener('change', function() {
                gameState.settings.customization.welcomeTitle = this.value;
            });
            
            document.getElementById('welcomeMessageText').addEventListener('change', function() {
                gameState.settings.customization.welcomeMessage = this.value;
            });
            
            document.getElementById('loginButtonText').addEventListener('change', function() {
                gameState.settings.customization.loginButtonText = this.value;
            });
            
            document.getElementById('footerText').addEventListener('change', function() {
                gameState.settings.customization.footerText = this.value;
            });
            
            // Reset buttons
            document.getElementById('resetHeaderBtn').addEventListener('click', function() {
                gameState.settings.customization.headerBackgroundImage = null;
                gameState.settings.customization.headerBackgroundColor = "#6a11cb";
                gameState.settings.customization.headerTextColor = "#ffffff";
                gameState.settings.customization.headerTransparent = false;
                
                document.getElementById('headerBackgroundColor').value = "#6a11cb";
                document.getElementById('headerBackgroundColorText').value = "#6a11cb";
                document.getElementById('headerTextColor').value = "#ffffff";
                document.getElementById('headerTextColorText').value = "#ffffff";
                document.getElementById('headerTransparent').checked = false;
                
                updatePreview('headerBackgroundPreview', "#6a11cb", true);
            });
            
            document.getElementById('resetMainBackgroundBtn').addEventListener('click', function() {
                gameState.settings.customization.mainBackgroundImage = null;
                gameState.settings.customization.mainBackgroundColor = "#f5f5f5";
                gameState.settings.customization.mainTransparent = false;
                
                document.getElementById('mainBackgroundColor').value = "#f5f5f5";
                document.getElementById('mainBackgroundColorText').value = "#f5f5f5";
                document.getElementById('mainTransparent').checked = false;
                
                updatePreview('mainBackgroundPreview', "#f5f5f5", true);
            });
            
            document.getElementById('resetCardBackgroundBtn').addEventListener('click', function() {
                gameState.settings.customization.cardBackgroundImage = null;
                gameState.settings.customization.cardBackgroundColor = "#f8f9fa";
                gameState.settings.customization.cellBackgroundColor = "#ffffff";
                gameState.settings.customization.markedCellColor = "#6a11cb";
                gameState.settings.customization.freeCellColor = "#ffd166";
                
                document.getElementById('cardBackgroundColor').value = "#f8f9fa";
                document.getElementById('cardBackgroundColorText').value = "#f8f9fa";
                document.getElementById('cellBackgroundColor').value = "#ffffff";
                document.getElementById('cellBackgroundColorText').value = "#ffffff";
                document.getElementById('markedCellColor').value = "#6a11cb";
                document.getElementById('markedCellColorText').value = "#6a11cb";
                document.getElementById('freeCellColor').value = "#ffd166";
                document.getElementById('freeCellColorText').value = "#ffd166";
                
                updatePreview('cardBackgroundPreview', "#f8f9fa", true);
            });
            
            document.getElementById('resetButtonsBtn').addEventListener('click', function() {
                gameState.settings.customization.primaryButtonColor = "#6a11cb";
                gameState.settings.customization.secondaryButtonColor = "#f0f0f0";
                gameState.settings.customization.dangerButtonColor = "#dc3545";
                gameState.settings.customization.buttonTextColor = "#ffffff";
                
                document.getElementById('primaryButtonColor').value = "#6a11cb";
                document.getElementById('primaryButtonColorText').value = "#6a11cb";
                document.getElementById('secondaryButtonColor').value = "#f0f0f0";
                document.getElementById('secondaryButtonColorText').value = "#f0f0f0";
                document.getElementById('dangerButtonColor').value = "#dc3545";
                document.getElementById('dangerButtonColorText').value = "#dc3545";
                document.getElementById('buttonTextColor').value = "#ffffff";
                document.getElementById('buttonTextColorText').value = "#ffffff";
            });
        }
        
        // ==================== GAME LOGIC FUNCTIONS ====================
        
        function handleLogin(e) {
            e.preventDefault();
            
            const playerNameInput = document.getElementById('playerName');
            const playerPasswordInput = document.getElementById('playerPassword');
            const playerName = playerNameInput ? playerNameInput.value.trim() : '';
            const password = playerPasswordInput ? playerPasswordInput.value.trim() : '';
            
            if (!playerName) {
                showCustomAlert('Please enter your name');
                return;
            }
            
            if (!password) {
                showCustomAlert('Please enter your password');
                return;
            }
            
            // Check for admin login
            if (playerName.toLowerCase() === ADMIN_CREDENTIALS.id) {
                if (password === ADMIN_CREDENTIALS.password) {
                    showScreen('adminScreen');
                    // Load current settings into admin panel
                    loadAdminSettings();
                    if (playerNameInput) playerNameInput.value = '';
                    if (playerPasswordInput) playerPasswordInput.value = '';
                } else {
                    showCustomAlert('Invalid admin password');
                }
                return;
            }
            
            // Check if player name is authorized (case-insensitive)
            const isAuthorized = gameState.settings.authorizedPlayers.some(name => 
                name.trim().toLowerCase() === playerName.toLowerCase()
            );
            
            if (!isAuthorized) {
                showCustomAlert(`Sorry, "${playerName}" is not on the authorized players list.`);
                return;
            }
            
            // Check password
            if (password !== gameState.settings.defaultPassword) {
                showCustomAlert('Incorrect password. Please try again.');
                return;
            }
            
            // Store the name being attempted
            pendingLoginName = playerName;
            
            // Check if name already exists (case-insensitive)
            existingPlayerFound = gameState.players.find(p => 
                p.name.toLowerCase() === playerName.toLowerCase()
            );
            
            if (existingPlayerFound) {
                // Player exists, show confirmation dialog
                showConfirmationDialog(playerName);
            } else {
                // New player, create account
                createNewPlayer(playerName);
            }
            
            // Clear input fields
            if (playerNameInput) playerNameInput.value = '';
            if (playerPasswordInput) playerPasswordInput.value = '';
        }
        
        function loginAsReturningPlayer() {
            if (!existingPlayerFound) return;
            
            gameState.currentPlayer = existingPlayerFound;
            gameState.currentCardIndex = 0;
            
            document.getElementById('displayPlayerName').textContent = existingPlayerFound.name;
            document.getElementById('totalCards').textContent = existingPlayerFound.cards.length;
            updateCardDisplay();
            updatePasswordDisplay();
            showScreen('gameScreen');
            
            // Reset tracking variables
            pendingLoginName = '';
            existingPlayerFound = null;
        }
        
        function createNewPlayer(playerName) {
            // Check player limit
            if (gameState.players.length >= gameState.settings.maxPlayers) {
                showCustomAlert(`Sorry, the game is full! Maximum ${gameState.settings.maxPlayers} players allowed.`);
                return;
            }
            
            // Generate cards pool (enough for all potential players)
            const totalCardsNeeded = gameState.settings.maxPlayers * gameState.settings.cardsPerPlayer;
            const cardsPool = generateBingoCards(totalCardsNeeded);
            
            // Generate a Lucky 4D number
            const luckyNumber = generate4DPassword();
            
            // Create player
            const newPlayer = {
                id: gameState.players.length + 1,
                name: playerName,
                luckyNumber: luckyNumber,
                cards: []
            };
            
            // Assign cards
            assignCardsToPlayer(newPlayer, cardsPool, gameState.settings.cardsPerPlayer);
            
            // Add to game state
            gameState.players.push(newPlayer);
            gameState.currentPlayer = newPlayer;
            gameState.currentCardIndex = 0;
            
            // Update UI
            document.getElementById('displayPlayerName').textContent = newPlayer.name;
            document.getElementById('totalCards').textContent = newPlayer.cards.length;
            updateCardDisplay();
            updatePasswordDisplay();
            updatePlayersCount();
            showScreen('gameScreen');
            
            // Save to localStorage
            saveGameState();
            
            // Show welcome message with Lucky 4D number
            const welcomeMessage = `
                <strong>Welcome ${playerName}!</strong><br><br>
                You have received ${newPlayer.cards.length} BINGO cards.<br><br>
                <strong>Your Lucky 4D number: ${luckyNumber}</strong><br><br>
                Good luck and have fun!
            `;
            
            showCustomAlert(welcomeMessage, true);
        }
        
        function loadAdminSettings() {
            // Load current settings into admin panel
            const playerListTextarea = document.getElementById('playerList');
            const maxPlayersInput = document.getElementById('maxPlayers');
            const cardsPerPlayerInput = document.getElementById('cardsPerPlayer');
            const playerPasswordSettingInput = document.getElementById('playerPasswordSetting');
            
            if (playerListTextarea) {
                playerListTextarea.value = gameState.settings.authorizedPlayers.join(', ');
            }
            if (maxPlayersInput) {
                maxPlayersInput.value = gameState.settings.maxPlayers;
            }
            if (cardsPerPlayerInput) {
                cardsPerPlayerInput.value = gameState.settings.cardsPerPlayer;
            }
            if (playerPasswordSettingInput) {
                playerPasswordSettingInput.value = gameState.settings.defaultPassword;
            }
            
            // Load customization settings
            loadCustomizationSettings();
        }
        
        function saveAdminSettings() {
            const playerListTextarea = document.getElementById('playerList');
            const maxPlayersInput = document.getElementById('maxPlayers');
            const cardsPerPlayerInput = document.getElementById('cardsPerPlayer');
            const playerPasswordSettingInput = document.getElementById('playerPasswordSetting');
            
            if (!playerListTextarea || !maxPlayersInput || !cardsPerPlayerInput || !playerPasswordSettingInput) return;
            
            // Get player list
            const playerListText = playerListTextarea.value.trim();
            const playerNames = playerListText.split(',')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            
            // Get max players (1-100)
            let maxPlayers = parseInt(maxPlayersInput.value);
            if (isNaN(maxPlayers) || maxPlayers < 1) maxPlayers = 1;
            if (maxPlayers > 100) maxPlayers = 100;
            
            // Get cards per player (1-10)
            let cardsPerPlayer = parseInt(cardsPerPlayerInput.value);
            if (isNaN(cardsPerPlayer) || cardsPerPlayer < 1) cardsPerPlayer = 1;
            if (cardsPerPlayer > 10) cardsPerPlayer = 10;
            
            // Get default password
            const defaultPassword = playerPasswordSettingInput.value.trim();
            if (defaultPassword.length === 0) {
                showCustomAlert('Player password cannot be empty');
                return;
            }
            
            // Check if cards per player changed
            const cardsChanged = cardsPerPlayer !== gameState.settings.cardsPerPlayer;
            
            // Update settings
            gameState.settings.authorizedPlayers = playerNames;
            gameState.settings.maxPlayers = maxPlayers;
            gameState.settings.cardsPerPlayer = cardsPerPlayer;
            gameState.settings.defaultPassword = defaultPassword;
            
            // Update customization settings from form fields
            gameState.settings.customization.gameTitle = document.getElementById('gameTitleText').value;
            gameState.settings.customization.gameSubtitle = document.getElementById('gameSubtitleText').value;
            gameState.settings.customization.welcomeTitle = document.getElementById('welcomeTitleText').value;
            gameState.settings.customization.welcomeMessage = document.getElementById('welcomeMessageText').value;
            gameState.settings.customization.loginButtonText = document.getElementById('loginButtonText').value;
            gameState.settings.customization.footerText = document.getElementById('footerText').value;
            
            // Update color settings from text inputs (validate first)
            const colorsToValidate = [
                { picker: 'headerBackgroundColorText', setting: 'headerBackgroundColor' },
                { picker: 'headerTextColorText', setting: 'headerTextColor' },
                { picker: 'mainBackgroundColorText', setting: 'mainBackgroundColor' },
                { picker: 'cardBackgroundColorText', setting: 'cardBackgroundColor' },
                { picker: 'cellBackgroundColorText', setting: 'cellBackgroundColor' },
                { picker: 'markedCellColorText', setting: 'markedCellColor' },
                { picker: 'freeCellColorText', setting: 'freeCellColor' },
                { picker: 'primaryButtonColorText', setting: 'primaryButtonColor' },
                { picker: 'secondaryButtonColorText', setting: 'secondaryButtonColor' },
                { picker: 'dangerButtonColorText', setting: 'dangerButtonColor' },
                { picker: 'buttonTextColorText', setting: 'buttonTextColor' }
            ];
            
            let hasInvalidColor = false;
            colorsToValidate.forEach(color => {
                const colorValue = document.getElementById(color.picker).value.trim();
                if (colorValue && !isValidHexColor(colorValue)) {
                    showCustomAlert(`Invalid color format for ${color.setting}. Please use #RRGGBB format.`);
                    hasInvalidColor = true;
                    return;
                }
                if (colorValue) {
                    gameState.settings.customization[color.setting] = colorValue;
                }
            });
            
            if (hasInvalidColor) return;
            
            // Update transparency settings
            gameState.settings.customization.headerTransparent = document.getElementById('headerTransparent').checked;
            gameState.settings.customization.mainTransparent = document.getElementById('mainTransparent').checked;
            
            // Apply customizations immediately
            applyCustomizations();
            
            // If cards per player changed, update all players
            if (cardsChanged) {
                updatePlayerCardsForAllPlayers(cardsPerPlayer);
            }
            
            // Save to localStorage
            saveGameState();
            
            // Update players count display
            updatePlayersCount();
            
            let message = `
                <strong>Settings saved successfully!</strong><br><br>
                • Authorized players: ${playerNames.length}<br>
                • Maximum players: ${maxPlayers}<br>
                • Cards per player: ${cardsPerPlayer}<br>
                • Player password updated<br>
                • Customization settings saved
            `;
            
            if (cardsChanged) {
                message += `<br><br><strong>All player cards have been updated to ${cardsPerPlayer} cards per player.</strong>`;
            }
            
            showCustomAlert(message);
        }
        
        function handleAdminLogout() {
            // Check if any settings were changed
            const playerListTextarea = document.getElementById('playerList');
            const maxPlayersInput = document.getElementById('maxPlayers');
            const cardsPerPlayerInput = document.getElementById('cardsPerPlayer');
            const playerPasswordSettingInput = document.getElementById('playerPasswordSetting');
            
            if (!playerListTextarea || !maxPlayersInput || !cardsPerPlayerInput || !playerPasswordSettingInput) {
                showScreen('loginScreen');
                return;
            }
            
            // Check if settings were changed
            const playerListText = playerListTextarea.value.trim();
            const playerNames = playerListText.split(',')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            const playerNamesChanged = JSON.stringify(playerNames) !== JSON.stringify(gameState.settings.authorizedPlayers);
            
            const maxPlayers = parseInt(maxPlayersInput.value);
            const maxPlayersChanged = maxPlayers !== gameState.settings.maxPlayers;
            
            const cardsPerPlayer = parseInt(cardsPerPlayerInput.value);
            const cardsPerPlayerChanged = cardsPerPlayer !== gameState.settings.cardsPerPlayer;
            
            const defaultPassword = playerPasswordSettingInput.value.trim();
            const passwordChanged = defaultPassword !== gameState.settings.defaultPassword;
            
            const settingsChanged = playerNamesChanged || maxPlayersChanged || cardsPerPlayerChanged || passwordChanged;
            
            if (settingsChanged) {
                // Show confirmation dialog for unsaved changes
                const dialog = document.createElement('div');
                dialog.className = 'confirmation-dialog';
                dialog.style.display = 'flex';
                
                const content = document.createElement('div');
                content.className = 'confirmation-content';
                
                content.innerHTML = `
                    <h3><i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i> Unsaved Changes</h3>
                    <div style="text-align: left; line-height: 1.6;">
                        You have unsaved changes in the admin settings.<br><br>
                        <strong>Do you want to save changes before exiting?</strong><br><br>
                        Changes detected:<br>
                        ${playerNamesChanged ? '• Player list<br>' : ''}
                        ${maxPlayersChanged ? '• Maximum players<br>' : ''}
                        ${cardsPerPlayerChanged ? '• Cards per player<br>' : ''}
                        ${passwordChanged ? '• Player password<br>' : ''}
                    </div>
                    <div class="confirmation-buttons">
                        <button class="btn btn-secondary" id="exitWithoutSaveBtn">
                            <i class="fas fa-times"></i> Exit Without Saving
                        </button>
                        <button class="btn btn-primary" id="saveAndExitBtn">
                            <i class="fas fa-save"></i> Save & Exit
                        </button>
                    </div>
                `;
                
                dialog.appendChild(content);
                document.body.appendChild(dialog);
                
                // Add event listeners
                document.getElementById('exitWithoutSaveBtn').addEventListener('click', function() {
                    document.body.removeChild(dialog);
                    showScreen('loginScreen');
                    // Clear admin fields
                    const playerNameInput = document.getElementById('playerName');
                    const playerPasswordInput = document.getElementById('playerPassword');
                    if (playerNameInput) playerNameInput.value = '';
                    if (playerPasswordInput) playerPasswordInput.value = '';
                });
                
                document.getElementById('saveAndExitBtn').addEventListener('click', function() {
                    document.body.removeChild(dialog);
                    // Save settings first
                    saveAdminSettings();
                    // Then exit
                    showScreen('loginScreen');
                    // Clear admin fields
                    const playerNameInput = document.getElementById('playerName');
                    const playerPasswordInput = document.getElementById('playerPassword');
                    if (playerNameInput) playerNameInput.value = '';
                    if (playerPasswordInput) playerPasswordInput.value = '';
                });
            } else {
                // No changes, just exit
                showScreen('loginScreen');
                // Clear admin fields
                const playerNameInput = document.getElementById('playerName');
                const playerPasswordInput = document.getElementById('playerPassword');
                if (playerNameInput) playerNameInput.value = '';
                if (playerPasswordInput) playerPasswordInput.value = '';
            }
        }
        
        function confirmClearPlayerData() {
            // Create confirmation dialog
            const dialog = document.createElement('div');
            dialog.className = 'confirmation-dialog';
            dialog.style.display = 'flex';
            
            const content = document.createElement('div');
            content.className = 'confirmation-content';
            
            content.innerHTML = `
                <h3><i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Confirm Action</h3>
                <div style="text-align: left; line-height: 1.6;">
                    <strong>Warning: This action cannot be undone!</strong><br><br>
                    This will:<br>
                    • Clear all player cards<br>
                    • Remove all Lucky 4D numbers<br>
                    • Reset all player progress<br><br>
                    Authorized player list will be preserved.<br>
                    Are you sure you want to continue?
                </div>
                <div class="confirmation-buttons">
                    <button class="btn btn-secondary" id="cancelClearBtn">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn btn-danger" id="confirmClearBtn">
                        <i class="fas fa-trash-alt"></i> Clear All Data
                    </button>
                </div>
            `;
            
            dialog.appendChild(content);
            document.body.appendChild(dialog);
            
            // Add event listeners
            document.getElementById('cancelClearBtn').addEventListener('click', function() {
                document.body.removeChild(dialog);
            });
            
            document.getElementById('confirmClearBtn').addEventListener('click', function() {
                document.body.removeChild(dialog);
                clearAllPlayerData();
            });
        }
        
        function showPrevCard() {
            if (gameState.currentCardIndex > 0) {
                gameState.currentCardIndex--;
                updateCardDisplay();
            }
        }
        
        function showNextCard() {
            if (gameState.currentPlayer && 
                gameState.currentCardIndex < gameState.currentPlayer.cards.length - 1) {
                gameState.currentCardIndex++;
                updateCardDisplay();
            }
        }
        
        // ==================== DATA PERSISTENCE ====================
        
        function saveGameState() {
            try {
                localStorage.setItem('bingoGameState', JSON.stringify(gameState));
            } catch (error) {
                console.error('Failed to save game state:', error);
            }
        }
        
        function loadGameState() {
            try {
                const saved = localStorage.getItem('bingoGameState');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    gameState.players = parsed.players || [];
                    gameState.settings = { 
                        ...gameState.settings, 
                        ...(parsed.settings || {}),
                        // Ensure customization exists
                        customization: parsed.settings && parsed.settings.customization 
                            ? { ...gameState.settings.customization, ...parsed.settings.customization }
                            : gameState.settings.customization
                    };
                }
            } catch (error) {
                console.error('Failed to load game state:', error);
            }
        }
        
        // ==================== INITIALIZATION ====================
        
        function initGame() {
            // Load saved game state
            loadGameState();
            
            // Update UI
            updatePlayersCount();
            
            // Setup event listeners
            setupEventListeners();
            
            // Apply customizations
            applyCustomizations();
            
            // Show login screen
            showScreen('loginScreen');
        }
        
        // Start the game when page loads
        window.addEventListener('DOMContentLoaded', initGame);
        
    </script>
</body>
</html>
