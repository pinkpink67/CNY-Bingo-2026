<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Cache Control Meta Tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Mobile Bingo Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Import Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin: 20px 0;
        }
        
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            text-align: center;
            padding: 25px 20px;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }
        
        .content {
            padding: 25px 20px;
            position: relative;
            min-height: 500px;
        }
        
        /* Login Screen */
        #loginScreen {
            text-align: center;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 25px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            text-align: left;
        }
        
        .input-group label {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .input-group input {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .input-group input:focus {
            border-color: #6a11cb;
            outline: none;
        }
        
        select {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            background-color: white;
        }
        
        select:focus {
            border-color: #6a11cb;
            outline: none;
        }
        
        .btn {
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background-color: #6a11cb;
            color: white;
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #000;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .players-count {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .players-count span {
            font-weight: 700;
            color: #6a11cb;
        }
        
        /* Game Screen */
        #gameScreen {
            display: none;
        }
        
        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .player-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #6a11cb;
        }
        
        .card-counter {
            background-color: #f0f0f0;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .bingo-card-container {
            background-color: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            background-size: cover;
            background-position: center;
        }
        
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            min-height: 300px;
            background-size: cover;
            background-position: center;
        }
        
        .bingo-cell {
            aspect-ratio: 1;
            background-color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.05);
            /* Default border - will be overridden by JavaScript */
            border: 2px solid transparent;
            /* Default font size - will be overridden by JavaScript */
            font-size: 1.2rem;
            /* Default color - will be overridden by JavaScript */
            color: #333;
        }
        
        .bingo-cell.free {
            background-color: #ffd166;
            color: #333;
        }
        
        .bingo-cell.marked {
            background-color: #6a11cb;
            color: white;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .controls .btn {
            flex: 1;
        }
        
        .footer {
            margin-top: 20px;
            text-align: center;
            font-size: 0.85rem;
            color: #777;
        }
        
        /* Lucky 4D Number Display */
        .password-display {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            display: none;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.3);
            min-width: 250px;
            text-align: center;
        }
        
        /* Confirmation Dialog */
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .confirmation-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: center;
        }
        
        .confirmation-buttons .btn {
            flex: 1;
        }
        
        /* Admin Screen */
        #adminScreen {
            display: none;
        }
        
        .admin-controls {
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .textarea-group, .input-group-admin {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .textarea-group label, .input-group-admin label {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .textarea-group textarea, .input-group-admin input {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .textarea-group textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .textarea-group textarea:focus, .input-group-admin input:focus {
            border-color: #6a11cb;
            outline: none;
        }
        
        .admin-settings {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .admin-customization {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .admin-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }
        
        .admin-actions h3 {
            color: #dc3545;
        }
        
        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .color-picker-group label {
            flex: 1;
            font-weight: 600;
        }
        
        .color-picker-group input[type="color"] {
            width: 60px;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .color-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .color-input-group input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
        }
        
        .transparency-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        
        .transparency-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        
        .preview-box {
            width: 100%;
            height: 100px;
            border-radius: 10px;
            border: 2px dashed #ddd;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-position: center;
        }
        
        .preview-box.small {
            height: 60px;
            margin-top: 5px;
        }
        
        .preview-text {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .file-upload-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .file-upload-group input[type="file"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
        }
        
        .reset-btn {
            width: 100%;
            margin-top: 10px;
        }
        
        .color-format-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }
        
        .range-slider-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .range-slider-group label {
            font-weight: 600;
        }
        
        .range-slider-group input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
        }
        
        .range-value {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: #e9f7ef;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .sync-status.syncing {
            background-color: #fff3cd;
        }
        
        .sync-status.error {
            background-color: #f8d7da;
        }
        
        .firebase-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: #e7f3ff;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .firebase-status.connected {
            background-color: #e9f7ef;
        }
        
        .firebase-status.disconnected {
            background-color: #f8d7da;
        }
        
        @media (max-width: 480px) {
            .container {
                border-radius: 15px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .content {
                padding: 20px 15px;
            }
            
            .bingo-cell {
                font-size: 1rem;
            }
            
            .password-display {
                min-width: 200px;
                font-size: 1rem;
                padding: 10px 20px;
            }
            
            .admin-controls {
                max-height: 60vh;
            }
        }
    </style>
</head>
<body>
    <!-- Confirmation Dialog -->
    <div class="confirmation-dialog" id="confirmationDialog">
        <div class="confirmation-content">
            <h3><i class="fas fa-user-check"></i> Welcome Back!</h3>
            <p>Name "<span id="returningPlayerName"></span>" is already registered.</p>
            <p>Is this you? Would you like to continue with your existing cards?</p>
            
            <div class="confirmation-buttons">
                <button class="btn btn-secondary" id="confirmNewPlayerBtn">
                    <i class="fas fa-user-times"></i> No, I'm Different
                </button>
                <button class="btn btn-primary" id="confirmReturningPlayerBtn">
                    <i class="fas fa-sign-in-alt"></i> Yes, It's Me
                </button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1 id="gameTitle">Mobile Bingo</h1>
            <p id="gameSubtitle">Login to play with your unique bingo cards</p>
        </div>
        
        <div class="content">
            <!-- Login Screen -->
            <div id="loginScreen">
                <h2 id="welcomeTitle">Welcome to Bingo!</h2>
                <p id="welcomeMessage">Enter your name and password to join the game.</p>
                
                <form class="login-form" id="loginForm">
                    <div class="input-group">
                        <label for="playerName">Your Name</label>
                        <input type="text" id="playerName" placeholder="Enter your name" required autocomplete="off">
                    </div>
                    
                    <div class="input-group">
                        <label for="playerPassword">Password</label>
                        <input type="password" id="playerPassword" placeholder="Enter password" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="loginButton">
                        <i class="fas fa-sign-in-alt"></i> Join Game
                    </button>
                </form>
                
                <div class="players-count" id="playersCountBox">
                    Players joined: <span id="currentPlayers">0</span> / <span id="maxPlayers">30</span>
                </div>
            </div>
            
            <!-- Game Screen -->
            <div id="gameScreen">
                <div class="player-info">
                    <div class="player-name" id="displayPlayerName">Player</div>
                    <div class="card-counter" id="cardCounterBox">Card <span id="currentCard">1</span> of <span id="totalCards">3</span></div>
                </div>
                
                <div class="bingo-card-container" id="bingoCardContainer">
                    <div class="bingo-grid" id="bingoGrid">
                        <!-- Bingo cells will be generated here -->
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-secondary" id="prevCardBtn">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-primary" id="nextCardBtn">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Admin Screen -->
            <div id="adminScreen">
                <h2><i class="fas fa-cogs"></i> Admin Controls</h2>
                <p>For admin access, use ID: <strong>admin</strong> and Password: <strong>1234</strong></p>
                
                <div class="admin-controls">
                    <!-- Game Content Customization -->
                    <div class="admin-customization">
                        <h3><i class="fas fa-paint-brush"></i> Game Content & Text</h3>
                        
                        <div class="input-group-admin">
                            <label for="gameTitleText">Game Title</label>
                            <input type="text" id="gameTitleText" value="Mobile Bingo">
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="gameTitleIcon">Game Title Icon</label>
                            <select id="gameTitleIcon">
                                <option value="">No Icon</option>
                                <option value="fas fa-dice">Dice (fa-dice)</option>
                                <option value="fas fa-bingo">Bingo (fa-bingo)</option>
                                <option value="fas fa-gamepad">Gamepad (fa-gamepad)</option>
                                <option value="fas fa-trophy">Trophy (fa-trophy)</option>
                                <option value="fas fa-star">Star (fa-star)</option>
                                <option value="fas fa-heart">Heart (fa-heart)</option>
                                <option value="fas fa-flag">Flag (fa-flag)</option>
                                <option value="fas fa-gem">Gem (fa-gem)</option>
                                <option value="fas fa-crown">Crown (fa-crown)</option>
                            </select>
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="gameSubtitleText">Game Subtitle</label>
                            <input type="text" id="gameSubtitleText" value="Login to play with your unique bingo cards">
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="welcomeTitleText">Welcome Title</label>
                            <input type="text" id="welcomeTitleText" value="Welcome to Bingo!">
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="welcomeMessageText">Welcome Message</label>
                            <input type="text" id="welcomeMessageText" value="Enter your name and password to join the game.">
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="loginButtonText">Login Button Text</label>
                            <input type="text" id="loginButtonText" value="Join Game">
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="footerText">Footer Text</label>
                            <input type="text" id="footerText" value="Mobile Bingo Game Â© 2023">
                        </div>
                    </div>
                    
                    <!-- Header Background Customization -->
                    <div class="admin-customization">
                        <h3><i class="fas fa-image"></i> Header Background</h3>
                        
                        <div class="file-upload-group">
                            <label>Upload Header Background Image</label>
                            <input type="file" id="headerBackgroundUpload" accept="image/*">
                            <div class="preview-box" id="headerBackgroundPreview">
                                <div class="preview-text">Header Background Preview</div>
                            </div>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Or use solid color:</label>
                            <div class="color-input-group">
                                <input type="color" id="headerBackgroundColor" value="#6a11cb">
                                <input type="text" id="headerBackgroundColorText" value="#6a11cb" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="transparency-checkbox">
                            <input type="checkbox" id="headerTransparent">
                            <label for="headerTransparent">Make header background transparent</label>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Header Text Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="headerTextColor" value="#ffffff">
                                <input type="text" id="headerTextColorText" value="#ffffff" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <button class="btn btn-secondary reset-btn" id="resetHeaderBtn">
                            <i class="fas fa-undo"></i> Reset Header to Default
                        </button>
                    </div>
                    
                    <!-- Main Background Customization -->
                    <div class="admin-customization">
                        <h3><i class="fas fa-desktop"></i> Main Background</h3>
                        
                        <div class="file-upload-group">
                            <label>Upload Main Background Image</label>
                            <input type="file" id="mainBackgroundUpload" accept="image/*">
                            <div class="preview-box" id="mainBackgroundPreview">
                                <div class="preview-text">Main Background Preview</div>
                            </div>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Or use solid color:</label>
                            <div class="color-input-group">
                                <input type="color" id="mainBackgroundColor" value="#f5f5f5">
                                <input type="text" id="mainBackgroundColorText" value="#f5f5f5" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="transparency-checkbox">
                            <input type="checkbox" id="mainTransparent">
                            <label for="mainTransparent">Make main background transparent</label>
                        </div>
                        
                        <button class="btn btn-secondary reset-btn" id="resetMainBackgroundBtn">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                    </div>
                    
                    <!-- Card Container Background Customization -->
                    <div class="admin-customization">
                        <h3><i class="fas fa-layer-group"></i> Card Container Background</h3>
                        
                        <div class="file-upload-group">
                            <label>Upload Container Background Image</label>
                            <input type="file" id="containerBackgroundUpload" accept="image/*">
                            <div class="preview-box" id="containerBackgroundPreview">
                                <div class="preview-text">Container Background Preview</div>
                            </div>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Container Background Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="containerBackgroundColor" value="#f8f9fa">
                                <input type="text" id="containerBackgroundColorText" value="#f8f9fa" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="transparency-checkbox">
                            <input type="checkbox" id="containerTransparent">
                            <label for="containerTransparent">Make Container Background Transparent</label>
                        </div>
                        
                        <button class="btn btn-secondary reset-btn" id="resetContainerBackgroundBtn">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                    </div>
                    
                    <!-- Bingo Card Background Customization -->
                    <div class="admin-customization">
                        <h3><i class="fas fa-th"></i> Bingo Card Background</h3>
                        
                        <div class="file-upload-group">
                            <label>Upload Card Background Image</label>
                            <input type="file" id="cardBackgroundUpload" accept="image/*">
                            <div class="preview-box" id="cardBackgroundPreview">
                                <div class="preview-text">Card Background Preview</div>
                            </div>
                        </div>
                        
                        <div class="transparency-checkbox">
                            <input type="checkbox" id="cardBackgroundEnabled">
                            <label for="cardBackgroundEnabled">Enable Card Background</label>
                        </div>
                        
                        <div class="transparency-checkbox">
                            <input type="checkbox" id="cardBackgroundTransparent">
                            <label for="cardBackgroundTransparent">Make Card Background Transparent</label>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Card Background Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="cardBackgroundColor" value="#f8f9fa">
                                <input type="text" id="cardBackgroundColorText" value="#f8f9fa" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <button class="btn btn-secondary reset-btn" id="resetCardBackgroundBtn">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                    </div>
                    
                    <!-- Cell Customization -->
                    <div class="admin-customization">
                        <h3><i class="fas fa-square"></i> Cell Customization</h3>
                        
                        <div class="color-picker-group">
                            <label>Number Cell Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="cellBackgroundColor" value="#ffffff">
                                <input type="text" id="cellBackgroundColorText" value="#ffffff" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="transparency-checkbox">
                            <input type="checkbox" id="cellTransparentEnabled">
                            <label for="cellTransparentEnabled">Enable Cell Transparency</label>
                        </div>
                        
                        <div class="range-slider-group" id="cellTransparencyGroup" style="display: none;">
                            <label for="cellTransparency">Cell Transparency Level</label>
                            <input type="range" id="cellTransparency" min="0" max="100" value="100">
                            <div class="range-value">
                                <span>Opaque (0%)</span>
                                <span id="cellTransparencyValue">100%</span>
                                <span>Transparent (100%)</span>
                            </div>
                        </div>
                        
                        <div class="transparency-checkbox">
                            <input type="checkbox" id="freeCellEnabled">
                            <label for="freeCellEnabled">Enable Center "FREE" Cell</label>
                        </div>
                        
                        <div class="input-group-admin" id="freeCellTextGroup" style="display: none;">
                            <label for="freeCellText">"FREE" Cell Text</label>
                            <input type="text" id="freeCellText" value="FREE">
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Free Cell Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="freeCellColor" value="#ffd166">
                                <input type="text" id="freeCellColorText" value="#ffd166" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Marked Cell Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="markedCellColor" value="#6a11cb">
                                <input type="text" id="markedCellColorText" value="#6a11cb" placeholder="#RRGGBB">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cell Number Customization -->
                    <div class="admin-customization">
                        <h3><i class="fas fa-text-height"></i> Cell Number Customization</h3>
                        
                        <div class="color-picker-group">
                            <label>Number Text Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="cellNumberColor" value="#333333">
                                <input type="text" id="cellNumberColorText" value="#333333" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="range-slider-group">
                            <label for="cellFontSize">Number Font Size (px)</label>
                            <input type="range" id="cellFontSize" min="10" max="30" value="18">
                            <div class="range-value">
                                <span>Small (10px)</span>
                                <span id="cellFontSizeValue">18px</span>
                                <span>Large (30px)</span>
                            </div>
                        </div>
                        
                        <div class="range-slider-group">
                            <label for="cellSpacing">Cell Spacing (gap)</label>
                            <input type="range" id="cellSpacing" min="1" max="20" value="8">
                            <div class="range-value">
                                <span>Tight (1px)</span>
                                <span id="cellSpacingValue">8px</span>
                                <span>Wide (20px)</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-secondary reset-btn" id="resetCellNumberBtn">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                    </div>
                    
                    <!-- Cell Border Customization -->
                    <div class="admin-customization">
                        <h3><i class="fas fa-border-style"></i> Cell Border Customization</h3>
                        
                        <div class="transparency-checkbox">
                            <input type="checkbox" id="cellBorderEnabled">
                            <label for="cellBorderEnabled">Enable Cell Borders</label>
                        </div>
                        
                        <div class="color-picker-group" id="cellBorderColorGroup" style="display: none;">
                            <label>Border Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="cellBorderColor" value="#cccccc">
                                <input type="text" id="cellBorderColorText" value="#cccccc" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="range-slider-group" id="cellBorderThicknessGroup" style="display: none;">
                            <label for="cellBorderThickness">Border Thickness (px)</label>
                            <input type="range" id="cellBorderThickness" min="1" max="10" value="2">
                            <div class="range-value">
                                <span>Thin (1px)</span>
                                <span id="cellBorderThicknessValue">2px</span>
                                <span>Thick (10px)</span>
                            </div>
                        </div>
                        
                        <div class="range-slider-group" id="cellBorderTransparencyGroup" style="display: none;">
                            <label for="cellBorderTransparency">Border Transparency</label>
                            <input type="range" id="cellBorderTransparency" min="0" max="100" value="0">
                            <div class="range-value">
                                <span>Opaque (0%)</span>
                                <span id="cellBorderTransparencyValue">0%</span>
                                <span>Transparent (100%)</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-secondary reset-btn" id="resetCellBorderBtn">
                            <i class="fas fa-undo"></i> Reset Borders to Default
                        </button>
                    </div>
                    
                    <!-- Button Colors Customization -->
                    <div class="admin-customization">
                        <h3><i class="fas fa-square"></i> Button Colors</h3>
                        
                        <div class="color-picker-group">
                            <label>Primary Button Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="primaryButtonColor" value="#6a11cb">
                                <input type="text" id="primaryButtonColorText" value="#6a11cb" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Secondary Button Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="secondaryButtonColor" value="#f0f0f0">
                                <input type="text" id="secondaryButtonColorText" value="#f0f0f0" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Danger Button Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="dangerButtonColor" value="#dc3545">
                                <input type="text" id="dangerButtonColorText" value="#dc3545" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="color-picker-group">
                            <label>Button Text Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="buttonTextColor" value="#ffffff">
                                <input type="text" id="buttonTextColorText" value="#ffffff" placeholder="#RRGGBB">
                            </div>
                        </div>
                        
                        <div class="preview-box small" id="buttonPreview">
                            <div style="display: flex; gap: 10px;">
                                <button style="padding: 8px 16px; border: none; border-radius: 5px; background-color: #6a11cb; color: white;">Primary</button>
                                <button style="padding: 8px 16px; border: none; border-radius: 5px; background-color: #f0f0f0; color: #333;">Secondary</button>
                                <button style="padding: 8px 16px; border: none; border-radius: 5px; background-color: #dc3545; color: white;">Danger</button>
                            </div>
                        </div>
                        
                        <button class="btn btn-secondary reset-btn" id="resetButtonsBtn">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                    </div>
                    
                    <!-- Game Settings -->
                    <div class="admin-settings">
                        <h3><i class="fas fa-sliders-h"></i> Game Settings</h3>
                        
                        <div class="input-group-admin">
                            <label for="playerList">Authorized Player Names (comma-separated)</label>
                            <textarea id="playerList" placeholder="Enter player names, e.g., Calvin, JF, Cindy, PIG">Calvin, JF, Cindy, PIG</textarea>
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="maxPlayers">Maximum Players (1-100)</label>
                            <input type="number" id="maxPlayers" min="1" max="100" value="30">
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="cardsPerPlayer">Cards per Player (1-10)</label>
                            <input type="number" id="cardsPerPlayer" min="1" max="10" value="3">
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="playerPasswordSetting">Player Login Password</label>
                            <input type="text" id="playerPasswordSetting" value="8888">
                        </div>
                    </div>
                    
                    <!-- Firebase Configuration -->
                    <div class="admin-customization">
                        <h3><i class="fas fa-fire"></i> Firebase Configuration</h3>
                        
                        <div class="firebase-status" id="firebaseStatus">
                            <i class="fas fa-circle" id="firebaseStatusIcon" style="color: #dc3545;"></i>
                            <span id="firebaseStatusText">Firebase: Not Connected</span>
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="firebaseConfig">Firebase Configuration JSON</label>
                            <textarea id="firebaseConfig" placeholder='Paste your Firebase configuration here'>
{
  "apiKey": "AIzaSyCQY0pQq5q4q3q2q1q0q9q8q7q6q5q4q3q2q1q",
  "authDomain": "your-project.firebaseapp.com",
  "databaseURL": "https://your-project-default-rtdb.firebaseio.com",
  "projectId": "your-project",
  "storageBucket": "your-project.appspot.com",
  "messagingSenderId": "123456789012",
  "appId": "1:123456789012:web:abc123def456ghi789jkl"
}</textarea>
                        </div>
                        
                        <div class="input-group-admin">
                            <label for="firebasePath">Firebase Path (e.g., "bingo/settings")</label>
                            <input type="text" id="firebasePath" value="bingo/settings">
                        </div>
                        
                        <button class="btn btn-success" id="connectFirebaseBtn">
                            <i class="fas fa-plug"></i> Connect to Firebase
                        </button>
                        
                        <button class="btn btn-secondary" id="testFirebaseBtn">
                            <i class="fas fa-broadcast-tower"></i> Test Firebase Connection
                        </button>
                    </div>
                    
                    <!-- Admin Actions -->
                    <div class="admin-actions">
                        <h3><i class="fas fa-exclamation-triangle"></i> Admin Actions</h3>
                        
                        <button class="btn btn-danger" id="clearPlayerDataBtn">
                            <i class="fas fa-trash-alt"></i> Clear All Player Data
                        </button>
                        
                        <button class="btn btn-warning" id="clearCacheBtn">
                            <i class="fas fa-sync-alt"></i> Clear Cache & Refresh
                        </button>
                        
                        <button class="btn btn-success" id="forceSyncBtn">
                            <i class="fas fa-cloud-upload-alt"></i> Push to Firebase
                        </button>
                        
                        <button class="btn btn-primary" id="pullFromFirebaseBtn">
                            <i class="fas fa-cloud-download-alt"></i> Pull from Firebase
                        </button>
                        
                        <div class="sync-status" id="syncStatus" style="display: none;">
                            <i class="fas fa-sync fa-spin"></i>
                            <span id="syncMessage">Syncing with Firebase...</span>
                        </div>
                        
                        <p style="font-size: 0.9rem; color: #666;">
                            This will remove all player cards and Lucky 4D numbers. Authorized player list will be preserved.
                        </p>
                    </div>
                    
                    <button class="btn btn-primary" id="saveSettingsBtn">
                        <i class="fas fa-save"></i> Save All Settings
                    </button>
                    
                    <button class="btn btn-secondary" id="adminLogoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Exit Admin
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lucky 4D Number Display (Fixed at bottom center) -->
    <div class="password-display" id="passwordDisplay">
        Lucky 4D Number: <span id="luckyNumber">XXXX</span>
    </div>
    
    <div class="footer" id="gameFooter">
        <p>Mobile Bingo Game &copy; 2023</p>
    </div>

    <script>
        // ==================== CACHE CONTROL ====================
        // Add version parameter to force cache refresh
        const GAME_VERSION = '2.3';
        const lastVersion = localStorage.getItem('gameVersion');
        
        if (lastVersion !== GAME_VERSION) {
            localStorage.setItem('gameVersion', GAME_VERSION);
            // Add cache busting parameter to URL
            if (!window.location.search.includes('nocache')) {
                const url = new URL(window.location);
                url.searchParams.set('nocache', Date.now());
                window.location.href = url.toString();
            }
        }
        
        // ==================== FIREBASE CONFIGURATION ====================
        
        let firebaseApp = null;
        let firebaseDatabase = null;
        let firebaseConnected = false;
        let firebaseSettingsRef = null;
        
        // Default Firebase configuration (users should replace with their own)
        const DEFAULT_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCQY0pQq5q4q3q2q1q0q9q8q7q6q5q4q3q2q1q",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project-default-rtdb.firebaseio.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abc123def456ghi789jkl"
        };
        
        const DEFAULT_FIREBASE_PATH = "bingo/settings";
        
        // ==================== GAME STATE ====================
        
        let gameState = {
            players: [],
            currentPlayer: null,
            currentCardIndex: 0,
            settings: {
                maxPlayers: 30,
                cardsPerPlayer: 3,
                defaultPassword: "8888",
                authorizedPlayers: ["Calvin", "JF", "Cindy", "PIG"],
                customization: {
                    // Header
                    headerBackgroundImage: null,
                    headerBackgroundColor: "#6a11cb",
                    headerTextColor: "#ffffff",
                    headerTransparent: false,
                    
                    // Main background
                    mainBackgroundImage: null,
                    mainBackgroundColor: "#f5f5f5",
                    mainTransparent: false,
                    
                    // Card container background
                    containerBackgroundImage: null,
                    containerBackgroundColor: "#f8f9fa",
                    containerTransparent: false,
                    
                    // Card background
                    cardBackgroundImage: null,
                    cardBackgroundColor: "#f8f9fa",
                    cardBackgroundEnabled: true,
                    cardBackgroundTransparent: false,
                    
                    // Cell customization
                    cellBackgroundColor: "#ffffff",
                    cellTransparentEnabled: false,
                    cellTransparency: 100,
                    freeCellEnabled: true,
                    freeCellText: "FREE",
                    freeCellColor: "#ffd166",
                    markedCellColor: "#6a11cb",
                    
                    // Cell number customization
                    cellNumberColor: "#333333",
                    cellFontSize: 18,
                    cellSpacing: 8,
                    
                    // Cell border customization
                    cellBorderEnabled: false,
                    cellBorderColor: "#cccccc",
                    cellBorderThickness: 2,
                    cellBorderTransparency: 0,
                    
                    // Buttons
                    primaryButtonColor: "#6a11cb",
                    secondaryButtonColor: "#f0f0f0",
                    dangerButtonColor: "#dc3545",
                    buttonTextColor: "#ffffff",
                    
                    // Text content
                    gameTitle: "Mobile Bingo",
                    gameTitleIcon: "",
                    gameSubtitle: "Login to play with your unique bingo cards",
                    welcomeTitle: "Welcome to Bingo!",
                    welcomeMessage: "Enter your name and password to join the game.",
                    loginButtonText: "Join Game",
                    footerText: "Mobile Bingo Game Â© 2023"
                }
            }
        };
        
        const ADMIN_CREDENTIALS = {
            id: "admin",
            password: "1234"
        };
        
        // Variables to track login attempts
        let pendingLoginName = '';
        let existingPlayerFound = null;
        
        // ==================== FIREBASE FUNCTIONS ====================
        
        function initializeFirebase() {
            try {
                // Load Firebase config from localStorage
                const savedConfig = localStorage.getItem('firebaseConfig');
                const savedPath = localStorage.getItem('firebasePath') || DEFAULT_FIREBASE_PATH;
                
                let firebaseConfig;
                if (savedConfig) {
                    try {
                        firebaseConfig = JSON.parse(savedConfig);
                    } catch (e) {
                        console.error('Invalid Firebase config in localStorage:', e);
                        firebaseConfig = DEFAULT_FIREBASE_CONFIG;
                    }
                } else {
                    firebaseConfig = DEFAULT_FIREBASE_CONFIG;
                }
                
                // Initialize Firebase if not already initialized
                if (!firebaseApp) {
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                    firebaseDatabase = firebase.database();
                    console.log('Firebase initialized');
                }
                
                // Set up the reference
                firebaseSettingsRef = firebaseDatabase.ref(savedPath);
                
                // Listen for real-time updates
                firebaseSettingsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        console.log('Firebase update received:', data);
                        updateGameStateFromFirebase(data);
                        updateFirebaseStatus(true, 'Connected & Receiving Updates');
                    }
                }, (error) => {
                    console.error('Firebase error:', error);
                    updateFirebaseStatus(false, 'Error: ' + error.message);
                });
                
                firebaseConnected = true;
                updateFirebaseStatus(true, 'Connected to Firebase');
                return true;
                
            } catch (error) {
                console.error('Failed to initialize Firebase:', error);
                updateFirebaseStatus(false, 'Not Connected: ' + error.message);
                return false;
            }
        }
        
        function updateFirebaseStatus(connected, message) {
            const statusElement = document.getElementById('firebaseStatus');
            const statusIcon = document.getElementById('firebaseStatusIcon');
            const statusText = document.getElementById('firebaseStatusText');
            
            firebaseConnected = connected;
            
            if (connected) {
                statusElement.className = 'firebase-status connected';
                statusIcon.style.color = '#28a745';
            } else {
                statusElement.className = 'firebase-status disconnected';
                statusIcon.style.color = '#dc3545';
            }
            
            statusText.textContent = 'Firebase: ' + message;
        }
        
        function pushSettingsToFirebase() {
            if (!firebaseConnected || !firebaseSettingsRef) {
                showCustomAlert('Firebase is not connected. Please configure and connect Firebase first.');
                return false;
            }
            
            const syncStatus = document.getElementById('syncStatus');
            const syncMessage = document.getElementById('syncMessage');
            
            syncStatus.style.display = 'flex';
            syncStatus.className = 'sync-status syncing';
            syncMessage.textContent = 'Pushing settings to Firebase...';
            
            try {
                // Prepare settings to push (exclude player data)
                const settingsToPush = {
                    settings: gameState.settings,
                    lastUpdated: Date.now(),
                    updatedBy: gameState.currentPlayer ? gameState.currentPlayer.name : 'admin'
                };
                
                firebaseSettingsRef.set(settingsToPush)
                    .then(() => {
                        syncMessage.textContent = 'Settings pushed to Firebase successfully!';
                        syncStatus.className = 'sync-status';
                        
                        setTimeout(() => {
                            syncStatus.style.display = 'none';
                        }, 2000);
                        
                        showCustomAlert(`
                            <strong>Settings pushed to Firebase successfully!</strong><br><br>
                            â¢ All connected players will receive updates automatically<br>
                            â¢ Changes will be applied in real-time<br>
                            â¢ Last updated: ${new Date().toLocaleTimeString()}
                        `);
                        return true;
                    })
                    .catch((error) => {
                        syncMessage.textContent = 'Error: ' + error.message;
                        syncStatus.className = 'sync-status error';
                        console.error('Firebase push error:', error);
                        showCustomAlert('Error pushing to Firebase: ' + error.message);
                        return false;
                    });
                    
            } catch (error) {
                syncMessage.textContent = 'Error: ' + error.message;
                syncStatus.className = 'sync-status error';
                console.error('Firebase push error:', error);
                showCustomAlert('Error pushing to Firebase: ' + error.message);
                return false;
            }
        }
        
        function pullSettingsFromFirebase() {
            if (!firebaseConnected || !firebaseSettingsRef) {
                showCustomAlert('Firebase is not connected. Please configure and connect Firebase first.');
                return false;
            }
            
            const syncStatus = document.getElementById('syncStatus');
            const syncMessage = document.getElementById('syncMessage');
            
            syncStatus.style.display = 'flex';
            syncStatus.className = 'sync-status syncing';
            syncMessage.textContent = 'Pulling settings from Firebase...';
            
            firebaseSettingsRef.once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        updateGameStateFromFirebase(data);
                        syncMessage.textContent = 'Settings pulled from Firebase successfully!';
                        syncStatus.className = 'sync-status';
                        
                        // Update admin panel
                        if (document.getElementById('adminScreen').style.display === 'block') {
                            loadCustomizationSettings();
                        }
                        
                        setTimeout(() => {
                            syncStatus.style.display = 'none';
                        }, 2000);
                        
                        showCustomAlert(`
                            <strong>Settings pulled from Firebase successfully!</strong><br><br>
                            â¢ All settings have been updated<br>
                            â¢ Customizations applied immediately<br>
                            â¢ Last updated: ${new Date(data.lastUpdated).toLocaleString()}
                        `);
                        return true;
                    } else {
                        syncMessage.textContent = 'No data found in Firebase';
                        syncStatus.className = 'sync-status error';
                        showCustomAlert('No settings found in Firebase.');
                        return false;
                    }
                })
                .catch((error) => {
                    syncMessage.textContent = 'Error: ' + error.message;
                    syncStatus.className = 'sync-status error';
                    console.error('Firebase pull error:', error);
                    showCustomAlert('Error pulling from Firebase: ' + error.message);
                    return false;
                });
        }
        
        function updateGameStateFromFirebase(firebaseData) {
            try {
                if (firebaseData.settings) {
                    // Update gameState with Firebase settings
                    gameState.settings = { 
                        ...gameState.settings,
                        ...firebaseData.settings,
                        customization: {
                            ...gameState.settings.customization,
                            ...firebaseData.settings.customization
                        }
                    };
                    
                    // Save to localStorage for offline use
                    saveMasterSettings();
                    
                    // Apply customizations immediately
                    applyCustomizations();
                    
                    // Update card display if player is logged in
                    if (gameState.currentPlayer) {
                        updateCardDisplay();
                    }
                    
                    console.log('Game state updated from Firebase');
                    return true;
                }
            } catch (error) {
                console.error('Error updating from Firebase:', error);
                return false;
            }
        }
        
        function saveFirebaseConfig() {
            const configText = document.getElementById('firebaseConfig').value;
            const path = document.getElementById('firebasePath').value;
            
            try {
                const config = JSON.parse(configText);
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                localStorage.setItem('firebasePath', path);
                return true;
            } catch (error) {
                showCustomAlert('Invalid JSON configuration. Please check your Firebase config.');
                return false;
            }
        }
        
        // ==================== CENTRALIZED STORAGE SYSTEM ====================
        
        // Master key for admin settings
        const MASTER_SETTINGS_KEY = 'bingoMasterSettings';
        const PLAYER_DATA_KEY = 'bingoPlayerData';
        
        // Save settings to centralized storage
        function saveMasterSettings() {
            try {
                // Only save settings (not player data)
                const settingsToSave = {
                    settings: gameState.settings,
                    lastUpdated: Date.now()
                };
                localStorage.setItem(MASTER_SETTINGS_KEY, JSON.stringify(settingsToSave));
                
                // Also save to individual localStorage for backward compatibility
                localStorage.setItem('bingoGameState', JSON.stringify(gameState));
                
                console.log('Master settings saved');
                return true;
            } catch (error) {
                console.error('Failed to save master settings:', error);
                return false;
            }
        }
        
        // Load settings from centralized storage
        function loadMasterSettings() {
            try {
                const savedMaster = localStorage.getItem(MASTER_SETTINGS_KEY);
                const savedLocal = localStorage.getItem('bingoGameState');
                
                // Priority: Master settings > Local settings
                if (savedMaster) {
                    const parsedMaster = JSON.parse(savedMaster);
                    if (parsedMaster.settings) {
                        // Update gameState with master settings
                        gameState.settings = { 
                            ...gameState.settings,
                            ...parsedMaster.settings,
                            customization: {
                                ...gameState.settings.customization,
                                ...parsedMaster.settings.customization
                            }
                        };
                        console.log('Loaded master settings');
                    }
                } else if (savedLocal) {
                    // Fallback to local storage
                    const parsed = JSON.parse(savedLocal);
                    if (parsed.settings) {
                        gameState.settings = { 
                            ...gameState.settings,
                            ...parsed.settings,
                            customization: {
                                ...gameState.settings.customization,
                                ...parsed.settings.customization
                            }
                        };
                    }
                }
                
                // Always load player data from local storage
                if (savedLocal) {
                    const parsed = JSON.parse(savedLocal);
                    gameState.players = parsed.players || [];
                    gameState.currentPlayer = parsed.currentPlayer || null;
                    gameState.currentCardIndex = parsed.currentCardIndex || 0;
                }
                
                return true;
                
            } catch (error) {
                console.error('Failed to load settings:', error);
                return false;
            }
        }
        
        // Save player data separately
        function savePlayerData() {
            try {
                const playerData = {
                    players: gameState.players,
                    currentPlayer: gameState.currentPlayer,
                    currentCardIndex: gameState.currentCardIndex,
                    lastUpdated: Date.now()
                };
                localStorage.setItem(PLAYER_DATA_KEY, JSON.stringify(playerData));
                
                // Also save to combined for backward compatibility
                localStorage.setItem('bingoGameState', JSON.stringify(gameState));
                return true;
            } catch (error) {
                console.error('Failed to save player data:', error);
                return false;
            }
        }
        
        // ==================== GAME FUNCTIONS ====================
        
        function generateBingoCards(count) {
            const cards = [];
            const ranges = {
                B: [1, 15],
                I: [16, 30],
                N: [31, 45],
                G: [46, 60],
                O: [61, 75]
            };
            
            for (let cardId = 1; cardId <= count; cardId++) {
                const card = { id: cardId, numbers: {} };
                
                for (let col = 0; col < 5; col++) {
                    const letter = Object.keys(ranges)[col];
                    const [min, max] = ranges[letter];
                    const columnNumbers = [];
                    
                    while (columnNumbers.length < 5) {
                        const num = Math.floor(Math.random() * (max - min + 1)) + min;
                        if (!columnNumbers.includes(num)) {
                            columnNumbers.push(num);
                        }
                    }
                    
                    card.numbers[letter] = columnNumbers;
                }
                
                // Set center cell based on FREE cell setting
                const freeText = gameState.settings.customization.freeCellEnabled ? 
                    gameState.settings.customization.freeCellText : 
                    card.numbers.N[2]; // Keep the number if FREE is disabled
                card.numbers.N[2] = freeText;
                
                cards.push(card);
            }
            
            return cards;
        }
        
        function generate4DPassword() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }
        
        function assignCardsToPlayer(player, cardsPool, count) {
            const assignedCards = [];
            const cardsToAssign = count || gameState.settings.cardsPerPlayer;
            
            const availableCards = cardsPool.filter(card => 
                !gameState.players.some(p => 
                    p !== player && p.cards && p.cards.some(c => c.id === card.id)
                )
            );
            
            const cardsToUse = availableCards.length >= cardsToAssign ? availableCards : cardsPool;
            
            if (player.cards && player.cards.length > 0) {
                assignedCards.push(...player.cards.slice(0, Math.min(cardsToAssign, player.cards.length)));
            }
            
            for (let i = assignedCards.length; i < cardsToAssign; i++) {
                if (cardsToUse.length === 0) {
                    const newCard = generateNewBingoCard();
                    assignedCards.push(newCard);
                    continue;
                }
                
                const randomIndex = Math.floor(Math.random() * cardsToUse.length);
                const selectedCard = cardsToUse[randomIndex];
                assignedCards.push(selectedCard);
                cardsToUse.splice(randomIndex, 1);
            }
            
            player.cards = assignedCards;
            return assignedCards;
        }
        
        function generateNewBingoCard() {
            const ranges = {
                B: [1, 15],
                I: [16, 30],
                N: [31, 45],
                G: [46, 60],
                O: [61, 75]
            };
            
            const card = { id: Date.now(), numbers: {} };
            
            for (let col = 0; col < 5; col++) {
                const letter = Object.keys(ranges)[col];
                const [min, max] = ranges[letter];
                const columnNumbers = [];
                
                while (columnNumbers.length < 5) {
                    const num = Math.floor(Math.random() * (max - min + 1)) + min;
                    if (!columnNumbers.includes(num)) {
                        columnNumbers.push(num);
                    }
                }
                
                card.numbers[letter] = columnNumbers;
            }
            
            // Set center cell based on FREE cell setting
            const freeText = gameState.settings.customization.freeCellEnabled ? 
                gameState.settings.customization.freeCellText : 
                card.numbers.N[2];
            card.numbers.N[2] = freeText;
            
            return card;
        }
        
        function updatePlayerCardsForAllPlayers(newCardsPerPlayer) {
            const totalCardsNeeded = gameState.settings.maxPlayers * newCardsPerPlayer;
            const cardsPool = generateBingoCards(totalCardsNeeded);
            
            gameState.players.forEach(player => {
                if (!player.luckyNumber) {
                    player.luckyNumber = generate4DPassword();
                }
                
                assignCardsToPlayer(player, cardsPool, newCardsPerPlayer);
            });
            
            if (gameState.currentPlayer) {
                const currentPlayerUpdated = gameState.players.find(p => 
                    p.name.toLowerCase() === gameState.currentPlayer.name.toLowerCase()
                );
                
                if (currentPlayerUpdated) {
                    gameState.currentPlayer = currentPlayerUpdated;
                    document.getElementById('displayPlayerName').textContent = currentPlayerUpdated.name;
                    document.getElementById('totalCards').textContent = currentPlayerUpdated.cards.length;
                    
                    if (gameState.currentCardIndex >= currentPlayerUpdated.cards.length) {
                        gameState.currentCardIndex = Math.max(0, currentPlayerUpdated.cards.length - 1);
                    }
                    
                    updateCardDisplay();
                    updatePasswordDisplay();
                }
            }
            
            savePlayerData();
        }
        
        function updateCardDisplay() {
            if (!gameState.currentPlayer || !gameState.currentPlayer.cards) return;
            
            const card = gameState.currentPlayer.cards[gameState.currentCardIndex];
            if (!card) return;
            
            const bingoGrid = document.getElementById('bingoGrid');
            const currentCardSpan = document.getElementById('currentCard');
            
            currentCardSpan.textContent = gameState.currentCardIndex + 1;
            bingoGrid.innerHTML = '';
            
            const letters = ['B', 'I', 'N', 'G', 'O'];
            const customization = gameState.settings.customization;
            
            // Apply cell spacing
            bingoGrid.style.gap = customization.cellSpacing + 'px';
            
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    const cell = document.createElement('div');
                    const letter = letters[col];
                    let number = card.numbers[letter][row];
                    
                    cell.className = 'bingo-cell';
                    cell.textContent = number;
                    
                    // Apply cell number color
                    cell.style.color = customization.cellNumberColor;
                    
                    // Apply cell font size
                    cell.style.fontSize = customization.cellFontSize + 'px';
                    
                    // Apply cell background color with transparency
                    let bgColor = customization.cellBackgroundColor;
                    if (customization.cellTransparentEnabled) {
                        const alpha = (100 - customization.cellTransparency) / 100;
                        bgColor = hexToRgba(bgColor, alpha);
                    }
                    cell.style.backgroundColor = bgColor;
                    
                    // Apply cell border
                    if (customization.cellBorderEnabled) {
                        const borderAlpha = (100 - customization.cellBorderTransparency) / 100;
                        const borderColor = hexToRgba(customization.cellBorderColor, borderAlpha);
                        cell.style.border = `${customization.cellBorderThickness}px solid ${borderColor}`;
                    } else {
                        cell.style.border = 'none';
                    }
                    
                    // Check if this is the center cell
                    const isCenterCell = (col === 2 && row === 2);
                    
                    if (isCenterCell && customization.freeCellEnabled) {
                        cell.classList.add('free');
                        cell.style.backgroundColor = customization.freeCellColor;
                        cell.textContent = customization.freeCellText;
                        cell.style.color = '#333'; // FREE text always dark for visibility
                        
                        // Apply border to FREE cell too
                        if (customization.cellBorderEnabled) {
                            const borderAlpha = (100 - customization.cellBorderTransparency) / 100;
                            const borderColor = hexToRgba(customization.cellBorderColor, borderAlpha);
                            cell.style.border = `${customization.cellBorderThickness}px solid ${borderColor}`;
                        }
                    }
                    
                    cell.addEventListener('click', function() {
                        // Don't allow clicking on FREE cell if it's enabled
                        if (isCenterCell && customization.freeCellEnabled) return;
                        
                        this.classList.toggle('marked');
                        if (this.classList.contains('marked')) {
                            this.style.backgroundColor = customization.markedCellColor;
                            this.style.color = customization.buttonTextColor;
                        } else {
                            // Reapply transparency to unmarked cell
                            let bgColor = customization.cellBackgroundColor;
                            if (customization.cellTransparentEnabled) {
                                const alpha = (100 - customization.cellTransparency) / 100;
                                bgColor = hexToRgba(bgColor, alpha);
                            }
                            this.style.backgroundColor = bgColor;
                            this.style.color = customization.cellNumberColor;
                        }
                    });
                    
                    bingoGrid.appendChild(cell);
                }
            }
        }
        
        function hexToRgba(hex, alpha = 1) {
            // Remove # if present
            hex = hex.replace('#', '');
            
            // Parse r, g, b values
            let r, g, b;
            if (hex.length === 3) {
                r = parseInt(hex[0] + hex[0], 16);
                g = parseInt(hex[1] + hex[1], 16);
                b = parseInt(hex[2] + hex[2], 16);
            } else if (hex.length === 6) {
                r = parseInt(hex.substring(0, 2), 16);
                g = parseInt(hex.substring(2, 4), 16);
                b = parseInt(hex.substring(4, 6), 16);
            } else {
                return `rgba(255, 255, 255, ${alpha})`;
            }
            
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        
        function updatePasswordDisplay() {
            const passwordDisplay = document.getElementById('passwordDisplay');
            const luckyNumberSpan = document.getElementById('luckyNumber');
            
            if (gameState.currentPlayer && gameState.currentPlayer.luckyNumber) {
                passwordDisplay.style.display = 'block';
                luckyNumberSpan.textContent = gameState.currentPlayer.luckyNumber;
            } else {
                passwordDisplay.style.display = 'none';
            }
        }
        
        function clearAllPlayerData() {
            gameState.players = [];
            gameState.currentPlayer = null;
            gameState.currentCardIndex = 0;
            
            updatePlayersCount();
            savePlayerData();
            
            showCustomAlert(`
                <strong>All player data has been cleared!</strong><br><br>
                â¢ Player cards removed<br>
                â¢ Lucky 4D numbers reset<br>
                â¢ Authorized player list preserved<br><br>
                Players will receive new cards and Lucky 4D numbers on next login.
            `);
        }
        
        // ==================== COLOR VALIDATION FUNCTIONS ====================
        
        function isValidHexColor(color) {
            return /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(color);
        }
        
        function updateColorInputFromPicker(pickerId, textId) {
            const picker = document.getElementById(pickerId);
            const textInput = document.getElementById(textId);
            
            picker.addEventListener('input', function() {
                textInput.value = this.value;
            });
            
            textInput.addEventListener('input', function() {
                const color = this.value.trim();
                if (isValidHexColor(color)) {
                    picker.value = color;
                }
            });
            
            textInput.addEventListener('blur', function() {
                const color = this.value.trim();
                if (!isValidHexColor(color) && color !== '') {
                    showCustomAlert('Invalid color format. Please use #RRGGBB format (e.g., #FF0000 for red).');
                    this.value = picker.value;
                }
            });
        }
        
        // ==================== CUSTOMIZATION FUNCTIONS ====================
        
        function applyCustomizations() {
            const customization = gameState.settings.customization;
            
            // Apply game title icon
            const gameTitleElement = document.getElementById('gameTitle');
            if (customization.gameTitleIcon && customization.gameTitleIcon !== "") {
                gameTitleElement.innerHTML = `<i class="${customization.gameTitleIcon}"></i> ${customization.gameTitle}`;
            } else {
                gameTitleElement.textContent = customization.gameTitle;
            }
            
            // Apply header background
            const header = document.querySelector('.header');
            if (customization.headerTransparent) {
                header.style.background = 'transparent';
            } else if (customization.headerBackgroundImage) {
                header.style.background = `url('${customization.headerBackgroundImage}')`;
                header.style.backgroundSize = 'cover';
                header.style.backgroundPosition = 'center';
            } else {
                header.style.background = customization.headerBackgroundColor;
            }
            
            // Apply header text color
            header.style.color = customization.headerTextColor;
            
            // Apply main background
            if (customization.mainTransparent) {
                document.body.style.backgroundColor = 'transparent';
                document.body.style.backgroundImage = 'none';
            } else if (customization.mainBackgroundImage) {
                document.body.style.backgroundColor = 'transparent';
                document.body.style.backgroundImage = `url('${customization.mainBackgroundImage}')`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundAttachment = 'fixed';
            } else {
                document.body.style.backgroundImage = 'none';
                document.body.style.backgroundColor = customization.mainBackgroundColor;
            }
            
            // Apply card container background
            const cardContainer = document.getElementById('bingoCardContainer');
            if (customization.containerTransparent) {
                cardContainer.style.background = 'transparent';
                cardContainer.style.backgroundImage = 'none';
            } else if (customization.containerBackgroundImage) {
                cardContainer.style.background = `url('${customization.containerBackgroundImage}')`;
                cardContainer.style.backgroundSize = 'cover';
                cardContainer.style.backgroundPosition = 'center';
            } else {
                cardContainer.style.backgroundColor = customization.containerBackgroundColor;
                cardContainer.style.backgroundImage = 'none';
            }
            
            // Apply card background
            const bingoGrid = document.getElementById('bingoGrid');
            if (customization.cardBackgroundEnabled) {
                if (customization.cardBackgroundTransparent) {
                    bingoGrid.style.background = 'transparent';
                    bingoGrid.style.backgroundImage = 'none';
                } else if (customization.cardBackgroundImage) {
                    bingoGrid.style.background = `url('${customization.cardBackgroundImage}')`;
                    bingoGrid.style.backgroundSize = 'cover';
                    bingoGrid.style.backgroundPosition = 'center';
                } else {
                    bingoGrid.style.background = customization.cardBackgroundColor;
                    bingoGrid.style.backgroundImage = 'none';
                }
            } else {
                bingoGrid.style.background = 'none';
                bingoGrid.style.backgroundImage = 'none';
            }
            
            // Apply cell spacing
            if (bingoGrid) {
                bingoGrid.style.gap = customization.cellSpacing + 'px';
            }
            
            // Apply button colors
            const primaryButtons = document.querySelectorAll('.btn-primary');
            primaryButtons.forEach(btn => {
                btn.style.backgroundColor = customization.primaryButtonColor;
                btn.style.color = customization.buttonTextColor;
            });
            
            const secondaryButtons = document.querySelectorAll('.btn-secondary');
            secondaryButtons.forEach(btn => {
                btn.style.backgroundColor = customization.secondaryButtonColor;
                btn.style.color = '#333';
            });
            
            const dangerButtons = document.querySelectorAll('.btn-danger');
            dangerButtons.forEach(btn => {
                btn.style.backgroundColor = customization.dangerButtonColor;
                btn.style.color = customization.buttonTextColor;
            });
            
            // Update text content
            document.getElementById('gameSubtitle').textContent = customization.gameSubtitle;
            document.getElementById('welcomeTitle').textContent = customization.welcomeTitle;
            document.getElementById('welcomeMessage').textContent = customization.welcomeMessage;
            document.getElementById('gameFooter').innerHTML = `<p>${customization.footerText}</p>`;
            
            const loginButton = document.getElementById('loginButton');
            if (loginButton) {
                loginButton.innerHTML = `<i class="fas fa-sign-in-alt"></i> ${customization.loginButtonText}`;
            }
            
            // Update card display if player is logged in
            if (gameState.currentPlayer) {
                updateCardDisplay();
            }
        }
        
        function loadImageAsBase64(fileInput, callback) {
            const file = fileInput.files[0];
            if (!file) {
                callback(null);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                callback(e.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        function updatePreview(elementId, imageData, isColor = false) {
            const preview = document.getElementById(elementId);
            if (!preview) return;
            
            if (isColor) {
                preview.style.background = imageData;
                preview.style.backgroundImage = 'none';
            } else if (imageData) {
                preview.style.backgroundImage = `url('${imageData}')`;
                preview.style.backgroundSize = 'cover';
                preview.style.backgroundPosition = 'center';
            } else {
                preview.style.background = '#f0f0f0';
                preview.style.backgroundImage = 'none';
            }
        }
        
        function loadCustomizationSettings() {
            const customization = gameState.settings.customization;
            
            // Load text fields
            document.getElementById('gameTitleText').value = customization.gameTitle;
            document.getElementById('gameTitleIcon').value = customization.gameTitleIcon || "";
            document.getElementById('gameSubtitleText').value = customization.gameSubtitle;
            document.getElementById('welcomeTitleText').value = customization.welcomeTitle;
            document.getElementById('welcomeMessageText').value = customization.welcomeMessage;
            document.getElementById('loginButtonText').value = customization.loginButtonText;
            document.getElementById('footerText').value = customization.footerText;
            document.getElementById('freeCellText').value = customization.freeCellText;
            
            // Load color pickers and text inputs
            document.getElementById('headerBackgroundColor').value = customization.headerBackgroundColor;
            document.getElementById('headerBackgroundColorText').value = customization.headerBackgroundColor;
            document.getElementById('headerTextColor').value = customization.headerTextColor;
            document.getElementById('headerTextColorText').value = customization.headerTextColor;
            document.getElementById('headerTransparent').checked = customization.headerTransparent;
            
            document.getElementById('mainBackgroundColor').value = customization.mainBackgroundColor;
            document.getElementById('mainBackgroundColorText').value = customization.mainBackgroundColor;
            document.getElementById('mainTransparent').checked = customization.mainTransparent;
            
            document.getElementById('containerBackgroundColor').value = customization.containerBackgroundColor;
            document.getElementById('containerBackgroundColorText').value = customization.containerBackgroundColor;
            document.getElementById('containerTransparent').checked = customization.containerTransparent;
            
            document.getElementById('cardBackgroundColor').value = customization.cardBackgroundColor;
            document.getElementById('cardBackgroundColorText').value = customization.cardBackgroundColor;
            document.getElementById('cardBackgroundEnabled').checked = customization.cardBackgroundEnabled;
            document.getElementById('cardBackgroundTransparent').checked = customization.cardBackgroundTransparent;
            
            document.getElementById('cellBackgroundColor').value = customization.cellBackgroundColor;
            document.getElementById('cellBackgroundColorText').value = customization.cellBackgroundColor;
            document.getElementById('cellTransparentEnabled').checked = customization.cellTransparentEnabled;
            document.getElementById('cellTransparency').value = customization.cellTransparency;
            document.getElementById('cellTransparencyValue').textContent = customization.cellTransparency + '%';
            
            document.getElementById('cellNumberColor').value = customization.cellNumberColor;
            document.getElementById('cellNumberColorText').value = customization.cellNumberColor;
            document.getElementById('cellFontSize').value = customization.cellFontSize;
            document.getElementById('cellFontSizeValue').textContent = customization.cellFontSize + 'px';
            document.getElementById('cellSpacing').value = customization.cellSpacing;
            document.getElementById('cellSpacingValue').textContent = customization.cellSpacing + 'px';
            
            document.getElementById('freeCellEnabled').checked = customization.freeCellEnabled;
            document.getElementById('freeCellColor').value = customization.freeCellColor;
            document.getElementById('freeCellColorText').value = customization.freeCellColor;
            document.getElementById('markedCellColor').value = customization.markedCellColor;
            document.getElementById('markedCellColorText').value = customization.markedCellColor;
            
            document.getElementById('cellBorderEnabled').checked = customization.cellBorderEnabled;
            document.getElementById('cellBorderColor').value = customization.cellBorderColor;
            document.getElementById('cellBorderColorText').value = customization.cellBorderColor;
            document.getElementById('cellBorderThickness').value = customization.cellBorderThickness;
            document.getElementById('cellBorderThicknessValue').textContent = customization.cellBorderThickness + 'px';
            document.getElementById('cellBorderTransparency').value = customization.cellBorderTransparency;
            document.getElementById('cellBorderTransparencyValue').textContent = customization.cellBorderTransparency + '%';
            
            document.getElementById('primaryButtonColor').value = customization.primaryButtonColor;
            document.getElementById('primaryButtonColorText').value = customization.primaryButtonColor;
            document.getElementById('secondaryButtonColor').value = customization.secondaryButtonColor;
            document.getElementById('secondaryButtonColorText').value = customization.secondaryButtonColor;
            document.getElementById('dangerButtonColor').value = customization.dangerButtonColor;
            document.getElementById('dangerButtonColorText').value = customization.dangerButtonColor;
            document.getElementById('buttonTextColor').value = customization.buttonTextColor;
            document.getElementById('buttonTextColorText').value = customization.buttonTextColor;
            
            // Load Firebase config
            const savedConfig = localStorage.getItem('firebaseConfig');
            const savedPath = localStorage.getItem('firebasePath') || DEFAULT_FIREBASE_PATH;
            
            if (savedConfig) {
                document.getElementById('firebaseConfig').value = savedConfig;
            } else {
                document.getElementById('firebaseConfig').value = JSON.stringify(DEFAULT_FIREBASE_CONFIG, null, 2);
            }
            document.getElementById('firebasePath').value = savedPath;
            
            // Show/hide dependent fields
            toggleCellTransparencyGroup();
            toggleFreeCellTextGroup();
            toggleCellBorderGroups();
            
            // Update previews
            updatePreview('headerBackgroundPreview', customization.headerBackgroundImage);
            updatePreview('mainBackgroundPreview', customization.mainBackgroundImage);
            updatePreview('containerBackgroundPreview', customization.containerBackgroundImage);
            updatePreview('cardBackgroundPreview', customization.cardBackgroundImage);
        }
        
        function toggleCellTransparencyGroup() {
            const enabled = document.getElementById('cellTransparentEnabled').checked;
            document.getElementById('cellTransparencyGroup').style.display = enabled ? 'block' : 'none';
        }
        
        function toggleFreeCellTextGroup() {
            const enabled = document.getElementById('freeCellEnabled').checked;
            document.getElementById('freeCellTextGroup').style.display = enabled ? 'block' : 'none';
        }
        
        function toggleCellBorderGroups() {
            const enabled = document.getElementById('cellBorderEnabled').checked;
            document.getElementById('cellBorderColorGroup').style.display = enabled ? 'flex' : 'none';
            document.getElementById('cellBorderThicknessGroup').style.display = enabled ? 'block' : 'none';
            document.getElementById('cellBorderTransparencyGroup').style.display = enabled ? 'block' : 'none';
        }
        
        // ==================== UI FUNCTIONS ====================
        
        function showScreen(screenId) {
            ['loginScreen', 'gameScreen', 'adminScreen'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = id === screenId ? 'block' : 'none';
                }
            });
        }
        
        function updatePlayersCount() {
            const currentPlayersElement = document.getElementById('currentPlayers');
            const maxPlayersElement = document.getElementById('maxPlayers');
            
            if (currentPlayersElement) {
                currentPlayersElement.textContent = gameState.players.length;
            }
            if (maxPlayersElement) {
                maxPlayersElement.textContent = gameState.settings.maxPlayers;
            }
        }
        
        function showConfirmationDialog(playerName) {
            document.getElementById('returningPlayerName').textContent = playerName;
            document.getElementById('confirmationDialog').style.display = 'flex';
        }
        
        function hideConfirmationDialog() {
            document.getElementById('confirmationDialog').style.display = 'none';
        }
        
        function showCustomAlert(message, isFirstTime = false) {
            const dialog = document.createElement('div');
            dialog.className = 'confirmation-dialog';
            dialog.style.display = 'flex';
            
            const content = document.createElement('div');
            content.className = 'confirmation-content';
            
            let icon = '<i class="fas fa-info-circle"></i>';
            let title = 'Information';
            let buttons = `
                <div class="confirmation-buttons">
                    <button class="btn btn-primary" id="customAlertOkBtn">
                        OK
                    </button>
                </div>
            `;
            
            if (isFirstTime) {
                icon = '<i class="fas fa-gift"></i>';
                title = 'Welcome!';
                buttons = `
                    <div class="confirmation-buttons">
                        <button class="btn btn-primary" id="customAlertOkBtn">
                            <i class="fas fa-thumbs-up"></i> Got it!
                        </button>
                    </div>
                `;
            }
            
            content.innerHTML = `
                <h3>${icon} ${title}</h3>
                <div style="text-align: left; line-height: 1.6;">
                    ${message}
                </div>
                ${buttons}
            `;
            
            dialog.appendChild(content);
            document.body.appendChild(dialog);
            
            document.getElementById('customAlertOkBtn').addEventListener('click', function() {
                document.body.removeChild(dialog);
            });
        }
        
        // ==================== EVENT HANDLERS ====================
        
        function setupEventListeners() {
            // Login form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            // Navigation buttons
            const prevBtn = document.getElementById('prevCardBtn');
            const nextBtn = document.getElementById('nextCardBtn');
            if (prevBtn) prevBtn.addEventListener('click', showPrevCard);
            if (nextBtn) nextBtn.addEventListener('click', showNextCard);
            
            // Admin logout button
            const adminLogoutBtn = document.getElementById('adminLogoutBtn');
            if (adminLogoutBtn) adminLogoutBtn.addEventListener('click', handleAdminLogout);
            
            // Confirmation dialog buttons
            document.getElementById('confirmReturningPlayerBtn').addEventListener('click', function() {
                hideConfirmationDialog();
                loginAsReturningPlayer();
            });
            
            document.getElementById('confirmNewPlayerBtn').addEventListener('click', function() {
                hideConfirmationDialog();
                const playerNameInput = document.getElementById('playerName');
                const playerPasswordInput = document.getElementById('playerPassword');
                if (playerNameInput) {
                    playerNameInput.value = '';
                    playerNameInput.focus();
                }
                if (playerPasswordInput) {
                    playerPasswordInput.value = '';
                }
            });
            
            // Admin controls
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', saveAdminSettings);
            }
            
            // Firebase buttons
            document.getElementById('connectFirebaseBtn').addEventListener('click', function() {
                if (saveFirebaseConfig()) {
                    if (initializeFirebase()) {
                        showCustomAlert('Firebase connected successfully! Real-time updates are now active.');
                    }
                }
            });
            
            document.getElementById('testFirebaseBtn').addEventListener('click', function() {
                if (saveFirebaseConfig()) {
                    if (initializeFirebase()) {
                        // Test by pushing a small test object
                        const testRef = firebaseDatabase.ref('bingo/test');
                        testRef.set({
                            test: true,
                            timestamp: Date.now()
                        }).then(() => {
                            showCustomAlert('Firebase connection test successful! Data written and read successfully.');
                        }).catch((error) => {
                            showCustomAlert('Firebase test failed: ' + error.message);
                        });
                    }
                }
            });
            
            document.getElementById('forceSyncBtn').addEventListener('click', function() {
                pushSettingsToFirebase();
            });
            
            document.getElementById('pullFromFirebaseBtn').addEventListener('click', function() {
                pullSettingsFromFirebase();
            });
            
            // Clear player data button
            const clearPlayerDataBtn = document.getElementById('clearPlayerDataBtn');
            if (clearPlayerDataBtn) {
                clearPlayerDataBtn.addEventListener('click', confirmClearPlayerData);
            }
            
            // Clear cache button
            const clearCacheBtn = document.getElementById('clearCacheBtn');
            if (clearCacheBtn) {
                clearCacheBtn.addEventListener('click', function() {
                    const dialog = document.createElement('div');
                    dialog.className = 'confirmation-dialog';
                    dialog.style.display = 'flex';
                    
                    const content = document.createElement('div');
                    content.className = 'confirmation-content';
                    
                    content.innerHTML = `
                        <h3><i class="fas fa-sync-alt" style="color: #ffc107;"></i> Clear Cache & Refresh</h3>
                        <div style="text-align: left; line-height: 1.6;">
                            <strong>This will:</strong><br>
                            1. Clear browser cache for this page<br>
                            2. Force a fresh reload from server<br>
                            3. Preserve your game data (players, cards, settings)<br><br>
                            Use this if you see old versions of the game.<br>
                            Continue?
                        </div>
                        <div class="confirmation-buttons">
                            <button class="btn btn-secondary" id="cancelCacheBtn">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button class="btn btn-warning" id="confirmCacheBtn">
                                <i class="fas fa-sync-alt"></i> Clear & Refresh
                            </button>
                        </div>
                    `;
                    
                    dialog.appendChild(content);
                    document.body.appendChild(dialog);
                    
                    document.getElementById('cancelCacheBtn').addEventListener('click', function() {
                        document.body.removeChild(dialog);
                    });
                    
                    document.getElementById('confirmCacheBtn').addEventListener('click', function() {
                        // Add a cache-busting parameter to force fresh load
                        const url = new URL(window.location.href);
                        url.searchParams.set('nocache', Date.now());
                        
                        // Save current game state
                        saveMasterSettings();
                        savePlayerData();
                        
                        // Redirect with cache-busting parameter
                        window.location.href = url.toString();
                    });
                });
            }
            
            // File upload handlers
            document.getElementById('headerBackgroundUpload').addEventListener('change', function() {
                loadImageAsBase64(this, function(base64) {
                    gameState.settings.customization.headerBackgroundImage = base64;
                    gameState.settings.customization.headerTransparent = false;
                    document.getElementById('headerTransparent').checked = false;
                    updatePreview('headerBackgroundPreview', base64);
                });
            });
            
            document.getElementById('mainBackgroundUpload').addEventListener('change', function() {
                loadImageAsBase64(this, function(base64) {
                    gameState.settings.customization.mainBackgroundImage = base64;
                    gameState.settings.customization.mainTransparent = false;
                    document.getElementById('mainTransparent').checked = false;
                    updatePreview('mainBackgroundPreview', base64);
                });
            });
            
            document.getElementById('containerBackgroundUpload').addEventListener('change', function() {
                loadImageAsBase64(this, function(base64) {
                    gameState.settings.customization.containerBackgroundImage = base64;
                    gameState.settings.customization.containerTransparent = false;
                    document.getElementById('containerTransparent').checked = false;
                    updatePreview('containerBackgroundPreview', base64);
                });
            });
            
            document.getElementById('cardBackgroundUpload').addEventListener('change', function() {
                loadImageAsBase64(this, function(base64) {
                    gameState.settings.customization.cardBackgroundImage = base64;
                    gameState.settings.customization.cardBackgroundTransparent = false;
                    document.getElementById('cardBackgroundTransparent').checked = false;
                    updatePreview('cardBackgroundPreview', base64);
                });
            });
            
            // Setup color input synchronization
            updateColorInputFromPicker('headerBackgroundColor', 'headerBackgroundColorText');
            updateColorInputFromPicker('headerTextColor', 'headerTextColorText');
            updateColorInputFromPicker('mainBackgroundColor', 'mainBackgroundColorText');
            updateColorInputFromPicker('containerBackgroundColor', 'containerBackgroundColorText');
            updateColorInputFromPicker('cardBackgroundColor', 'cardBackgroundColorText');
            updateColorInputFromPicker('cellBackgroundColor', 'cellBackgroundColorText');
            updateColorInputFromPicker('cellNumberColor', 'cellNumberColorText');
            updateColorInputFromPicker('markedCellColor', 'markedCellColorText');
            updateColorInputFromPicker('freeCellColor', 'freeCellColorText');
            updateColorInputFromPicker('cellBorderColor', 'cellBorderColorText');
            updateColorInputFromPicker('primaryButtonColor', 'primaryButtonColorText');
            updateColorInputFromPicker('secondaryButtonColor', 'secondaryButtonColorText');
            updateColorInputFromPicker('dangerButtonColor', 'dangerButtonColorText');
            updateColorInputFromPicker('buttonTextColor', 'buttonTextColorText');
            
            // Cell number customization handlers
            document.getElementById('cellNumberColor').addEventListener('change', function() {
                gameState.settings.customization.cellNumberColor = this.value;
            });
            
            document.getElementById('cellFontSize').addEventListener('input', function() {
                const value = this.value;
                gameState.settings.customization.cellFontSize = parseInt(value);
                document.getElementById('cellFontSizeValue').textContent = value + 'px';
            });
            
            document.getElementById('cellSpacing').addEventListener('input', function() {
                const value = this.value;
                gameState.settings.customization.cellSpacing = parseInt(value);
                document.getElementById('cellSpacingValue').textContent = value + 'px';
            });
            
            // Cell transparency handlers
            document.getElementById('cellTransparentEnabled').addEventListener('change', function() {
                gameState.settings.customization.cellTransparentEnabled = this.checked;
                toggleCellTransparencyGroup();
            });
            
            document.getElementById('cellTransparency').addEventListener('input', function() {
                const value = this.value;
                gameState.settings.customization.cellTransparency = parseInt(value);
                document.getElementById('cellTransparencyValue').textContent = value + '%';
            });
            
            // FREE cell handlers
            document.getElementById('freeCellEnabled').addEventListener('change', function() {
                gameState.settings.customization.freeCellEnabled = this.checked;
                toggleFreeCellTextGroup();
            });
            
            document.getElementById('freeCellText').addEventListener('change', function() {
                gameState.settings.customization.freeCellText = this.value;
            });
            
            // Cell border handlers
            document.getElementById('cellBorderEnabled').addEventListener('change', function() {
                gameState.settings.customization.cellBorderEnabled = this.checked;
                toggleCellBorderGroups();
            });
            
            document.getElementById('cellBorderColor').addEventListener('change', function() {
                gameState.settings.customization.cellBorderColor = this.value;
            });
            
            document.getElementById('cellBorderThickness').addEventListener('input', function() {
                const value = this.value;
                gameState.settings.customization.cellBorderThickness = parseInt(value);
                document.getElementById('cellBorderThicknessValue').textContent = value + 'px';
            });
            
            document.getElementById('cellBorderTransparency').addEventListener('input', function() {
                const value = this.value;
                gameState.settings.customization.cellBorderTransparency = parseInt(value);
                document.getElementById('cellBorderTransparencyValue').textContent = value + '%';
            });
            
            // Color picker handlers
            document.getElementById('headerBackgroundColor').addEventListener('change', function() {
                gameState.settings.customization.headerBackgroundImage = null;
                gameState.settings.customization.headerBackgroundColor = this.value;
                gameState.settings.customization.headerTransparent = false;
                document.getElementById('headerTransparent').checked = false;
                updatePreview('headerBackgroundPreview', this.value, true);
            });
            
            document.getElementById('headerTextColor').addEventListener('change', function() {
                gameState.settings.customization.headerTextColor = this.value;
            });
            
            document.getElementById('headerTransparent').addEventListener('change', function() {
                gameState.settings.customization.headerTransparent = this.checked;
                if (this.checked) {
                    gameState.settings.customization.headerBackgroundImage = null;
                }
            });
            
            document.getElementById('mainBackgroundColor').addEventListener('change', function() {
                gameState.settings.customization.mainBackgroundImage = null;
                gameState.settings.customization.mainBackgroundColor = this.value;
                gameState.settings.customization.mainTransparent = false;
                document.getElementById('mainTransparent').checked = false;
                updatePreview('mainBackgroundPreview', this.value, true);
            });
            
            document.getElementById('mainTransparent').addEventListener('change', function() {
                gameState.settings.customization.mainTransparent = this.checked;
                if (this.checked) {
                    gameState.settings.customization.mainBackgroundImage = null;
                }
            });
            
            document.getElementById('containerBackgroundColor').addEventListener('change', function() {
                gameState.settings.customization.containerBackgroundImage = null;
                gameState.settings.customization.containerBackgroundColor = this.value;
                gameState.settings.customization.containerTransparent = false;
                document.getElementById('containerTransparent').checked = false;
                updatePreview('containerBackgroundPreview', this.value, true);
            });
            
            document.getElementById('containerTransparent').addEventListener('change', function() {
                gameState.settings.customization.containerTransparent = this.checked;
                if (this.checked) {
                    gameState.settings.customization.containerBackgroundImage = null;
                }
            });
            
            document.getElementById('cardBackgroundColor').addEventListener('change', function() {
                gameState.settings.customization.cardBackgroundImage = null;
                gameState.settings.customization.cardBackgroundColor = this.value;
                gameState.settings.customization.cardBackgroundTransparent = false;
                document.getElementById('cardBackgroundTransparent').checked = false;
                updatePreview('cardBackgroundPreview', this.value, true);
            });
            
            document.getElementById('cardBackgroundEnabled').addEventListener('change', function() {
                gameState.settings.customization.cardBackgroundEnabled = this.checked;
            });
            
            document.getElementById('cardBackgroundTransparent').addEventListener('change', function() {
                gameState.settings.customization.cardBackgroundTransparent = this.checked;
                if (this.checked) {
                    gameState.settings.customization.cardBackgroundImage = null;
                }
            });
            
            document.getElementById('cellBackgroundColor').addEventListener('change', function() {
                gameState.settings.customization.cellBackgroundColor = this.value;
            });
            
            document.getElementById('markedCellColor').addEventListener('change', function() {
                gameState.settings.customization.markedCellColor = this.value;
            });
            
            document.getElementById('freeCellColor').addEventListener('change', function() {
                gameState.settings.customization.freeCellColor = this.value;
            });
            
            document.getElementById('primaryButtonColor').addEventListener('change', function() {
                gameState.settings.customization.primaryButtonColor = this.value;
            });
            
            document.getElementById('secondaryButtonColor').addEventListener('change', function() {
                gameState.settings.customization.secondaryButtonColor = this.value;
            });
            
            document.getElementById('dangerButtonColor').addEventListener('change', function() {
                gameState.settings.customization.dangerButtonColor = this.value;
            });
            
            document.getElementById('buttonTextColor').addEventListener('change', function() {
                gameState.settings.customization.buttonTextColor = this.value;
            });
            
            // Text field handlers
            document.getElementById('gameTitleText').addEventListener('change', function() {
                gameState.settings.customization.gameTitle = this.value;
            });
            
            document.getElementById('gameTitleIcon').addEventListener('change', function() {
                gameState.settings.customization.gameTitleIcon = this.value;
            });
            
            document.getElementById('gameSubtitleText').addEventListener('change', function() {
                gameState.settings.customization.gameSubtitle = this.value;
            });
            
            document.getElementById('welcomeTitleText').addEventListener('change', function() {
                gameState.settings.customization.welcomeTitle = this.value;
            });
            
            document.getElementById('welcomeMessageText').addEventListener('change', function() {
                gameState.settings.customization.welcomeMessage = this.value;
            });
            
            document.getElementById('loginButtonText').addEventListener('change', function() {
                gameState.settings.customization.loginButtonText = this.value;
            });
            
            document.getElementById('footerText').addEventListener('change', function() {
                gameState.settings.customization.footerText = this.value;
            });
            
            // Reset buttons
            document.getElementById('resetHeaderBtn').addEventListener('click', function() {
                gameState.settings.customization.headerBackgroundImage = null;
                gameState.settings.customization.headerBackgroundColor = "#6a11cb";
                gameState.settings.customization.headerTextColor = "#ffffff";
                gameState.settings.customization.headerTransparent = false;
                
                document.getElementById('headerBackgroundColor').value = "#6a11cb";
                document.getElementById('headerBackgroundColorText').value = "#6a11cb";
                document.getElementById('headerTextColor').value = "#ffffff";
                document.getElementById('headerTextColorText').value = "#ffffff";
                document.getElementById('headerTransparent').checked = false;
                
                updatePreview('headerBackgroundPreview', "#6a11cb", true);
            });
            
            document.getElementById('resetMainBackgroundBtn').addEventListener('click', function() {
                gameState.settings.customization.mainBackgroundImage = null;
                gameState.settings.customization.mainBackgroundColor = "#f5f5f5";
                gameState.settings.customization.mainTransparent = false;
                
                document.getElementById('mainBackgroundColor').value = "#f5f5f5";
                document.getElementById('mainBackgroundColorText').value = "#f5f5f5";
                document.getElementById('mainTransparent').checked = false;
                
                updatePreview('mainBackgroundPreview', "#f5f5f5", true);
            });
            
            document.getElementById('resetContainerBackgroundBtn').addEventListener('click', function() {
                gameState.settings.customization.containerBackgroundImage = null;
                gameState.settings.customization.containerBackgroundColor = "#f8f9fa";
                gameState.settings.customization.containerTransparent = false;
                
                document.getElementById('containerBackgroundColor').value = "#f8f9fa";
                document.getElementById('containerBackgroundColorText').value = "#f8f9fa";
                document.getElementById('containerTransparent').checked = false;
                
                updatePreview('containerBackgroundPreview', "#f8f9fa", true);
            });
            
            document.getElementById('resetCardBackgroundBtn').addEventListener('click', function() {
                gameState.settings.customization.cardBackgroundImage = null;
                gameState.settings.customization.cardBackgroundColor = "#f8f9fa";
                gameState.settings.customization.cardBackgroundEnabled = true;
                gameState.settings.customization.cardBackgroundTransparent = false;
                
                document.getElementById('cardBackgroundColor').value = "#f8f9fa";
                document.getElementById('cardBackgroundColorText').value = "#f8f9fa";
                document.getElementById('cardBackgroundEnabled').checked = true;
                document.getElementById('cardBackgroundTransparent').checked = false;
                
                updatePreview('cardBackgroundPreview', "#f8f9fa", true);
            });
            
            document.getElementById('resetCellNumberBtn').addEventListener('click', function() {
                gameState.settings.customization.cellNumberColor = "#333333";
                gameState.settings.customization.cellFontSize = 18;
                gameState.settings.customization.cellSpacing = 8;
                
                document.getElementById('cellNumberColor').value = "#333333";
                document.getElementById('cellNumberColorText').value = "#333333";
                document.getElementById('cellFontSize').value = 18;
                document.getElementById('cellFontSizeValue').textContent = "18px";
                document.getElementById('cellSpacing').value = 8;
                document.getElementById('cellSpacingValue').textContent = "8px";
            });
            
            document.getElementById('resetCellBorderBtn').addEventListener('click', function() {
                gameState.settings.customization.cellBorderEnabled = false;
                gameState.settings.customization.cellBorderColor = "#cccccc";
                gameState.settings.customization.cellBorderThickness = 2;
                gameState.settings.customization.cellBorderTransparency = 0;
                
                document.getElementById('cellBorderEnabled').checked = false;
                document.getElementById('cellBorderColor').value = "#cccccc";
                document.getElementById('cellBorderColorText').value = "#cccccc";
                document.getElementById('cellBorderThickness').value = 2;
                document.getElementById('cellBorderThicknessValue').textContent = "2px";
                document.getElementById('cellBorderTransparency').value = 0;
                document.getElementById('cellBorderTransparencyValue').textContent = "0%";
                
                toggleCellBorderGroups();
            });
            
            document.getElementById('resetButtonsBtn').addEventListener('click', function() {
                gameState.settings.customization.primaryButtonColor = "#6a11cb";
                gameState.settings.customization.secondaryButtonColor = "#f0f0f0";
                gameState.settings.customization.dangerButtonColor = "#dc3545";
                gameState.settings.customization.buttonTextColor = "#ffffff";
                
                document.getElementById('primaryButtonColor').value = "#6a11cb";
                document.getElementById('primaryButtonColorText').value = "#6a11cb";
                document.getElementById('secondaryButtonColor').value = "#f0f0f0";
                document.getElementById('secondaryButtonColorText').value = "#f0f0f0";
                document.getElementById('dangerButtonColor').value = "#dc3545";
                document.getElementById('dangerButtonColorText').value = "#dc3545";
                document.getElementById('buttonTextColor').value = "#ffffff";
                document.getElementById('buttonTextColorText').value = "#ffffff";
            });
        }
        
        // ==================== GAME LOGIC FUNCTIONS ====================
        
        function handleLogin(e) {
            e.preventDefault();
            
            const playerNameInput = document.getElementById('playerName');
            const playerPasswordInput = document.getElementById('playerPassword');
            const playerName = playerNameInput ? playerNameInput.value.trim() : '';
            const password = playerPasswordInput ? playerPasswordInput.value.trim() : '';
            
            if (!playerName) {
                showCustomAlert('Please enter your name');
                return;
            }
            
            if (!password) {
                showCustomAlert('Please enter your password');
                return;
            }
            
            // Check for admin login
            if (playerName.toLowerCase() === ADMIN_CREDENTIALS.id) {
                if (password === ADMIN_CREDENTIALS.password) {
                    showScreen('adminScreen');
                    // Load current settings into admin panel
                    loadAdminSettings();
                    if (playerNameInput) playerNameInput.value = '';
                    if (playerPasswordInput) playerPasswordInput.value = '';
                } else {
                    showCustomAlert('Invalid admin password');
                }
                return;
            }
            
            // Check if player name is authorized (case-insensitive)
            const isAuthorized = gameState.settings.authorizedPlayers.some(name => 
                name.trim().toLowerCase() === playerName.toLowerCase()
            );
            
            if (!isAuthorized) {
                showCustomAlert(`Sorry, "${playerName}" is not on the authorized players list.`);
                return;
            }
            
            // Check password
            if (password !== gameState.settings.defaultPassword) {
                showCustomAlert('Incorrect password. Please try again.');
                return;
            }
            
            // Store the name being attempted
            pendingLoginName = playerName;
            
            // Check if name already exists (case-insensitive)
            existingPlayerFound = gameState.players.find(p => 
                p.name.toLowerCase() === playerName.toLowerCase()
            );
            
            if (existingPlayerFound) {
                // Player exists, show confirmation dialog
                showConfirmationDialog(playerName);
            } else {
                // New player, create account
                createNewPlayer(playerName);
            }
            
            // Clear input fields
            if (playerNameInput) playerNameInput.value = '';
            if (playerPasswordInput) playerPasswordInput.value = '';
        }
        
        function loginAsReturningPlayer() {
            if (!existingPlayerFound) return;
            
            gameState.currentPlayer = existingPlayerFound;
            gameState.currentCardIndex = 0;
            
            document.getElementById('displayPlayerName').textContent = existingPlayerFound.name;
            document.getElementById('totalCards').textContent = existingPlayerFound.cards.length;
            updateCardDisplay();
            updatePasswordDisplay();
            showScreen('gameScreen');
            
            // Reset tracking variables
            pendingLoginName = '';
            existingPlayerFound = null;
        }
        
        function createNewPlayer(playerName) {
            // Check player limit
            if (gameState.players.length >= gameState.settings.maxPlayers) {
                showCustomAlert(`Sorry, the game is full! Maximum ${gameState.settings.maxPlayers} players allowed.`);
                return;
            }
            
            // Generate cards pool (enough for all potential players)
            const totalCardsNeeded = gameState.settings.maxPlayers * gameState.settings.cardsPerPlayer;
            const cardsPool = generateBingoCards(totalCardsNeeded);
            
            // Generate a Lucky 4D number
            const luckyNumber = generate4DPassword();
            
            // Create player
            const newPlayer = {
                id: gameState.players.length + 1,
                name: playerName,
                luckyNumber: luckyNumber,
                cards: []
            };
            
            // Assign cards
            assignCardsToPlayer(newPlayer, cardsPool, gameState.settings.cardsPerPlayer);
            
            // Add to game state
            gameState.players.push(newPlayer);
            gameState.currentPlayer = newPlayer;
            gameState.currentCardIndex = 0;
            
            // Update UI
            document.getElementById('displayPlayerName').textContent = newPlayer.name;
            document.getElementById('totalCards').textContent = newPlayer.cards.length;
            updateCardDisplay();
            updatePasswordDisplay();
            updatePlayersCount();
            showScreen('gameScreen');
            
            // Save to localStorage
            savePlayerData();
            
            // Show welcome message with Lucky 4D number
            const welcomeMessage = `
                <strong>Welcome ${playerName}!</strong><br><br>
                You have received ${newPlayer.cards.length} BINGO cards.<br><br>
                <strong>Your Lucky 4D number: ${luckyNumber}</strong><br><br>
                Good luck and have fun!
            `;
            
            showCustomAlert(welcomeMessage, true);
        }
        
        function loadAdminSettings() {
            // Load current settings into admin panel
            const playerListTextarea = document.getElementById('playerList');
            const maxPlayersInput = document.getElementById('maxPlayers');
            const cardsPerPlayerInput = document.getElementById('cardsPerPlayer');
            const playerPasswordSettingInput = document.getElementById('playerPasswordSetting');
            
            if (playerListTextarea) {
                playerListTextarea.value = gameState.settings.authorizedPlayers.join(', ');
            }
            if (maxPlayersInput) {
                maxPlayersInput.value = gameState.settings.maxPlayers;
            }
            if (cardsPerPlayerInput) {
                cardsPerPlayerInput.value = gameState.settings.cardsPerPlayer;
            }
            if (playerPasswordSettingInput) {
                playerPasswordSettingInput.value = gameState.settings.defaultPassword;
            }
            
            // Load customization settings
            loadCustomizationSettings();
        }
        
        function saveAdminSettings() {
            const playerListTextarea = document.getElementById('playerList');
            const maxPlayersInput = document.getElementById('maxPlayers');
            const cardsPerPlayerInput = document.getElementById('cardsPerPlayer');
            const playerPasswordSettingInput = document.getElementById('playerPasswordSetting');
            
            if (!playerListTextarea || !maxPlayersInput || !cardsPerPlayerInput || !playerPasswordSettingInput) return;
            
            // Get player list
            const playerListText = playerListTextarea.value.trim();
            const playerNames = playerListText.split(',')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            
            // Get max players (1-100)
            let maxPlayers = parseInt(maxPlayersInput.value);
            if (isNaN(maxPlayers) || maxPlayers < 1) maxPlayers = 1;
            if (maxPlayers > 100) maxPlayers = 100;
            
            // Get cards per player (1-10)
            let cardsPerPlayer = parseInt(cardsPerPlayerInput.value);
            if (isNaN(cardsPerPlayer) || cardsPerPlayer < 1) cardsPerPlayer = 1;
            if (cardsPerPlayer > 10) cardsPerPlayer = 10;
            
            // Get default password
            const defaultPassword = playerPasswordSettingInput.value.trim();
            if (defaultPassword.length === 0) {
                showCustomAlert('Player password cannot be empty');
                return;
            }
            
            // Check if cards per player changed
            const cardsChanged = cardsPerPlayer !== gameState.settings.cardsPerPlayer;
            
            // Update settings
            gameState.settings.authorizedPlayers = playerNames;
            gameState.settings.maxPlayers = maxPlayers;
            gameState.settings.cardsPerPlayer = cardsPerPlayer;
            gameState.settings.defaultPassword = defaultPassword;
            
            // Update customization settings from form fields
            gameState.settings.customization.gameTitle = document.getElementById('gameTitleText').value;
            gameState.settings.customization.gameTitleIcon = document.getElementById('gameTitleIcon').value;
            gameState.settings.customization.gameSubtitle = document.getElementById('gameSubtitleText').value;
            gameState.settings.customization.welcomeTitle = document.getElementById('welcomeTitleText').value;
            gameState.settings.customization.welcomeMessage = document.getElementById('welcomeMessageText').value;
            gameState.settings.customization.loginButtonText = document.getElementById('loginButtonText').value;
            gameState.settings.customization.footerText = document.getElementById('footerText').value;
            gameState.settings.customization.freeCellText = document.getElementById('freeCellText').value;
            
            // Update toggle settings
            gameState.settings.customization.cellTransparentEnabled = document.getElementById('cellTransparentEnabled').checked;
            gameState.settings.customization.cellTransparency = parseInt(document.getElementById('cellTransparency').value);
            gameState.settings.customization.freeCellEnabled = document.getElementById('freeCellEnabled').checked;
            gameState.settings.customization.cellBorderEnabled = document.getElementById('cellBorderEnabled').checked;
            gameState.settings.customization.cellBorderThickness = parseInt(document.getElementById('cellBorderThickness').value);
            gameState.settings.customization.cellBorderTransparency = parseInt(document.getElementById('cellBorderTransparency').value);
            
            // Update cell number settings
            gameState.settings.customization.cellNumberColor = document.getElementById('cellNumberColor').value;
            gameState.settings.customization.cellFontSize = parseInt(document.getElementById('cellFontSize').value);
            gameState.settings.customization.cellSpacing = parseInt(document.getElementById('cellSpacing').value);
            
            // Update color settings from text inputs (validate first)
            const colorsToValidate = [
                { picker: 'headerBackgroundColorText', setting: 'headerBackgroundColor' },
                { picker: 'headerTextColorText', setting: 'headerTextColor' },
                { picker: 'mainBackgroundColorText', setting: 'mainBackgroundColor' },
                { picker: 'containerBackgroundColorText', setting: 'containerBackgroundColor' },
                { picker: 'cardBackgroundColorText', setting: 'cardBackgroundColor' },
                { picker: 'cellBackgroundColorText', setting: 'cellBackgroundColor' },
                { picker: 'cellNumberColorText', setting: 'cellNumberColor' },
                { picker: 'markedCellColorText', setting: 'markedCellColor' },
                { picker: 'freeCellColorText', setting: 'freeCellColor' },
                { picker: 'cellBorderColorText', setting: 'cellBorderColor' },
                { picker: 'primaryButtonColorText', setting: 'primaryButtonColor' },
                { picker: 'secondaryButtonColorText', setting: 'secondaryButtonColor' },
                { picker: 'dangerButtonColorText', setting: 'dangerButtonColor' },
                { picker: 'buttonTextColorText', setting: 'buttonTextColor' }
            ];
            
            let hasInvalidColor = false;
            colorsToValidate.forEach(color => {
                const colorValue = document.getElementById(color.picker).value.trim();
                if (colorValue && !isValidHexColor(colorValue)) {
                    showCustomAlert(`Invalid color format for ${color.setting}. Please use #RRGGBB format.`);
                    hasInvalidColor = true;
                    return;
                }
                if (colorValue) {
                    gameState.settings.customization[color.setting] = colorValue;
                }
            });
            
            if (hasInvalidColor) return;
            
            // Update transparency settings
            gameState.settings.customization.headerTransparent = document.getElementById('headerTransparent').checked;
            gameState.settings.customization.mainTransparent = document.getElementById('mainTransparent').checked;
            gameState.settings.customization.containerTransparent = document.getElementById('containerTransparent').checked;
            gameState.settings.customization.cardBackgroundEnabled = document.getElementById('cardBackgroundEnabled').checked;
            gameState.settings.customization.cardBackgroundTransparent = document.getElementById('cardBackgroundTransparent').checked;
            
            // Apply customizations immediately
            applyCustomizations();
            
            // Save to MASTER storage (this is what other players will load)
            saveMasterSettings();
            
            // Regenerate cards if FREE cell settings changed
            if (gameState.players.length > 0) {
                const totalCardsNeeded = gameState.settings.maxPlayers * gameState.settings.cardsPerPlayer;
                const cardsPool = generateBingoCards(totalCardsNeeded);
                
                gameState.players.forEach(player => {
                    assignCardsToPlayer(player, cardsPool, gameState.settings.cardsPerPlayer);
                });
                
                // Update current player display if logged in
                if (gameState.currentPlayer) {
                    updateCardDisplay();
                }
                
                // Save updated player data
                savePlayerData();
            }
            
            // If cards per player changed, update all players
            if (cardsChanged) {
                updatePlayerCardsForAllPlayers(cardsPerPlayer);
            }
            
            // Update players count display
            updatePlayersCount();
            
            let message = `
                <strong>Settings saved successfully!</strong><br><br>
                â¢ Authorized players: ${playerNames.length}<br>
                â¢ Maximum players: ${maxPlayers}<br>
                â¢ Cards per player: ${cardsPerPlayer}<br>
                â¢ Player password updated<br>
                â¢ Customization settings saved<br><br>
                <strong>Settings have been saved locally.</strong><br>
                Click "Push to Firebase" to update all connected players.
            `;
            
            if (cardsChanged) {
                message += `<br><br><strong>All player cards have been updated to ${cardsPerPlayer} cards per player.</strong>`;
            }
            
            showCustomAlert(message);
        }
        
        function handleAdminLogout() {
            // Check if any settings were changed
            const playerListTextarea = document.getElementById('playerList');
            const maxPlayersInput = document.getElementById('maxPlayers');
            const cardsPerPlayerInput = document.getElementById('cardsPerPlayer');
            const playerPasswordSettingInput = document.getElementById('playerPasswordSetting');
            
            if (!playerListTextarea || !maxPlayersInput || !cardsPerPlayerInput || !playerPasswordSettingInput) {
                showScreen('loginScreen');
                return;
            }
            
            // Check if settings were changed
            const playerListText = playerListTextarea.value.trim();
            const playerNames = playerListText.split(',')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            const playerNamesChanged = JSON.stringify(playerNames) !== JSON.stringify(gameState.settings.authorizedPlayers);
            
            const maxPlayers = parseInt(maxPlayersInput.value);
            const maxPlayersChanged = maxPlayers !== gameState.settings.maxPlayers;
            
            const cardsPerPlayer = parseInt(cardsPerPlayerInput.value);
            const cardsPerPlayerChanged = cardsPerPlayer !== gameState.settings.cardsPerPlayer;
            
            const defaultPassword = playerPasswordSettingInput.value.trim();
            const passwordChanged = defaultPassword !== gameState.settings.defaultPassword;
            
            const settingsChanged = playerNamesChanged || maxPlayersChanged || cardsPerPlayerChanged || passwordChanged;
            
            if (settingsChanged) {
                // Show confirmation dialog for unsaved changes
                const dialog = document.createElement('div');
                dialog.className = 'confirmation-dialog';
                dialog.style.display = 'flex';
                
                const content = document.createElement('div');
                content.className = 'confirmation-content';
                
                content.innerHTML = `
                    <h3><i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i> Unsaved Changes</h3>
                    <div style="text-align: left; line-height: 1.6;">
                        You have unsaved changes in the admin settings.<br><br>
                        <strong>Do you want to save changes before exiting?</strong><br><br>
                        Changes detected:<br>
                        ${playerNamesChanged ? 'â¢ Player list<br>' : ''}
                        ${maxPlayersChanged ? 'â¢ Maximum players<br>' : ''}
                        ${cardsPerPlayerChanged ? 'â¢ Cards per player<br>' : ''}
                        ${passwordChanged ? 'â¢ Player password<br>' : ''}
                    </div>
                    <div class="confirmation-buttons">
                        <button class="btn btn-secondary" id="exitWithoutSaveBtn">
                            <i class="fas fa-times"></i> Exit Without Saving
                        </button>
                        <button class="btn btn-primary" id="saveAndExitBtn">
                            <i class="fas fa-save"></i> Save & Exit
                        </button>
                    </div>
                `;
                
                dialog.appendChild(content);
                document.body.appendChild(dialog);
                
                // Add event listeners
                document.getElementById('exitWithoutSaveBtn').addEventListener('click', function() {
                    document.body.removeChild(dialog);
                    showScreen('loginScreen');
                    // Clear admin fields
                    const playerNameInput = document.getElementById('playerName');
                    const playerPasswordInput = document.getElementById('playerPassword');
                    if (playerNameInput) playerNameInput.value = '';
                    if (playerPasswordInput) playerPasswordInput.value = '';
                });
                
                document.getElementById('saveAndExitBtn').addEventListener('click', function() {
                    document.body.removeChild(dialog);
                    // Save settings first
                    saveAdminSettings();
                    // Then exit
                    showScreen('loginScreen');
                    // Clear admin fields
                    const playerNameInput = document.getElementById('playerName');
                    const playerPasswordInput = document.getElementById('playerPassword');
                    if (playerNameInput) playerNameInput.value = '';
                    if (playerPasswordInput) playerPasswordInput.value = '';
                });
            } else {
                // No changes, just exit
                showScreen('loginScreen');
                // Clear admin fields
                const playerNameInput = document.getElementById('playerName');
                const playerPasswordInput = document.getElementById('playerPassword');
                if (playerNameInput) playerNameInput.value = '';
                if (playerPasswordInput) playerPasswordInput.value = '';
            }
        }
        
        function confirmClearPlayerData() {
            // Create confirmation dialog
            const dialog = document.createElement('div');
            dialog.className = 'confirmation-dialog';
            dialog.style.display = 'flex';
            
            const content = document.createElement('div');
            content.className = 'confirmation-content';
            
            content.innerHTML = `
                <h3><i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Confirm Action</h3>
                <div style="text-align: left; line-height: 1.6;">
                    <strong>Warning: This action cannot be undone!</strong><br><br>
                    This will:<br>
                    â¢ Clear all player cards<br>
                    â¢ Remove all Lucky 4D numbers<br>
                    â¢ Reset all player progress<br><br>
                    Authorized player list will be preserved.<br>
                    Are you sure you want to continue?
                </div>
                <div class="confirmation-buttons">
                    <button class="btn btn-secondary" id="cancelClearBtn">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn btn-danger" id="confirmClearBtn">
                        <i class="fas fa-trash-alt"></i> Clear All Data
                    </button>
                </div>
            `;
            
            dialog.appendChild(content);
            document.body.appendChild(dialog);
            
            // Add event listeners
            document.getElementById('cancelClearBtn').addEventListener('click', function() {
                document.body.removeChild(dialog);
            });
            
            document.getElementById('confirmClearBtn').addEventListener('click', function() {
                document.body.removeChild(dialog);
                clearAllPlayerData();
            });
        }
        
        function showPrevCard() {
            if (gameState.currentCardIndex > 0) {
                gameState.currentCardIndex--;
                updateCardDisplay();
            }
        }
        
        function showNextCard() {
            if (gameState.currentPlayer && 
                gameState.currentCardIndex < gameState.currentPlayer.cards.length - 1) {
                gameState.currentCardIndex++;
                updateCardDisplay();
            }
        }
        
        // ==================== INITIALIZATION ====================
        
        function initGame() {
            // Load settings from centralized storage
            loadMasterSettings();
            
            // Update UI
            updatePlayersCount();
            
            // Setup event listeners
            setupEventListeners();
            
            // Apply customizations
            applyCustomizations();
            
            // Initialize Firebase (if config exists)
            const savedConfig = localStorage.getItem('firebaseConfig');
            if (savedConfig) {
                try {
                    JSON.parse(savedConfig);
                    initializeFirebase();
                } catch (e) {
                    console.error('Invalid Firebase config, skipping initialization');
                }
            }
            
            // Show login screen
            showScreen('loginScreen');
        }
        
        // Start the game when page loads
        window.addEventListener('DOMContentLoaded', initGame);
        
    </script>
</body>
</html>
